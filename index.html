<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Meta 报告</title>
<link rel="icon" type="image/png" href="favicon.png">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #f6efe8;
  --panel: #ffffff;
  --panel-2: #fff6ee;
  --text: #2a231d;
  --muted: #8b7c6d;
  --accent: #c76a1f;
  --accent-2: #1f7a7a;
  --line: #eadfce;
  --good: #0b8f5a;
  --bad: #b3261e;
}
* { box-sizing: border-box; }
body { margin:0; font-family: 'Manrope', sans-serif; background: radial-gradient(1200px 600px at 10% -10%, #fff7ef 0%, #f6efe8 45%, #f3e9df 100%); color: var(--text); }
.container { max-width: 1180px; margin: 28px auto 60px; padding: 0 18px; }
.header { display:flex; align-items:flex-end; justify-content:space-between; gap:16px; }
.title { font-size: 30px; font-weight: 800; letter-spacing: .2px; line-height: 1.05; }
.title .line { display:block; }
.subtitle { color: var(--muted); font-size: 13px; margin-top:4px; }
.filters { background: var(--panel); border:1px solid var(--line); border-radius: 16px; padding: 12px 14px; display:flex; flex-wrap:wrap; gap:10px; align-items:center; box-shadow: 0 6px 18px rgba(0,0,0,0.06); }
.filters-row { display:flex; gap:10px; flex-wrap:wrap; }
.filters.week-inline #timeRow { gap:8px; }
#dimRow { flex-wrap:nowrap; }
.filter-group { display:flex; gap:8px; align-items:center; }
select, .pill-btn, input[type="date"] { border:1px solid var(--line); background:#fff; color:var(--text); padding:7px 10px; border-radius: 10px; font-size: 12px; }
.pill-btn.active { background: var(--accent); color:white; border-color: var(--accent); }
.changed-input {
  border-color: #b84a00 !important;
  box-shadow: 0 0 0 3px rgba(184,74,0,0.28) !important;
  background: #ffd9bf !important;
  font-weight: 700;
}
.section { margin-top: 18px; }
.kpi-grid { display:grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
.kpi { background: var(--panel); border:1px solid var(--line); border-radius: 16px; padding: 12px 14px; }
.kpi:hover { border-color:#d9b089; box-shadow: 0 6px 18px rgba(0,0,0,0.08); background:#fffaf5; }
.kpi .label { color: var(--muted); font-size: 12px; }
.kpi .value { font-size: 20px; font-weight: 800; margin-top:4px; }
.kpi .delta { font-size: 12px; margin-top:6px; }
.delta.good { color: var(--good); }
.delta.bad { color: var(--bad); }
.grid-2 { display:grid; grid-template-columns: 2fr 1fr; gap: 12px; }
.panel { background: var(--panel); border:1px solid var(--line); border-radius: 16px; padding: 12px 14px; box-shadow: 0 8px 22px rgba(0,0,0,0.06); }
.panel h3 { margin: 0 0 10px 0; font-size: 14px; }
.chart-wrap { height: 320px; }
.table { width:100%; border-collapse: collapse; font-size:12px; }
.table.wide { font-size:11px; }
.pager { display:flex; align-items:center; justify-content:flex-end; gap:8px; margin-top:8px; }
.pager .pill-btn { padding:4px 8px; font-size:11px; }
.pill-btn.sm { padding:4px 8px; font-size:11px; }
.table th, .table td { padding:6px 8px; border-bottom:1px solid var(--line); text-align:right; }
.table th:first-child, .table td:first-child { text-align:left; }
.table-scroll .table th:first-child,
.table-scroll .table td:first-child {
  position: sticky;
  left: 0;
  z-index: 2;
  background: #fff;
}
.table-scroll .table th:first-child {
  z-index: 3;
}
.table-scroll .table td:first-child::after,
.table-scroll .table th:first-child::after {
  content: '';
  position: absolute;
  top: 0;
  right: -1px;
  width: 1px;
  height: 100%;
  background: var(--line);
}
.url-detail-first-resize,
.url-main-first-resize { position: relative; }
.url-detail-first-resize .col-handle,
.url-main-first-resize .col-handle {
  position:absolute; top:0; right:-4px; width:8px; height:100%;
  cursor:col-resize; z-index:6;
}
.url-detail-first-resize::after,
.url-main-first-resize::after {
  content:''; position:absolute; top:6px; right:0; width:1px; height:calc(100% - 12px);
  background:#e6d9c8;
}
.url-detail-first-resize:hover::after,
.url-main-first-resize:hover::after { background:#d0b89f; width:2px; right:-1px; top:0; height:100%; }
#urlTable th:first-child, #urlTable td:first-child { width: 420px; min-width: 420px; max-width: 420px; white-space: normal; overflow-wrap:anywhere; word-break: break-word; }
#urlDetailTable th:first-child, #urlDetailTable td:first-child { width: var(--url-detail-first-col, 420px); min-width: var(--url-detail-first-col, 420px); max-width: var(--url-detail-first-col, 420px); white-space: normal; overflow-wrap:anywhere; }
.table-scroll { width:100%; min-width:0; overflow-x:scroll; overflow-y:hidden; padding-bottom:10px; margin-bottom:2px; }
.table-scroll .table { min-width: 100%; }
.table-scroll.compact .table { min-width: 700px; }
.table-scroll.medium .table { min-width: 1550px; }
.table-scroll.wide .table { min-width: 1450px; }
.table-scroll.daily-wide .table { min-width: 1750px; }
.table-scroll.product-wide .table { min-width: 1780px; }
.weekly-summary-bar { display:grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap:8px; margin: 2px 0 8px; }
.weekly-summary-card { background:#fbf6ef; border:1px solid var(--line); border-radius:10px; padding:8px 10px; min-width:0; transition: background .15s ease, border-color .15s ease, box-shadow .15s ease, transform .15s ease; }
.weekly-summary-card:hover { background:#fffaf3; border-color:#dcc4a6; box-shadow:0 4px 14px rgba(0,0,0,.05); transform: translateY(-1px); }
.weekly-summary-card .k { font-size:11px; color:var(--muted); line-height:1.2; }
.weekly-summary-card .v { font-size:16px; font-weight:700; margin-top:3px; }
.weekly-summary-card .s { font-size:11px; color:var(--muted); margin-top:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.weekly-summary-card .metric-accent { margin-left:6px; font-size:12px; font-weight:700; }
.weekly-summary-card .metric-good { color:#11824b; }
.weekly-summary-card .metric-mid { color:#b56a00; }
.weekly-summary-card .metric-low { color:#c23b2a; }
#weeklyNewAdsTable tr.group-row td { background:#f9f3ea; font-weight:700; cursor:pointer; }
#weeklyNewAdsTable tr.group-row td:first-child { white-space:nowrap; }
#weeklyNewAdsTable tr.group-row .toggle { color:var(--muted); margin-right:6px; }
#weeklyNewAdsTable tr.child-row td:first-child { padding-left:18px; }
.url-prod-detail { background:#fbf7f1; }
.url-prod-detail-wrap { padding:10px 6px; }
.hint-strip {
  background:#f7f7f6;
  border:1px solid #e5e2dc;
  border-left:4px solid #d7c5ae;
  border-radius:10px;
  padding:8px 10px;
  color:#6f6559;
  line-height:1.35;
}
.hint-strip .active-mark { color:#11824b; font-weight:700; }
.url-prod-page-group { margin-bottom:10px; }
.url-prod-page-title { font-size:12px; font-weight:700; margin-bottom:6px; color:#5d4d3c; }
#urlProductPageSection .table-scroll { overflow-x: hidden; }
#urlProductPageSection .table-scroll .table { min-width: 100% !important; }
.url-prod-cards { display:flex; flex-wrap:wrap; gap:8px; align-items:flex-start; }
.url-prod-card { border:1px solid var(--line); border-radius:10px; background:#fff; padding:8px; display:flex; gap:8px; align-items:flex-start; width:300px; min-width:0; cursor:pointer; transition: border-color .15s ease, box-shadow .15s ease, background .15s ease; }
.url-prod-card:hover { border-color:#dcc4a6; background:#fffaf3; box-shadow:0 3px 10px rgba(0,0,0,.04); }
.url-prod-card.is-open { border-color:#cda47f; background:#fff8ef; }
.url-prod-card img { width:46px; height:46px; object-fit:cover; border-radius:8px; border:1px solid var(--line); background:#faf7f2; flex:none; cursor:zoom-in; }
.url-prod-card .meta { min-width:0; }
.url-prod-card .sid { font-size:12px; font-weight:700; line-height:1.2; word-break:break-all; }
.url-prod-card .sub { font-size:11px; color:var(--muted); line-height:1.25; margin-top:2px; word-break:break-all; }
.url-prod-card .ads { display:none; margin-top:6px; font-size:11px; color:#5d4d3c; line-height:1.25; max-height:120px; overflow:auto; padding-top:5px; border-top:1px dashed var(--line); }
.url-prod-card.is-open .ads { display:block; }
.url-prod-card .ads div { margin-bottom:4px; word-break:break-all; }
.url-prod-card .ads .ad-no { color: var(--muted); margin-right:4px; }
.url-prod-main-row { cursor: pointer; }
.url-prod-main-row:hover td {
  background:#f9f2e8 !important;
  box-shadow: inset 0 -1px 0 rgba(0,0,0,0.02);
}
.url-prod-main-row:hover td:first-child {
  background:#f7eee3 !important;
}
#weeklyNewAdsTable th:first-child,
#weeklyNewAdsTable td:first-child {
  position: sticky;
  left: 0;
  z-index: 2;
  background: #fff;
  min-width: var(--weekly-newads-camp-col, 480px);
  width: var(--weekly-newads-camp-col, 480px);
  max-width: var(--weekly-newads-camp-col, 480px);
}
#weeklyNewAdsTable th:first-child { z-index: 3; }
#weeklyNewAdsTable td:first-child {
  white-space: normal;
  overflow-wrap: anywhere;
  line-height: 1.35;
}
#weeklyNewAdsTable .resize-col { position: relative; }
#weeklyNewAdsTable .resize-col .col-handle {
  position: absolute;
  top: 0;
  right: -1px;
  width: 4px;
  height: 100%;
  cursor: col-resize;
  z-index: 6;
}
#weeklyNewAdsTable .resize-col::after {
  content: '';
  position: absolute;
  top: 0;
  right: 0;
  width: 1px;
  height: 100%;
  background: #e6d9c8;
}
#weeklyNewAdsTable .resize-col:hover::after { background: #d0b89f; width: 2px; right: -1px; top:0; height:100%; }
.table-scroll::-webkit-scrollbar { height: 8px; }
.table-scroll::-webkit-scrollbar-track { background: #f4ece2; border-radius: 8px; }
.table-scroll::-webkit-scrollbar-thumb { background: #d9c9b6; border-radius: 8px; }
.table-scroll::-webkit-scrollbar-thumb:hover { background: #cdb59d; }
.badge { display:inline-block; padding:2px 8px; background: var(--panel-2); border:1px solid var(--line); border-radius: 999px; font-size:11px; color: var(--muted); }
.hidden { display:none !important; }
.grid-3 { display:grid; grid-template-columns: repeat(3, 1fr); gap:12px; align-items: stretch; }
.grid-4 { display:grid; grid-template-columns: repeat(4, 1fr); gap:12px; align-items: stretch; }
.grid-3 > .panel, .grid-4 > .panel { min-width: 0; }
.triple-metrics .panel { padding-bottom: 10px; display:flex; flex-direction:column; }
.triple-metrics .panel-head { min-height: 34px; }
.triple-metrics .table-scroll { margin-top: 12px; padding-bottom: 12px; min-height: 250px; height: auto; overflow-y: visible; }
.triple-metrics .table-scroll .table th, .triple-metrics .table-scroll .table td { padding: 5px 5px; white-space: nowrap; }
.triple-metrics .table-scroll .table th:nth-child(1), .triple-metrics .table-scroll .table td:nth-child(1) { min-width: 84px; }
.triple-metrics .table-scroll .table th:nth-child(2), .triple-metrics .table-scroll .table td:nth-child(2) { min-width: 84px; }
.triple-metrics .table-scroll .table th:nth-child(3), .triple-metrics .table-scroll .table td:nth-child(3) { min-width: 88px; }
.triple-metrics .table-scroll .table th:nth-child(4), .triple-metrics .table-scroll .table td:nth-child(4) { min-width: 62px; }
.triple-metrics .table-scroll .table th:nth-child(n+5), .triple-metrics .table-scroll .table td:nth-child(n+5) { min-width: 88px; }
.triple-metrics.compare-mode .panel { min-height: 380px; }
#productTable th:nth-child(9), #productTable td:nth-child(9) { min-width: 84px; width: 84px; }
#productTable th:nth-child(10), #productTable td:nth-child(10) { min-width: 84px; width: 84px; }
.span-2 { grid-column: span 2; }
.chart-sm { height:220px; }
.panel { display:flex; flex-direction:column; }
.panel table { width:100%; }
.small { font-size: 11px; color: var(--muted); }
.summary-box { background: #fff1e6; border:1px solid #ffd7b8; padding:10px; border-radius: 12px; font-size:12px; line-height:1.5; }
.summary-box .warn { color: #b3261e; font-weight: 700; }
.summary-box .ok { color: #0b8f5a; font-weight: 700; }
.footer-note { margin-top:10px; font-size:11px; color: var(--muted); }
.crown { margin-left:6px; font-size:12px; }
.roas-top { color: #b3261e; font-weight: 700; }
.muted { color: var(--muted); }
.compare { font-size:11px; color: var(--muted); margin-left:6px; }
.delta-up { color: #0b8f5a; font-weight: 700; display:inline-flex; align-items:center; gap:4px; }
.delta-down { color: #b3261e; font-weight: 700; display:inline-flex; align-items:center; gap:4px; }
.compare-right { display:inline-flex; justify-content:flex-end; align-items:center; gap:6px; float:right; white-space:nowrap; }
.compare-line { display:block; margin-top:2px; font-size:11px; color: var(--muted); }
.compare-line.delta-up { color: #0b8f5a; font-weight: 700; }
.compare-line.delta-down { color: #b3261e; font-weight: 700; }
.url-link { color:#2b5d9a; cursor:pointer; text-decoration:underline; }
.url-tag { display:inline-block; padding:2px 8px; border-radius:999px; font-size:11px; border:1px solid var(--line); }
.url-tag.winner { background:#e7f7ef; color:#0b8f5a; border-color:#bfe9d1; }
.url-tag.loser { background:#fdecec; color:#b3261e; border-color:#f5c7c3; }
.roas-lv-5 { color:#0f7a3d; font-weight:700; }
.roas-lv-4 { color:#2f9e5f; font-weight:700; }
.roas-lv-3 { color:#9c7a00; font-weight:700; }
.roas-lv-2 { color:#b85d12; font-weight:700; }
.roas-lv-1 { color:#b3261e; font-weight:700; }
.panel-head { display:flex; align-items:center; justify-content:space-between; gap:10px; }
.product-thumb { width:64px; height:64px; object-fit:cover; border-radius:10px; border:1px solid var(--line); background:#fff; cursor:zoom-in; }
.table th.sortable { cursor:pointer; }
.table th.sortable .sort-ind { margin-left:6px; font-size:10px; color: var(--muted); }
.table-tools { display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; margin-bottom:8px; }
.table-tools .filter-group { gap:6px; }
#productFilterGroup { display:flex; flex-wrap:wrap; align-items:center; justify-content:flex-end; gap:8px 10px; }
#productFilterGroup .badge { min-width:44px; text-align:center; }
#productCategory { min-width:96px; }
#productCompare { min-width:108px; }
#productPageSize { min-width:74px; }
#productSearch { width:180px; }
#productSearchClear { min-width:52px; height:30px; padding:0 10px; line-height:28px; }
#urlFilterGroup { display:flex; flex-wrap:wrap; align-items:center; justify-content:flex-end; gap:8px 10px; padding:6px 8px; border:1px solid var(--line); border-radius:12px; background:#fcf8f3; }
#urlFilterGroup .badge { min-width:44px; text-align:center; }
#urlProdFilterGroup { display:flex; flex-wrap:wrap; align-items:center; justify-content:flex-end; gap:8px 10px; padding:6px 8px; border:1px solid var(--line); border-radius:12px; background:#fcf8f3; }
#urlProdFilterGroup .badge { min-width:44px; text-align:center; }
#urlTagFilter { min-width:96px; }
#urlCompare { min-width:108px; }
#urlSearch { width:180px; }
#urlSearchClear { min-width:52px; height:30px; padding:0 10px; line-height:28px; }
.table-tools h3 { margin:0; }
#productFilterGroup { padding:6px 8px; border:1px solid var(--line); border-radius:12px; background:#fcf8f3; }
.metric-stack { display:flex; flex-direction:column; align-items:flex-end; gap:2px; line-height:1.1; }
.metric-stack .base { white-space:nowrap; }
.metric-stack .sub { font-size:11px; white-space:nowrap; }
#productPager { justify-content:flex-end; gap:10px; }
#productPager .filter-group { gap:8px; }
.img-modal { position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:999; }
.img-modal.active { display:flex; }
.img-modal .backdrop { position:absolute; inset:0; background:rgba(0,0,0,0.65); }
.img-modal img { position:relative; max-width:90vw; max-height:90vh; border-radius:12px; box-shadow:0 12px 40px rgba(0,0,0,0.35); background:#fff; }
.view-switch { display:flex; gap:10px; align-items:center; }
.view-switch .pill-btn { padding:8px 14px; font-weight:700; }
.view-switch .spacer { flex:1; }
.decision-embed { width:100%; min-height:1500px; border:0; display:block; background:#fff; border-radius:12px; }
.decision-native-root .decision-grid { display:grid; gap:14px; }
.decision-native-root .decision-grid.cols-2 { grid-template-columns: 1.15fr 1fr; }
.decision-native-root .decision-grid.cols-3 { grid-template-columns: repeat(3, 1fr); }
.decision-native-root .decision-grid.cols-1 { grid-template-columns: 1fr; }
.decision-native-root .decision-grid > * { min-width: 0; }
.decision-native-root .decision-kpis { display:grid; grid-template-columns: repeat(4, 1fr); gap:12px; }
.decision-native-root .decision-kpi { border:1px solid var(--line); background:#fff; border-radius:12px; padding:12px; }
.decision-native-root .decision-kpi.clickable { cursor:pointer; transition:.15s ease; }
.decision-native-root .decision-kpi.clickable:hover { border-color:#d9b089; box-shadow:0 4px 14px rgba(42,35,29,.06); transform:translateY(-1px); }
.decision-native-root .decision-kpi.active { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(199,106,31,.12) inset; background:#fff8f1; }
.decision-native-root .decision-kpi .k { color:var(--muted); font-size:12px; }
.decision-native-root .decision-kpi .v { font-size:24px; font-weight:800; margin-top:4px; }
.decision-native-root .decision-kpi .hint { margin-top:4px; font-size:11px; color:var(--muted); }
.decision-native-root .decision-head { display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:8px; flex-wrap:wrap; }
.decision-native-root .decision-sub { color:var(--muted); font-size:12px; }
.decision-native-root #decisionUpToDate { display:inline-flex; align-items:center; padding:3px 8px; border-radius:999px; background:#fff; border:1px solid var(--line); color:#2f271f; font-weight:700; }
.decision-native-root #decisionAdGlobalHint { max-width: 520px; }
.decision-native-root .decision-ad-toggle-row { margin-top:8px; }
.decision-native-root .decision-ad-toggle-row .filter-group { width:100%; justify-content:flex-start; }
.decision-native-root .decision-chip { display:inline-flex; align-items:center; border-radius:999px; padding:2px 8px; font-size:11px; font-weight:700; border:1px solid var(--line); background:#fbf7f1; }
.decision-native-root .tag-scale { color:#0b8f5a; border-color:#bce5d1; background:#eefaf4; }
.decision-native-root .tag-pause { color:#b3261e; border-color:#f2c3bf; background:#fff1ef; }
.decision-native-root .tag-watch { color:#9b5f00; border-color:#ecd6aa; background:#fff8e8; }
.decision-native-root .tag-opt { color:#1f5ea8; border-color:#bfd6f1; background:#eef5ff; }
.decision-native-root .priority-highest { color:#b3261e; font-weight:800; }
.decision-native-root .priority-high { color:#c76a1f; font-weight:800; }
.decision-native-root .decision-list { margin:0; padding-left:18px; }
.decision-native-root .decision-list li { margin:6px 0; }
.decision-native-root .decision-list li,
.decision-native-root .decision-list b,
.decision-native-root .decision-sub,
.decision-native-root .decision-subline {
  overflow-wrap:anywhere;
  word-break:break-word;
}
.decision-native-root .panel { min-width:0; }
.decision-native-root .table-scroll { margin-top:8px; }
.decision-native-root .decision-title-wrap { display:flex; flex-direction:column; min-width:0; }
.decision-native-root .decision-title-wrap h3 { margin:0; }
.decision-native-root .decision-title-wrap .decision-subline { color:var(--muted); font-size:12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:520px; }
.decision-native-root .decision-panel { overflow:hidden; }
.decision-native-root .decision-table-scroll { overflow-x:auto; padding-bottom:8px; margin-top:8px; }
.decision-native-root .decision-table-scroll::-webkit-scrollbar { height:8px; }
.decision-native-root .decision-table-scroll::-webkit-scrollbar-thumb { background:#d8cab7; border-radius:999px; }
.decision-native-root .decision-table-scroll::-webkit-scrollbar-track { background:#f3ece2; border-radius:999px; }
.decision-native-root .decision-table { min-width:1500px; }
.decision-native-root .decision-table.ad-table { min-width:1400px; }
.decision-native-root .decision-table { min-width:1820px; }
.decision-native-root .decision-table.ad-table { min-width:1780px; }
.decision-native-root .decision-table.compact-cols { min-width: 1320px; }
.decision-native-root .decision-table.ad-table.compact-cols { min-width: 1400px; }
.decision-native-root .decision-table th,
.decision-native-root .decision-table td { padding: 9px 10px; line-height: 1.35; vertical-align: middle; }
.decision-native-root .decision-table th { white-space: nowrap; }
.decision-native-root #decisionCampTable td:not(:first-child):not(:nth-child(4)):not(:nth-child(8)),
.decision-native-root #decisionAdTable td:not(:first-child):not(:nth-child(4)):not(:nth-child(8)) { white-space: nowrap; }
.decision-native-root #decisionCampTable th:nth-child(2), .decision-native-root #decisionCampTable td:nth-child(2),
.decision-native-root #decisionAdTable th:nth-child(2), .decision-native-root #decisionAdTable td:nth-child(2) { min-width: 92px; width:92px; text-align:center; }
.decision-native-root #decisionCampTable th:nth-child(3), .decision-native-root #decisionCampTable td:nth-child(3),
.decision-native-root #decisionAdTable th:nth-child(3), .decision-native-root #decisionAdTable td:nth-child(3) { min-width: 112px; width:112px; text-align:center; }
.decision-native-root #decisionCampTable th:nth-child(4), .decision-native-root #decisionCampTable td:nth-child(4),
.decision-native-root #decisionAdTable th:nth-child(4), .decision-native-root #decisionAdTable td:nth-child(4) { min-width: 152px; width: 152px; max-width: 176px; text-align:center; }
.decision-native-root #decisionCampTable td:nth-child(4),
.decision-native-root #decisionAdTable td:nth-child(4) { white-space: normal; line-height:1.25; }
.decision-native-root #decisionCampTable th:nth-child(5), .decision-native-root #decisionCampTable td:nth-child(5),
.decision-native-root #decisionAdTable th:nth-child(5), .decision-native-root #decisionAdTable td:nth-child(5) { min-width: 104px; width:104px; text-align:center !important; }
.decision-native-root #decisionCampTable th:nth-child(6), .decision-native-root #decisionCampTable td:nth-child(6),
.decision-native-root #decisionAdTable th:nth-child(6), .decision-native-root #decisionAdTable td:nth-child(6) { min-width: 76px; width:76px; text-align:center !important; }
.decision-native-root #decisionCampTable th:nth-child(7), .decision-native-root #decisionCampTable td:nth-child(7),
.decision-native-root #decisionAdTable th:nth-child(7), .decision-native-root #decisionAdTable td:nth-child(7) { min-width: 124px; width:124px; text-align:center; }
.decision-native-root #decisionCampTable th:nth-child(8), .decision-native-root #decisionCampTable td:nth-child(8),
.decision-native-root #decisionAdTable th:nth-child(8), .decision-native-root #decisionAdTable td:nth-child(8) { min-width: 140px; width: 140px; text-align:left; }
.decision-native-root #decisionCampTable.compact-cols th:nth-child(8), .decision-native-root #decisionCampTable.compact-cols td:nth-child(8),
.decision-native-root #decisionAdTable.compact-cols th:nth-child(8), .decision-native-root #decisionAdTable.compact-cols td:nth-child(8) { min-width: 110px; width: 110px; }
.decision-native-root #decisionCampTable.reason-open th:nth-child(8), .decision-native-root #decisionCampTable.reason-open td:nth-child(8),
.decision-native-root #decisionAdTable.reason-open th:nth-child(8), .decision-native-root #decisionAdTable.reason-open td:nth-child(8) { min-width: 360px; width: 360px; }
.decision-native-root #decisionCampTable.compact-cols.reason-open th:nth-child(8), .decision-native-root #decisionCampTable.compact-cols.reason-open td:nth-child(8),
.decision-native-root #decisionAdTable.compact-cols.reason-open th:nth-child(8), .decision-native-root #decisionAdTable.compact-cols.reason-open td:nth-child(8) { min-width: 300px; width: 300px; }
.decision-native-root #decisionCampTable th:nth-child(n+9), .decision-native-root #decisionCampTable td:nth-child(n+9),
.decision-native-root #decisionAdTable th:nth-child(n+9), .decision-native-root #decisionAdTable td:nth-child(n+9) { min-width: 88px; }
.decision-native-root #decisionCampTable th:first-child, .decision-native-root #decisionCampTable td:first-child,
.decision-native-root #decisionAdTable th:first-child, .decision-native-root #decisionAdTable td:first-child { box-shadow: 1px 0 0 #eee2d2; }
.decision-native-root .decision-table th.sortable { cursor:pointer; user-select:none; }
.decision-native-root .decision-table th.sortable .sort-ind { margin-left:4px; font-size:10px; color:var(--muted); }
.decision-native-root .decision-table th.help-tip { position: relative; }
.decision-native-root .decision-table th.help-tip:hover::after {
  content: attr(data-tip);
  position: absolute;
  left: 0;
  top: calc(100% + 6px);
  z-index: 30;
  width: 220px;
  white-space: normal;
  line-height: 1.35;
  font-weight: 500;
  color: #fff;
  background: rgba(44, 38, 33, 0.84);
  border-radius: 8px;
  padding: 8px 10px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.15);
}
.decision-native-root .decision-table th.help-tip:last-child:hover::after,
.decision-native-root .decision-table th.help-tip[data-sort="purchases"]:hover::after,
.decision-native-root .decision-table th.help-tip[data-sort="wroas"]:hover::after {
  left:auto;
  right:0;
}
.decision-native-root .pri-chip, .decision-native-root .conf-chip { display:inline-flex; align-items:center; justify-content:center; min-width:28px; padding:2px 8px; border-radius:999px; font-size:11px; font-weight:800; border:1px solid transparent; }
.decision-native-root .pri-highest { color:#b3261e; background:#fff1ef; border-color:#f2c3bf; }
.decision-native-root .pri-high { color:#c76a1f; background:#fff6e8; border-color:#ecd6aa; }
.decision-native-root .pri-mid { color:#7a6d60; background:#f4efe8; border-color:#e4d8c8; }
.decision-native-root .conf-high { color:#0b8f5a; background:#eefaf4; border-color:#bce5d1; }
.decision-native-root .conf-mid { color:#c76a1f; background:#fff6e8; border-color:#ecd6aa; }
.decision-native-root .conf-low { color:#b3261e; background:#fff1ef; border-color:#f2c3bf; }
.decision-native-root details.reason { max-width: none; }
.decision-native-root details.reason summary { cursor:pointer; color:var(--muted); display:inline-flex; align-items:center; gap:4px; white-space:nowrap; font-size:12px; }
.decision-native-root details.reason summary .when-open { display:none; }
.decision-native-root details.reason[open] summary .when-open { display:inline; }
.decision-native-root details.reason[open] summary .when-closed { display:none; }
.decision-native-root details.reason summary::-webkit-details-marker { margin-right:2px; }
.decision-native-root details.reason div { color:var(--muted); font-size:12px; margin-top:6px; line-height:1.45; white-space:normal; overflow-wrap:anywhere; max-width:620px; }
.decision-native-root details.reason[open] { display:block; min-width:260px; }
.decision-native-root .ad-cell-wrap { display:flex; flex-direction:column; gap:2px; }
.decision-native-root .ad-cell-wrap .ad-main { color:#2f271f; }
.decision-native-root .ad-cell-wrap .ad-camp { color:var(--muted); font-size:11px; line-height:1.25; white-space:normal; overflow-wrap:anywhere; }
.decision-native-root { --decision-camp-first-col: 360px; --decision-ad-first-col: 460px; }
.decision-native-root #decisionCampTable th:first-child,
.decision-native-root #decisionCampTable td:first-child {
  position: sticky; left: 0; z-index: 2; background: #fff;
  min-width: var(--decision-camp-first-col); width: var(--decision-camp-first-col); max-width: var(--decision-camp-first-col);
}
.decision-native-root #decisionCampTable th:first-child { z-index: 3; }
.decision-native-root #decisionAdTable th:first-child,
.decision-native-root #decisionAdTable td:first-child {
  position: sticky; left: 0; z-index: 2; background: #fff;
  min-width: var(--decision-ad-first-col); width: var(--decision-ad-first-col); max-width: var(--decision-ad-first-col);
}
.decision-native-root #decisionAdTable th:first-child { z-index: 3; }
.decision-native-root #decisionCampTable th:first-child,
.decision-native-root #decisionCampTable td:first-child,
.decision-native-root #decisionAdTable th:first-child,
.decision-native-root #decisionAdTable td:first-child {
  white-space: normal;
  overflow-wrap:anywhere;
  word-break:break-word;
  line-height:1.3;
}
.decision-native-root .resize-col { position:relative; }
.decision-native-root .resize-col .col-handle { position:absolute; top:0; right:-4px; width:8px; height:100%; cursor:col-resize; z-index:6; }
.decision-native-root .resize-col::after { content:''; position:absolute; top:6px; right:0; width:1px; height:calc(100% - 12px); background:#e6d9c8; }
.decision-native-root .decision-pager { display:flex; justify-content:flex-end; align-items:center; gap:8px; margin-top:8px; }
.decision-native-root .decision-pager .small { color:var(--muted); font-size:12px; }
.decision-native-root .decision-rules-grid { display:grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap:8px; }
.decision-native-root .decision-rule-card { border:1px solid var(--line); border-radius:10px; background:#fcfaf6; padding:8px 10px; min-width:0; }
.decision-native-root .decision-rule-card .rule-title { font-size:11px; font-weight:800; color:#2f271f; }
.decision-native-root .decision-rule-card .rule-text { margin-top:3px; font-size:11px; color:var(--muted); line-height:1.35; }
.decision-native-root .decision-date-strong { color:#b3261e; font-weight:800; }
.decision-native-root .decision-ad-controls { display:flex; align-items:center; gap:8px; flex-wrap:wrap; margin-top:6px; }
.decision-native-root .decision-ad-controls .small { color:var(--muted); }
.decision-native-root .decision-todo-board { display:none; }
.decision-native-root .decision-todo-grid { display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:10px; }
.decision-native-root .decision-todo-card { border:1px solid var(--line); background:#fcfaf6; border-radius:12px; padding:10px 12px; min-width:0; }
.decision-native-root .decision-todo-card .todo-title { font-size:13px; font-weight:700; margin-bottom:6px; }
.decision-native-root .decision-todo-card .todo-item { padding:6px 0; border-top:1px dashed #e9ddcf; }
.decision-native-root .decision-todo-card .todo-item:first-of-type { border-top:0; padding-top:0; }
.decision-native-root .decision-todo-card .todo-main { font-size:12px; font-weight:600; color:#2f271f; line-height:1.3; overflow-wrap:anywhere; }
.decision-native-root .decision-todo-card .todo-meta { margin-top:3px; font-size:11px; color:var(--muted); display:flex; flex-wrap:wrap; align-items:center; gap:6px; }
.decision-native-root .decision-todo-card .todo-empty { font-size:12px; color:var(--muted); }
.decision-native-root .decision-todo-compact { display:grid; gap:10px; }
.decision-native-root .todo-ribbon { display:flex; flex-wrap:wrap; gap:8px; }
.decision-native-root .todo-pill { display:inline-flex; align-items:center; gap:8px; border:1px solid var(--line); border-radius:999px; background:#fff; padding:5px 10px; font-size:12px; color:var(--muted); }
.decision-native-root .todo-pill b { color:#2f271f; font-size:13px; }
.decision-native-root .todo-grid-tight { display:grid; grid-template-columns: 1.2fr 1fr; gap:10px; }
.decision-native-root .todo-panel-lite { border:1px solid var(--line); border-radius:12px; background:#fff; padding:10px; min-width:0; }
.decision-native-root .todo-panel-title { font-size:13px; font-weight:700; margin-bottom:8px; }
.decision-native-root .todo-queue-row { display:grid; grid-template-columns: 48px 42px minmax(0,1fr) 42px; gap:8px; align-items:start; padding:6px 0; border-top:1px dashed #ece1d4; }
.decision-native-root .todo-queue-row:first-of-type { border-top:0; padding-top:0; }
.decision-native-root .todo-queue-row.empty { opacity:.85; }
.decision-native-root .todo-queue-name { font-size:12px; color:#6f6356; font-weight:700; }
.decision-native-root .todo-queue-count { font-weight:800; font-size:14px; }
.decision-native-root .todo-queue-items { display:flex; flex-direction:column; gap:4px; min-width:0; }
.decision-native-root .todo-queue-more { font-size:11px; color:var(--muted); text-align:right; }
.decision-native-root .todo-link { all:unset; display:block; cursor:pointer; color:#2f271f; font-size:12px; line-height:1.25; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
.decision-native-root .todo-link:hover { color:var(--accent); text-decoration:underline; }
.decision-native-root .todo-muted { font-size:12px; color:var(--muted); }
.decision-native-root .todo-highlight-list { display:grid; gap:8px; }
.decision-native-root .todo-highlight-item { border:1px solid #efe4d7; border-radius:10px; background:#fcfaf7; padding:8px 10px; }
.decision-native-root .todo-highlight-item.warn { background:#fff6f3; border-color:#f0d0ca; }
.decision-native-root .todo-highlight-item.good { background:#f4fbf7; border-color:#cfe8da; }
.decision-native-root .todo-h-k { font-size:11px; color:var(--muted); }
.decision-native-root .todo-h-v { margin-top:2px; font-size:12px; font-weight:700; line-height:1.25; overflow-wrap:anywhere; }
.decision-native-root .todo-h-m { margin-top:2px; font-size:11px; color:var(--muted); }
@media (max-width: 980px) {
  .decision-native-root .decision-kpis { grid-template-columns: repeat(2, 1fr); }
  .decision-native-root .decision-grid.cols-2,
  .decision-native-root .decision-grid.cols-3 { grid-template-columns: 1fr; }
  .decision-native-root .decision-todo-grid { grid-template-columns: 1fr; }
  .decision-native-root .todo-grid-tight { grid-template-columns: 1fr; }
  .decision-native-root .decision-rules-grid { grid-template-columns: 1fr; }
}
.table tr:hover td { background: #fbf4eb; }
.pill-btn:hover, button:hover { filter: brightness(0.98); }
select:hover, input[type="date"]:hover, input[type="text"]:hover { border-color: #d9b089; }
#chartSection .chart-toolbar { margin-bottom: 12px; }
#chartSection #piePanel,
#chartSection #comboPanel { margin-top: 4px; }
#categorySection .panel-head { margin-bottom: 0; }
#categorySection .small { margin: 0 0 6px; }
#chartSection #comboPanel { row-gap: 18px; margin-top: 10px; }
#chartSection #comboPanel .panel { padding-top: 10px; }
#chartSection #comboPanel .panel:not(:last-child) { margin-bottom: 10px; }
@media (max-width: 980px) {
  .kpi-grid { grid-template-columns: repeat(2, 1fr); }
  .grid-2 { grid-template-columns: 1fr; }
  .grid-3, .grid-4 { grid-template-columns: 1fr; }
  #productFilterGroup { justify-content:flex-start; }
  #urlFilterGroup { justify-content:flex-start; }
  #urlProdFilterGroup { justify-content:flex-start; }
  #productSearch { width:150px; }
  #urlSearch { width:150px; }
}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div>
      <div class="title"><span class="line">Meta</span><span class="line">广告看板</span></div>
      <div class="subtitle" id="rangeLabel">数据范围：</div>
    </div>
    <div class="filters">
      <div class="filters-row" id="timeRow">
        <div class="filter-group" id="modeGroup">
          <span class="badge">时间</span>
          <select id="timeMode">
            <option value="week">周度</option>
            <option value="month">月度</option>
            <option value="range">自定义范围</option>
          </select>
        </div>
        <div class="filter-group" id="weekGroup">
          <span class="badge">周度</span>
          <select id="weekSelect"></select>
        </div>
        <div class="filter-group" id="monthGroup">
          <span class="badge">月份</span>
          <select id="monthSelect"></select>
        </div>
        <div class="filter-group" id="dateRangeGroup">
          <span class="badge">日期范围</span>
          <input id="startDate" type="date" />
          <span class="small">至</span>
          <input id="endDate" type="date" />
        </div>
      </div>
      <div class="filters-row" id="dimRow">
        <div class="filter-group">
          <span class="badge">品类</span>
          <select id="categorySelect"></select>
        </div>
        <div class="filter-group">
          <span class="badge">广告类型</span>
          <select id="adTypeSelect"></select>
        </div>
        <div class="filter-group">
          <span class="badge">素材</span>
          <select id="materialSelect"></select>
        </div>
      </div>
      <div class="filter-group" id="dayButtons"></div>
    </div>
  </div>

  <div class="section">
    <div class="view-switch">
      <button class="pill-btn active" id="viewPerfBtn" type="button">投放侧</button>
      <button class="pill-btn" id="viewOpsBtn" type="button">运营侧</button>
      <button class="pill-btn" id="viewDecisionBtn" type="button">决策页</button>
      <span class="spacer"></span>
      <button class="pill-btn" id="resetDashboardBtn" type="button">清除</button>
    </div>
  </div>

  <div class="section kpi-grid" id="kpiGrid"></div>

  <div class="section grid-2" id="trendSection">
    <div class="panel">
      <h3>趋势</h3>
      <div class="chart-wrap"><canvas id="trendChart"></canvas></div>
      <div class="footer-note">月度展示月内每日，周度展示周内每日，当日展示当日 vs 周均。</div>
    </div>
    <div class="panel">
      <h3>简要分析</h3>
      <div id="summaryBox" class="summary-box"></div>
    </div>
  </div>

  <div class="section" id="categorySection">
    <div class="panel">
      <div class="panel-head">
        <h3>品类数据</h3>
        <div class="filter-group">
          <span class="badge">视图</span>
          <select id="categoryMode">
            <option value="category">全部</option>
            <option value="ip">IP细分</option>
          </select>
          <span class="badge" style="margin-left:8px;">环比</span>
          <select id="compareCategory">
            <option value="off">关闭</option>
            <option value="prev">上期</option>
            <option value="delta">环比</option>
            <option value="both">上期+环比</option>
          </select>
        </div>
      </div>
      <div class="small">IP / Matching / Bamboo / Children</div>
      <div class="table-scroll medium"><table class="table" id="categoryTable"></table></div>
    </div>
  </div>

  <div class="section grid-3 triple-metrics" id="tripleMetrics">
    <div class="panel" id="audiencePanel">
      <div class="panel-head">
        <h3>人群类型</h3>
        <div class="filter-group">
          <span class="badge">环比</span>
          <select id="compareAudience">
            <option value="off">关闭</option>
            <option value="prev">上期</option>
            <option value="delta">环比</option>
            <option value="both">上期+环比</option>
          </select>
        </div>
      </div>
      <div class="table-scroll compact"><table class="table" id="audienceTable"></table></div>
    </div>
    <div class="panel" id="materialPanel">
      <div class="panel-head">
        <h3>素材类型</h3>
        <div class="filter-group">
          <span class="badge">环比</span>
          <select id="compareMaterial">
            <option value="off">关闭</option>
            <option value="prev">上期</option>
            <option value="delta">环比</option>
            <option value="both">上期+环比</option>
          </select>
        </div>
      </div>
      <div class="table-scroll compact"><table class="table" id="materialTable"></table></div>
    </div>
    <div class="panel" id="adTypePanel">
      <div class="panel-head">
        <h3>广告类型</h3>
        <div class="filter-group">
          <span class="badge">环比</span>
          <select id="compareAdType">
            <option value="off">关闭</option>
            <option value="prev">上期</option>
            <option value="delta">环比</option>
            <option value="both">上期+环比</option>
          </select>
        </div>
      </div>
      <div class="table-scroll compact"><table class="table" id="adTypeTable"></table></div>
    </div>
  </div>

  <div class="section" id="chartSection">
    <div class="panel">
      <div class="chart-toolbar" style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
        <div class="filter-group">
          <span class="badge">图表类型</span>
          <select id="chartMode">
            <option value="pie">饼图</option>
            <option value="combo">组合图</option>
          </select>
        </div>
        <div class="filter-group" id="pieMetricGroup">
          <span class="badge">视图</span>
          <button class="pill-btn sm active" id="pieSpendBtn">花费</button>
          <button class="pill-btn sm" id="pieConvBtn">转化金额</button>
          <input type="hidden" id="pieMetric" value="spend" />
        </div>
      </div>
      <div id="piePanel" class="grid-3">
        <div class="chart-wrap chart-sm"><canvas id="audiencePie"></canvas></div>
        <div class="chart-wrap chart-sm"><canvas id="materialPie"></canvas></div>
        <div class="chart-wrap chart-sm"><canvas id="adTypePie"></canvas></div>
      </div>
      <div id="comboPanel" class="grid-3" style="display:none;">
        <div class="panel">
          <h3>人群组合图</h3>
          <div class="chart-wrap chart-sm"><canvas id="comboAudience"></canvas></div>
        </div>
        <div class="panel">
          <h3>素材组合图</h3>
          <div class="chart-wrap chart-sm"><canvas id="comboMaterial"></canvas></div>
        </div>
        <div class="panel">
          <h3>广告组合图</h3>
          <div class="chart-wrap chart-sm"><canvas id="comboAdType"></canvas></div>
        </div>
      </div>
    </div>
  </div>

  <div class="section" id="dailySection">
    <div class="panel">
      <h3>每日明细</h3>
      <div class="table-scroll daily-wide"><table class="table wide" id="dailyTable"></table></div>
      <div class="pager" id="dailyPager">
        <div class="filter-group">
          <span class="badge">每页</span>
          <select id="dailyPageSize">
            <option value="10">10</option>
            <option value="15" selected>15</option>
            <option value="30">30</option>
          </select>
        </div>
      </div>
    </div>
  </div>

  <div class="section hidden" id="weeklyNewAdsSection">
    <div class="panel">
      <div class="panel-head">
        <h3>当周新广告</h3>
        <div id="weeklyNewAdsStats" class="small"></div>
      </div>
      <div id="weeklyNewAdsSummaryBar" class="weekly-summary-bar"></div>
      <div class="filter-group" style="margin:8px 0 10px 0; gap:8px; flex-wrap:wrap;">
        <span class="badge">视图</span>
        <select id="weeklyNewAdsViewMode">
          <option value="all">全部新广告</option>
          <option value="sold">仅出单</option>
          <option value="unsold">仅未出单</option>
          <option value="high_roas">高ROAS</option>
        </select>
        <span class="badge">分组</span>
        <select id="weeklyNewAdsGroupMode">
          <option value="none">不分组</option>
          <option value="category">按品类分组</option>
          <option value="adType">按广告类型分组</option>
          <option value="material">按素材类型分组</option>
        </select>
      </div>
      <div class="table-scroll daily-wide"><table class="table wide" id="weeklyNewAdsTable"></table></div>
    </div>
  </div>

  <div class="section" id="productSection">
    <div class="panel">
      <div class="table-tools">
        <h3>商品投放</h3>
        <div class="filter-group" id="productFilterGroup">
          <span class="badge">类目</span>
          <select id="productCategory"></select>
          <span class="badge">对比</span>
          <select id="productCompare">
            <option value="off" selected>关闭</option>
            <option value="delta">环比</option>
            <option value="prev">上期</option>
            <option value="both">上期+环比</option>
          </select>
          <span class="badge">搜索</span>
          <input id="productSearch" type="text" placeholder="商品id / skc / shopify id" />
          <button id="productSearchClear" class="pill-btn sm" type="button">清空</button>
        </div>
      </div>
      <div class="table-scroll product-wide"><table class="table wide" id="productTable"></table></div>
      <div class="pager" id="productPager">
        <div class="filter-group" id="productPageSizeGroup">
          <span class="badge">每页</span>
          <select id="productPageSize">
            <option value="10">10</option>
            <option value="15" selected>15</option>
            <option value="20">20</option>
            <option value="all">全部</option>
          </select>
        </div>
      </div>
    </div>
  </div>

  <div class="section" id="urlSection">
    <div class="panel">
      <div class="table-tools">
        <h3>URL看板</h3>
        <div class="filter-group" id="urlFilterGroup">
          <span class="badge">标签</span>
          <select id="urlTagFilter">
            <option value="all">全部</option>
            <option value="winner">爆款</option>
            <option value="loser">亏损</option>
          </select>
          <span class="badge">对比</span>
          <select id="urlCompare">
            <option value="off" selected>关闭</option>
            <option value="delta">环比</option>
            <option value="prev">上期</option>
            <option value="both">上期+环比</option>
          </select>
          <span class="badge">搜索</span>
          <input id="urlSearch" type="text" placeholder="输入URL关键词" />
          <button id="urlSearchClear" class="pill-btn sm" type="button">清空</button>
        </div>
      </div>
      <div class="table-scroll wide"><table class="table wide" id="urlTable"></table></div>
      <div class="pager" id="urlPager">
        <div class="filter-group" id="urlPageSizeGroup">
          <span class="badge">每页</span>
          <select id="urlPageSize">
            <option value="10">10</option>
            <option value="15" selected>15</option>
            <option value="30">30</option>
            <option value="all">全部</option>
          </select>
        </div>
      </div>
      <div id="urlDetailPanel" class="hidden" style="margin-top:10px;">
        <div class="panel-head">
          <h3 id="urlDetailTitle">广告明细</h3>
          <button id="urlDetailBack" class="pill-btn sm" type="button">折叠</button>
        </div>
        <div class="table-scroll wide"><table class="table wide" id="urlDetailTable"></table></div>
        <div class="pager" id="urlDetailPager">
          <div class="filter-group" id="urlDetailPageSizeGroup">
            <span class="badge">每页</span>
            <select id="urlDetailPageSize">
              <option value="10" selected>10</option>
              <option value="15">15</option>
              <option value="30">30</option>
              <option value="all">全部</option>
            </select>
          </div>
        </div>
      </div>
      <div id="urlProductDetailPanel" class="hidden" style="margin-top:10px;">
        <div class="panel-head">
          <h3 id="urlProductDetailTitle">商品明细</h3>
          <button id="urlProductDetailBack" class="pill-btn sm" type="button">折叠</button>
        </div>
        <div class="table-scroll wide"><table class="table wide" id="urlProductDetailTable"></table></div>
        <div class="pager" id="urlProductDetailPager">
          <div class="filter-group" id="urlProductDetailPageSizeGroup">
            <span class="badge">每页</span>
            <select id="urlProductDetailPageSize">
              <option value="10" selected>10</option>
              <option value="15">15</option>
              <option value="30">30</option>
              <option value="all">全部</option>
            </select>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="section" id="urlProductPageSection">
    <div class="panel">
      <div class="table-tools">
        <h3>广告商品页码</h3>
        <div class="filter-group" id="urlProdFilterGroup">
          <span class="badge">页码</span>
          <select id="urlProdPageFilter"><option value="all">全部</option></select>
          <button id="urlProdExpandAllBtn" class="pill-btn sm" type="button">全部展开</button>
          <span class="badge">搜索</span>
          <input id="urlProdSearch" type="text" placeholder="ad / shopify id / skc / url" />
          <button id="urlProdSearchClear" class="pill-btn sm" type="button">清空</button>
        </div>
      </div>
      <div id="urlProdMeta" class="hint-strip small" style="margin:2px 0 8px 0;"></div>
      <div class="table-scroll wide"><table class="table wide" id="urlProdTable"></table></div>
      <div class="pager" id="urlProdPager">
        <div class="filter-group" id="urlProdPageSizeGroup">
          <span class="badge">每页</span>
          <select id="urlProdPageSize">
            <option value="10">10</option>
            <option value="15" selected>15</option>
            <option value="30">30</option>
            <option value="all">全部</option>
          </select>
        </div>
      </div>
    </div>
  </div>

  <div class="section hidden" id="decisionSection">
    <div id="decisionNativeRoot" class="decision-native-root">
      <div class="decision-kpis" id="decisionKpis"></div>
      <div class="panel decision-rules-panel" style="margin-top:12px;">
        <div class="decision-head">
          <h3>判定逻辑说明</h3>
          <div class="decision-sub" id="decisionRulesSub">数据截止：-</div>
        </div>
        <div class="decision-rules-grid">
          <div class="decision-rule-card">
            <div class="rule-title">Campaign 暂停</div>
            <div class="rule-text">更偏保守：要求较高花费 + 7/14天持续偏弱 + 订单不足，才进入暂停队列，不因单日波动直接暂停。</div>
          </div>
          <div class="decision-rule-card">
            <div class="rule-title">Campaign 扩量</div>
            <div class="rule-text">当天ROAS + 前3天ROAS + 前7天ROAS加权（综合ROAS）共同判断；且需满足订单样本量与趋势一致性，避免偶发出单误判扩量。</div>
          </div>
          <div class="decision-rule-card">
            <div class="rule-title">置信度</div>
            <div class="rule-text">用于判断信号稳定性：结合当天花费/点击/订单与近7天表现评估。高=信号更稳定；中=可参考但需观察；低=样本不足或波动较大。</div>
          </div>
          <div class="decision-rule-card">
            <div class="rule-title">优先级分值</div>
            <div class="rule-text">用于排序的内部分值（已压缩显示，不是报表金额）。暂停类偏风险，扩量类偏放量潜力。</div>
          </div>
        </div>
      </div>

      <div class="decision-grid cols-1" style="margin-top:12px;">
        <div class="panel decision-panel">
          <div class="decision-head">
            <h3>Campaign 决策</h3>
            <div class="filter-group">
              <span class="badge">广告类型</span>
              <select id="decisionCampTypeFilter">
                <option value="all">全部</option>
                <option value="RT">RT</option>
                <option value="ASC">ASC</option>
                <option value="COLD">COLD</option>
              </select>
              <span class="badge">动作</span>
              <select id="decisionCampFilter">
                <option value="all">全部</option>
                <option value="scale">扩量</option>
                <option value="pause">暂停</option>
                <option value="opt">优化</option>
                <option value="watch">观察</option>
              </select>
              <span class="badge">列模式</span>
              <select id="decisionCampColumnMode">
                <option value="compact" selected>精简</option>
                <option value="full">完整</option>
              </select>
            </div>
          </div>
          <div class="decision-table-scroll"><table class="table decision-table" id="decisionCampTable"></table></div>
          <div class="decision-pager" id="decisionCampPager">
            <div class="filter-group">
              <span class="badge">每页</span>
              <select id="decisionCampPageSize">
                <option value="10" selected>10</option>
                <option value="15">15</option>
                <option value="20">20</option>
              </select>
            </div>
            <span class="small" id="decisionCampPageInfo">第1/1页</span>
            <button class="pill-btn sm" type="button" id="decisionCampPrev">上一页</button>
            <button class="pill-btn sm" type="button" id="decisionCampNext">下一页</button>
          </div>
        </div>
        <div class="decision-ad-controls">
          <button class="pill-btn sm" type="button" id="decisionAdPanelToggle">显示 Ad 决策</button>
          <span class="small" id="decisionAdGlobalHint">默认展示全量 Ad 决策；点 Campaign 行可筛选到单个 Campaign。</span>
        </div>
        <div class="panel decision-panel hidden" id="decisionAdPanel">
          <div class="decision-head">
            <div class="decision-title-wrap">
              <h3 id="decisionAdTitle">Ad 决策</h3>
              <div class="decision-subline" id="decisionAdSubline">点击左侧 Campaign 行查看对应 Ad</div>
            </div>
            <div class="filter-group">
              <span class="badge">视图</span>
              <select id="decisionAdFilter">
                <option value="all">全部</option>
                <option value="loss">优先关闭</option>
                <option value="click">点击弱</option>
                <option value="conv">转化弱</option>
              </select>
              <span class="badge">列模式</span>
              <select id="decisionAdColumnMode">
                <option value="compact" selected>精简</option>
                <option value="full">完整</option>
              </select>
            </div>
          </div>
          <div class="decision-table-scroll"><table class="table decision-table ad-table" id="decisionAdTable"></table></div>
          <div class="decision-pager" id="decisionAdPager">
            <div class="filter-group">
              <span class="badge">每页</span>
              <select id="decisionAdPageSize">
                <option value="10" selected>10</option>
                <option value="15">15</option>
                <option value="20">20</option>
              </select>
            </div>
            <span class="small" id="decisionAdPageInfo">第1/1页</span>
            <button class="pill-btn sm" type="button" id="decisionAdPrev">上一页</button>
            <button class="pill-btn sm" type="button" id="decisionAdNext">下一页</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="img-modal" id="imgModal">
  <div class="backdrop"></div>
  <img id="imgModalImg" src="" alt="product" />
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script type="module">
const [DATA, PRODUCT_MAP, SHOPIFY_SALES_DAILY, URL_DATA] = await Promise.all([
  fetch('./data/rows.json', { cache: 'no-store' }).then(r => { if (!r.ok) throw new Error('Failed to load rows.json: ' + r.status); return r.json(); }),
  fetch('./data/products.json', { cache: 'no-store' }).then(r => { if (!r.ok) throw new Error('Failed to load products.json: ' + r.status); return r.json(); }),
  fetch('./data/shopify_daily.json', { cache: 'no-store' }).then(r => { if (!r.ok) throw new Error('Failed to load shopify_daily.json: ' + r.status); return r.json(); }),
  fetch('./data/urls.json', { cache: 'no-store' }).then(r => { if (!r.ok) throw new Error('Failed to load urls.json: ' + r.status); return r.json(); }),
]);
const DECISION_HTML = '';
window.addEventListener('error', (e) => console.error(e.error || e.message));

function parseDate(s) { return new Date(s+'T00:00:00'); }
function formatDateLocal(d) {
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const day = String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${day}`;
}
function fmt(n, digits=2) {
  if (!isFinite(n)) return '-';
  if (Math.abs(n) >= 1000) return n.toLocaleString('en-US', {maximumFractionDigits:digits});
  return n.toLocaleString('en-US', {maximumFractionDigits:digits});
}
function money(n) { return '$' + fmt(n, 2); }
function pct(n) { return (n*100).toFixed(2) + '%'; }
function weekdayCN(d) {
  const map = ['日','一','二','三','四','五','六'];
  return '周' + map[d.getDay()];
}

function extractCountry(campaign) {
  if (!campaign) return 'Other';
  const tokens = String(campaign).split('|').map(t => t.trim());
  const allow = new Set(['US','CA','AU','UK','EU']);
  for (const t of tokens) {
    if (t.includes('/')) {
      const parts = t.split('/');
      if (parts.every(p => /^[A-Z]{2}$/.test(p))) return t;
    }
    if (allow.has(t)) return t;
  }
  return 'Other';
}

function aggregate(rows) {
  let spend=0, conv=0, purchases=0, impr=0, clicks=0, add=0, chk=0;
  for (const r of rows) {
    spend += r.spend||0;
    conv += r.conv||0;
    purchases += r.purchases||0;
    impr += r.impr||0;
    clicks += r.clicks||0;
    add += r.add_to_cart||0;
    chk += r.checkouts||0;
  }
  const cvr = purchases > 0 && clicks > 0 ? purchases / clicks : (purchases > 0 ? purchases/(impr||1):0);
  return {
    spend, conv, purchases, impr, clicks, add, chk,
    roas: spend ? conv/spend : 0,
    cpa: purchases ? spend/purchases : 0,
    aov: purchases ? conv/purchases : 0,
    ctr: impr ? clicks/impr : 0,
    cpc: clicks ? spend/clicks : 0,
    cpm: impr ? spend/impr*1000 : 0,
    cvr,
    atcCost: add ? spend/add : 0,
    checkoutCost: chk ? spend/chk : 0,
    atcRate: clicks ? add/clicks : 0,
    checkoutRate: add ? chk/add : 0
  };
}

function getShopifySalesInRange(shopifyId, startDate, endDate) {
  if (!shopifyId || !SHOPIFY_SALES_DAILY) return 0;
  const byDate = SHOPIFY_SALES_DAILY[String(shopifyId)] || {};
  const startKey = formatDateLocal(startDate);
  const endKey = formatDateLocal(endDate);
  let total = 0;
  for (const [d, v] of Object.entries(byDate)) {
    if (d >= startKey && d <= endKey) total += Number(v) || 0;
  }
  return total;
}

function getMonthKey(d) { return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0'); }
function startOfWeek(d) {
  const date = new Date(d.getFullYear(), d.getMonth(), d.getDate());
  const day = (date.getDay()+6)%7; // Monday=0
  date.setDate(date.getDate()-day);
  return new Date(date.getFullYear(), date.getMonth(), date.getDate());
}
function getWeekKey(d) {
  return formatDateLocal(startOfWeek(d));
}
function weekRangeFromKey(weekKey) {
  const startParts = weekKey.split('-');
  const start = new Date(parseInt(startParts[0],10), parseInt(startParts[1],10)-1, parseInt(startParts[2],10));
  const end = new Date(start);
  end.setDate(end.getDate()+6);
  return [start, end];
}

function getWeeksInMonth(monthKey) {
  const y = parseInt(monthKey.split('-')[0],10);
  const m = parseInt(monthKey.split('-')[1],10)-1;
  const start = new Date(y, m, 1);
  const end = new Date(y, m+1, 0);
  const set = new Set();
  for (let d = new Date(start); d <= end; d.setDate(d.getDate()+1)) {
    set.add(getWeekKey(d));
  }
  return Array.from(set).sort();
}

function rowsInWeekRange(rowsList, weekKey) {
  const range = weekRangeFromKey(weekKey);
  const start = range[0];
  const end = range[1];
  return rowsList.filter(r => r._date >= start && r._date <= end);
}

function normalizeIP(ip) {
  if (!ip || ip === 'Non-IP') return 'Non-IP';
  const base = ip.replace('IP-','');
  const first = base.split(' ')[0];
  return 'IP-' + first;
}
const rows = DATA.map(r => ({...r, _date: parseDate(r.date), country: extractCountry(r.campaign), ipGroup: normalizeIP(r.ip)}));
const urlRows = URL_DATA.map(r => ({...r, _date: parseDate(r.date)}));
const dates = rows.map(r => r._date);
const minDate = new Date(Math.min(...dates));
const maxDate = new Date(Math.max(...dates));

const monthSelect = document.getElementById('monthSelect');
const weekSelect = document.getElementById('weekSelect');
const timeMode = document.getElementById('timeMode');
const weekBackBtn = document.getElementById('weekBackBtn');
const startDateInput = document.getElementById('startDate');
const endDateInput = document.getElementById('endDate');
const clearRangeBtn = document.getElementById('clearRange');
const compareCategory = document.getElementById('compareCategory');
const compareAudience = document.getElementById('compareAudience');
const compareMaterial = document.getElementById('compareMaterial');
const compareAdType = document.getElementById('compareAdType');
const categorySelect = document.getElementById('categorySelect');
const adTypeSelect = document.getElementById('adTypeSelect');
const materialSelect = document.getElementById('materialSelect');
const categoryMode = document.getElementById('categoryMode');
const dayButtons = document.getElementById('dayButtons');
const rangeLabel = document.getElementById('rangeLabel');
const pieMetric = document.getElementById('pieMetric');
const pieSpendBtn = document.getElementById('pieSpendBtn');
const pieConvBtn = document.getElementById('pieConvBtn');
const chartMode = document.getElementById('chartMode');
const pieMetricGroup = document.getElementById('pieMetricGroup');
const piePanel = document.getElementById('piePanel');
const comboPanel = document.getElementById('comboPanel');
const tripleMetrics = document.getElementById('tripleMetrics');
const audiencePanel = document.getElementById('audiencePanel');
const materialPanel = document.getElementById('materialPanel');
const adTypePanel = document.getElementById('adTypePanel');
const viewPerfBtn = document.getElementById('viewPerfBtn');
const viewOpsBtn = document.getElementById('viewOpsBtn');
const viewDecisionBtn = document.getElementById('viewDecisionBtn');
const resetDashboardBtn = document.getElementById('resetDashboardBtn');
const decisionNativeRoot = document.getElementById('decisionNativeRoot');
let dashboardView = 'perf';
let decisionMounted = false;
let decisionRenderDone = false;
let decisionState = null;
let decisionCampSortState = { key: 'spend', dir: 'desc' };
let decisionAdSortState = { key: 'spend', dir: 'desc' };
let decisionCampPage = 1;
let decisionCampPageSize = 10;
let decisionAdPage = 1;
let decisionAdPageSize = 10;
let decisionCampColumnMode = 'compact';
let decisionAdColumnMode = 'compact';
let decisionAdPanelOpen = true;
let decisionKpiFocus = 'none';

function scopeDecisionCss(cssText) {
  const rootSel = '#decisionNativeRoot';
  return String(cssText || '').replace(/(^|})\\s*([^@}{][^{}]*)\\{/g, (m, prefix, selectorPart) => {
    const selectors = selectorPart.split(',').map(s => s.trim()).filter(Boolean).map(sel => {
      if (sel.startsWith(rootSel)) return sel;
      if (sel === 'body' || sel === 'html' || sel === ':root') return rootSel;
      if (sel.includes(' body')) sel = sel.replace(/\\bbody\\b/g, rootSel);
      if (sel.includes(' html')) sel = sel.replace(/\\bhtml\\b/g, rootSel);
      return `${rootSel} ${sel}`;
    });
    return `${prefix} ${selectors.join(', ')}{`;
  });
}

function mountDecisionNative() {
  return; // deprecated (kept only for compatibility)
  if (decisionMounted || !decisionNativeRoot) return;
  const parser = new DOMParser();
  const doc = parser.parseFromString(DECISION_HTML, 'text/html');

  // Keep subtitle node (#sub) for decision script, but remove visible title/back UI.
  const headerNode = doc.querySelector('.header');
  if (headerNode) {
    const titleNode = headerNode.querySelector('.title');
    if (titleNode) titleNode.remove();
    const actionsNode = headerNode.querySelector('.actions');
    if (actionsNode) actionsNode.remove();
  }

  const bodyHtml = doc.body ? doc.body.innerHTML : DECISION_HTML;
  decisionNativeRoot.innerHTML = bodyHtml;
  if (!decisionNativeRoot.querySelector('#sub')) {
    const sub = document.createElement('div');
    sub.id = 'sub';
    sub.style.display = 'none';
    decisionNativeRoot.prepend(sub);
  }

  const styleBucket = document.getElementById('decisionStyleBucket') || (() => {
    const el = document.createElement('div');
    el.id = 'decisionStyleBucket';
    el.style.display = 'none';
    document.head.appendChild(el);
    return el;
  })();

  doc.querySelectorAll('style').forEach((styleNode, idx) => {
    const tag = document.createElement('style');
    tag.setAttribute('data-decision-style', String(idx));
    tag.textContent = scopeDecisionCss(styleNode.textContent || '');
    styleBucket.appendChild(tag);
  });

  const scripts = Array.from(doc.querySelectorAll('script'));
  for (const oldScript of scripts) {
    if (oldScript.src) {
      const src = oldScript.getAttribute('src') || '';
      if (src && src.includes('chart.js') && window.Chart) continue;
      const script = document.createElement('script');
      script.src = src;
      decisionNativeRoot.appendChild(script);
    } else {
      // Execute inline script directly so parse/runtime errors can be caught and shown in-page.
      try {
        const wrappedCode = '(function(){\n' + (oldScript.textContent || '') + '\n})();';
        (new Function(wrappedCode))();
      } catch (e) {
        console.error('Decision section init failed:', e);
        decisionNativeRoot.innerHTML = `<div class="panel" style="padding:12px;color:#b3261e;">决策页加载失败：${(e && e.message) ? e.message : e}</div>`;
        return;
      }
    }
  }
  decisionMounted = true;
}

function decisionMetricCell(cur, prev, mode='both', percent=false) {
  const base = percent ? pct(cur||0) : (typeof cur === 'number' ? (Math.abs(cur)>=1 || cur===0 ? fmt(cur,2) : fmt(cur,4)) : '-');
  if (mode === 'off') return `<div class="metric-stack"><div class="base">${base}</div></div>`;
  const prevTxt = isFinite(prev) ? (percent ? pct(prev||0) : fmt(prev,2)) : '-';
  let delta = null;
  if (isFinite(prev) && prev !== 0 && isFinite(cur)) delta = (cur - prev) / Math.abs(prev);
  const deltaCls = delta == null ? '' : (delta >= 0 ? 'good' : 'bad');
  const deltaTxt = delta == null ? '-' : `${delta>=0?'▲':'▼'} ${Math.abs(delta*100).toFixed(1)}%`;
  if (mode === 'prev') return `<div class="metric-stack"><div class="base">${base}</div><div class="sub">${prevTxt}</div></div>`;
  if (mode === 'delta') return `<div class="metric-stack"><div class="base">${base}</div><div class="sub ${deltaCls}">${deltaTxt}</div></div>`;
  return `<div class="metric-stack"><div class="base">${base}</div><div class="sub">${prevTxt}</div><div class="sub ${deltaCls}">${deltaTxt}</div></div>`;
}

function decisionPriorityNum(label) {
  return ({'最高':4,'高':3,'中':2,'低':1}[label] || 1);
}
function decisionPriorityLabel(n) {
  return ({4:'最高',3:'高',2:'中',1:'低'}[n] || '低');
}
function decisionActionGroup(tag) {
  if (['扩量','小幅扩量','强扩量'].includes(tag)) return 'scale';
  if (['关闭','亏损素材'].includes(tag)) return 'pause';
  if (['优化结构','降量','点击弱','转化弱'].includes(tag)) return 'opt';
  return 'watch';
}
function decisionWeightedRoas(curRoas, prev3Roas, prev7Roas) {
  const items = [
    {v: curRoas, w: 0.5},
    {v: prev3Roas, w: 0.3},
    {v: prev7Roas, w: 0.2},
  ].filter(x => isFinite(x.v) && x.v > 0);
  if (!items.length) return 0;
  const ws = items.reduce((s,x)=>s+x.w,0);
  return items.reduce((s,x)=>s+x.v*x.w,0) / ws;
}
function decisionConfidence(cur, prev7) {
  let score = 0;
  if ((cur.spend||0) >= 80) score += 2;
  else if ((cur.spend||0) >= 30) score += 1;
  if ((cur.clicks||0) >= 50) score += 1;
  if ((cur.purchases||0) >= 3) score += 1;
  if ((prev7?.spend||0) >= 80) score += 1;
  if ((prev7?.roas||0) > 0 && Math.abs((cur.roas||0) - (prev7.roas||0)) / Math.max(prev7.roas||1, 1) > 0.6) score -= 1;
  if (score >= 4) return '高';
  if (score >= 2) return '中';
  return '低';
}
function decisionConfClass(v){ return v==='高'?'conf-high':(v==='中'?'conf-mid':'conf-low'); }
function decisionPriorityChip(n){ const label = decisionPriorityLabel(n); const cls = n>=4?'pri-chip pri-highest':(n>=3?'pri-chip pri-high':'pri-chip pri-mid'); return `<span class="${cls}">${label}</span>`; }
function decisionConfChip(v){ const cls = v==='高'?'conf-chip conf-high':(v==='中'?'conf-chip conf-mid':'conf-chip conf-low'); return `<span class="${cls}">${v}</span>`; }
function decisionPriorityScore(raw, pri=1, conf='低') {
  const v = Math.max(0, raw || 0);
  const priMul = 1 + ((pri || 1) - 1) * 0.12;
  const confMul = conf === '高' ? 1.12 : (conf === '中' ? 1.06 : 1.0);
  const base = Math.sqrt(v) * 8;
  return Math.max(0, Math.round(base * priMul * confMul));
}
function applyAdPriorityScores(rows) {
  const confBonus = { '高': 120, '中': 60, '低': 0 };
  const priBonus = { 4: 420, 3: 260, 2: 120, 1: 20 };
  const byGroup = groupBy(rows, r => r.actionGroup || 'watch');
  for (const [, group] of byGroup.entries()) {
    if (!group.length) continue;
    const sorted = group.slice().sort((a,b) => (a.impactRaw||0) - (b.impactRaw||0));
    const vals = sorted.map(x => Math.max(0, x.impactRaw || 0));
    const min = vals[0] || 0;
    const max = vals[vals.length - 1] || 0;
    const denom = Math.max(max - min, 1e-9);
    sorted.forEach((r, idx) => {
      const pct = sorted.length === 1 ? 1 : idx / (sorted.length - 1); // 0..1
      const rawNorm = (Math.max(0, r.impactRaw || 0) - min) / denom;
      let band = 8;
      if (pct >= 0.98) band = 1600;
      else if (pct >= 0.90) band = 900;
      else if (pct >= 0.75) band = 420;
      else if (pct >= 0.50) band = 180;
      else if (pct >= 0.25) band = 70;
      const spread = Math.round(rawNorm * 220);
      r.impactValue = band + spread + (priBonus[r.pri] || 0) + (confBonus[r.conf] || 0);
    });
  }
}
function decisionReasonCell(reason){
  const safe = String(reason||'-').replace(/</g,'&lt;');
  const display = (safe.length > 26 ? safe.replace(/，/, '，<br>') : safe);
  return `<details class="reason"><summary><span class="when-closed">查看原因</span><span class="when-open">收起</span></summary><div>${display}</div></details>`;
}
function bindDecisionReasonDetails(table) {
  if (!table) return;
  const sync = () => table.classList.toggle('reason-open', !!table.querySelector('details.reason[open]'));
  table.querySelectorAll('details.reason').forEach(d => d.addEventListener('toggle', sync));
  sync();
}
function applyDecisionHeaderTitles(table) {
  if (!table) return;
  table.querySelectorAll('th.help-tip[data-tip]').forEach(th => {
    th.removeAttribute('title');
  });
}
function attachDecisionColResize(tableId, cssVarName, minW, maxW, rootEl = decisionNativeRoot) {
  const table = document.getElementById(tableId);
  if (!table) return;
  const firstTh = table.querySelector('th:first-child');
  if (!firstTh || firstTh.querySelector('.col-handle')) return;
  firstTh.classList.add('resize-col');
  const handle = document.createElement('span');
  handle.className = 'col-handle';
  firstTh.appendChild(handle);
  handle.addEventListener('dblclick', (e) => {
    e.preventDefault();
    e.stopPropagation();
    rootEl.style.setProperty(cssVarName, `${minW}px`);
  });
  handle.addEventListener('mousedown', (e) => {
    e.preventDefault();
    const startX = e.clientX;
    const styles = getComputedStyle(rootEl);
    const startW = parseInt(styles.getPropertyValue(cssVarName), 10) || minW;
    function onMove(ev) {
      const next = Math.max(minW, Math.min(maxW, startW + (ev.clientX - startX)));
      rootEl.style.setProperty(cssVarName, `${next}px`);
    }
    function onUp() {
      window.removeEventListener('mousemove', onMove);
      window.removeEventListener('mouseup', onUp);
    }
    window.addEventListener('mousemove', onMove);
    window.addEventListener('mouseup', onUp);
  });
}
function attachTableFirstColResize(tableId, cssVarName, minW, maxW, clsName) {
  const table = document.getElementById(tableId);
  if (!table) return;
  const firstTh = table.querySelector('th:first-child');
  if (!firstTh || firstTh.querySelector('.col-handle')) return;
  firstTh.classList.add(clsName || 'resize-col');
  const handle = document.createElement('span');
  handle.className = 'col-handle';
  firstTh.appendChild(handle);
  handle.addEventListener('dblclick', (e) => {
    e.preventDefault(); e.stopPropagation();
    document.documentElement.style.setProperty(cssVarName, `${minW}px`);
  });
  handle.addEventListener('mousedown', (e) => {
    e.preventDefault();
    const startX = e.clientX;
    const startW = parseInt(getComputedStyle(document.documentElement).getPropertyValue(cssVarName), 10) || minW;
    function onMove(ev) {
      const next = Math.max(minW, Math.min(maxW, startW + (ev.clientX - startX)));
      document.documentElement.style.setProperty(cssVarName, `${next}px`);
    }
    function onUp() {
      window.removeEventListener('mousemove', onMove);
      window.removeEventListener('mouseup', onUp);
    }
    window.addEventListener('mousemove', onMove);
    window.addEventListener('mouseup', onUp);
  });
}
function median(nums) {
  const a = nums.filter(v=>isFinite(v)).slice().sort((x,y)=>x-y);
  if (!a.length) return 0;
  const m = Math.floor(a.length/2);
  return a.length%2 ? a[m] : (a[m-1]+a[m])/2;
}
function dateKey(d){ return formatDateLocal(d); }
function inRangeKey(k, s, e){ return k >= s && k <= e; }
function buildDecisionState() {
  const valid = rows.filter(r => r && r.date);
  if (!valid.length) return { latestKey:'-', campaigns:[], ads:[], selectedCamp:'', summary:{} };
  const latestTs = Math.max(...valid.map(r => r._date.getTime()));
  const latest = new Date(latestTs);
  const latestKey = dateKey(latest);
  const latestRows = valid.filter(r => r.date === latestKey);
  const latestByCamp = groupBy(latestRows, r => r.campaign || '-');
  const allByCamp = groupBy(valid, r => r.campaign || '-');
  const d1 = new Date(latest); d1.setDate(d1.getDate()-1);
  const prev3s = new Date(latest); prev3s.setDate(prev3s.getDate()-3);
  const prev7s = new Date(latest); prev7s.setDate(prev7s.getDate()-7);
  const prev14s = new Date(latest); prev14s.setDate(prev14s.getDate()-14);
  const k1 = dateKey(d1), k3 = dateKey(prev3s), k7 = dateKey(prev7s), k14 = dateKey(prev14s);

  const coldSpends = [];
  for (const [camp, rs] of latestByCamp.entries()) {
    const a = aggregate(rs);
    const t = (rs.find(x=>x.adType)?.adType || '').toUpperCase();
    if (t === 'COLD') coldSpends.push(a.spend);
  }
  const coldMedian = median(coldSpends);

  const campaigns = [];
  const ads = [];
  for (const [camp, latestCampRows] of latestByCamp.entries()) {
    const cur = aggregate(latestCampRows);
    const type = (latestCampRows.find(x=>x.adType)?.adType || 'OTHER').toUpperCase();
    const allCampRows = allByCamp.get(camp) || [];
    const prev3 = aggregate(allCampRows.filter(r => inRangeKey(r.date, k3, k1)));
    const prev7 = aggregate(allCampRows.filter(r => inRangeKey(r.date, k7, k1)));
    const prev14 = aggregate(allCampRows.filter(r => inRangeKey(r.date, k14, k1)));
    const wRoas = decisionWeightedRoas(cur.roas, prev3.roas, prev7.roas);
    const curOrders = cur.purchases || 0, p3Orders = prev3.purchases || 0, p7Orders = prev7.purchases || 0, p14Orders = prev14.purchases || 0;
    const minScaleP7 = 6;
    const minLightScaleP7 = Math.max(2, minScaleP7 - 2);
    const enoughScaleSample = (p7Orders >= minScaleP7) || (curOrders >= 3 && p3Orders >= 2);
    const enoughLightScaleSample = (p7Orders >= minLightScaleP7) || (curOrders >= 2 && p3Orders >= 1);
    const weakSample = (curOrders < 1) && (p3Orders < 2) && (p7Orders < 4);
    const longSpendHeavy = (prev7.spend || 0) >= 140 || (prev14.spend || 0) >= 260 || cur.spend >= 150;

    let tag='观察', action='继续观察', pri=1, reason='规则未触发阈值，继续观察';
    if (type === 'COLD') {
      if (longSpendHeavy && cur.spend >= 140 && cur.roas < 0.8 && wRoas < 1.1 && prev14.roas < 1.2 && prev7.roas < 1.25 && p7Orders <= 4) { tag='关闭'; action='暂停'; pri=4; reason=`COLD: 高花费且7/14天持续偏弱，并且近7天订单不足（防止偶发单误判）`; }
      else if (wRoas >= 2.0 && cur.roas >= 1.7 && prev3.roas >= 1.6 && prev7.roas >= 1.6 && cur.spend > Math.max(coldMedian, 60) && enoughScaleSample) { tag='扩量'; action='预算 +20%~30%'; pri=3; reason=`COLD: 综合ROAS/3天/7天均达标，且订单样本量充足`; }
      else if (wRoas >= 1.8 && cur.roas >= 1.5 && prev3.roas >= 1.4 && prev7.roas >= 1.4 && enoughLightScaleSample) { tag='小幅扩量'; action='预算 +10%'; pri=2; reason=`COLD: 综合ROAS达标且3/7天一致性较好，样本量满足小幅扩量`; }
      else if (wRoas >= 1.5) { tag='观察'; action='暂不调整 / 减量10%'; pri=1; reason=`COLD: 综合ROAS ${fmt(wRoas,2)} 在 [1.5,1.8)，观察稳定性`; }
      else if (wRoas >= 1.3) { tag='降量'; action='预算 -20%'; pri=2; reason=`COLD: 综合ROAS ${fmt(wRoas,2)} 在 [1.3,1.5)，建议降量`; }
      else if (longSpendHeavy && cur.spend >= 150 && cur.roas < 0.9 && wRoas < 1.15 && prev7.roas < 1.2 && prev14.roas < 1.3 && p7Orders <= 5) { tag='关闭'; action='暂停'; pri=4; reason=`COLD: 花费较高且7/14天连续偏弱，近7天订单不足`; }
    } else if (type === 'ASC') {
      if (longSpendHeavy && cur.spend >= 180 && cur.roas < 0.9 && wRoas < 1.15 && prev14.roas < 1.25 && prev7.roas < 1.3 && p7Orders <= 5) { tag='关闭'; action='暂停'; pri=4; reason=`ASC: 高花费且7/14天持续偏弱，近7天订单不足`; }
      else if (wRoas >= 1.9 && cur.roas >= 1.5 && prev3.roas >= 1.4 && prev7.roas >= 1.4 && cur.spend >= 80 && enoughScaleSample) { tag='扩量'; action='预算 +20%~30%'; pri=3; reason=`ASC: 综合ROAS与3/7天ROAS一致达标，且订单样本量充足`; }
      else if ((wRoas >= 1.3 || cur.roas >= 1.3) || weakSample) { tag='优化结构'; action='检查素材结构'; pri=2; reason=`ASC: ROAS进入结构优化区间，或样本量不足不直接扩量`; }
      else if (longSpendHeavy && cur.roas < 1.0 && wRoas < 1.2 && prev7.roas < 1.25 && prev14.roas < 1.3 && cur.spend >= 160 && p7Orders <= 5) { tag='关闭'; action='暂停'; pri=4; reason=`ASC: 高花费且7/14天持续低于目标，订单不足`; }
      else { tag='观察'; action='继续观察'; pri=1; reason=`ASC: 花费偏低或历史/当天信号不一致`; }
    } else if (type === 'RT') {
      if (longSpendHeavy && cur.spend >= 220 && cur.roas < 1.4 && wRoas < 1.9 && prev14.roas < 2.0 && prev7.roas < 2.0 && p7Orders <= 5) { tag='关闭'; action='暂停'; pri=4; reason=`RT: 高花费且7/14天持续低于安全线，订单不足`; }
      else if (wRoas >= 3.0 && cur.roas >= 2.5 && prev3.roas >= 2.4 && prev7.roas >= 2.4 && enoughScaleSample) { tag='强扩量'; action='预算 +20%~30%'; pri=3; reason=`RT: 综合ROAS与3/7天高位稳定，且订单样本量充足`; }
      else if (wRoas >= 2.3) { tag='观察'; action='稳定观察'; pri=1; reason=`RT: 综合ROAS处于稳定区间；若样本量不足不直接扩量`; }
      else if (wRoas >= 2.0) { tag='降量'; action='预算 -10%~-20%'; pri=2; reason=`RT: 综合ROAS ${fmt(wRoas,2)} 在 [2.0,2.3)`; }
      else if (longSpendHeavy && cur.spend >= 180 && cur.roas < 1.7 && wRoas < 1.95 && prev7.roas < 2.0 && prev14.roas < 2.1 && p7Orders <= 5) { tag='关闭'; action='暂停'; pri=4; reason=`RT: 花费较高且7/14天连续低于目标，订单不足`; }
      else { tag='观察'; action='继续观察'; pri=1; reason=`RT: 花费偏低或信号不足`; }
    }
    const conf = decisionConfidence(cur, prev7);
    const riskValue = cur.spend * Math.max(1 - cur.roas, 0);
    const scalePotential = (cur.conv || 0) * Math.max(cur.roas - 1, 0);
    const impactRaw = decisionActionGroup(tag)==='pause' ? riskValue : (decisionActionGroup(tag)==='scale' ? scalePotential : cur.spend*0.15);
    const impactValue = decisionPriorityScore(impactRaw, pri, conf);

    const campAdMap = groupBy(latestCampRows, r => r.ad || '-');
    const adAggs = Array.from(campAdMap.entries()).map(([ad, rs]) => ({ ad, rows: rs, a: aggregate(rs) }));
    const avgCtr = adAggs.length ? adAggs.reduce((s,x)=>s+(x.a.ctr||0),0)/adAggs.length : 0;
    const avgCvr = adAggs.length ? adAggs.reduce((s,x)=>s+(x.a.cvr||0),0)/adAggs.length : 0;
    const avgRoas = adAggs.length ? adAggs.reduce((s,x)=>s+(x.a.roas||0),0)/adAggs.length : 0;

    campaigns.push({ camp, type, tag, action, pri, reason, conf, wRoas, cur, prev3, prev7, prev14, riskValue, scalePotential, impactRaw, impactValue, adCount: adAggs.length, actionGroup: decisionActionGroup(tag) });

    for (const item of adAggs) {
      const ad = item.ad, a = item.a;
      const allAdRows = allCampRows.filter(r => (r.ad||'-') === ad);
      const p3 = aggregate(allAdRows.filter(r => inRangeKey(r.date, k3, k1)));
      const p7 = aggregate(allAdRows.filter(r => inRangeKey(r.date, k7, k1)));
      const p14 = aggregate(allAdRows.filter(r => inRangeKey(r.date, k14, k1)));
      const awRoas = decisionWeightedRoas(a.roas, p3.roas, p7.roas);
      let atag='普通', aaction='-', apri=1, areason='未触发重点规则';
      if (a.spend >= 20 && a.roas < 1 && awRoas < 1.2) { atag='亏损素材'; aaction='建议暂停'; apri=4; areason=`当天ROAS ${fmt(a.roas,2)} < 1 且综合ROAS ${fmt(awRoas,2)} < 1.2，花费 ${money(a.spend)} ≥ $20`; }
      else if (awRoas >= avgRoas && a.ctr >= avgCtr && a.cvr >= avgCvr) { atag='优质素材'; aaction='复制或扩量'; apri=3; areason=`综合ROAS + CTR + CVR 均高于Campaign均值`; }
      else if (a.ctr < avgCtr * 0.8) { atag='点击弱'; aaction='优化封面/标题'; apri=2; areason=`CTR ${pct(a.ctr)} 低于Campaign均值 ${pct(avgCtr)} 的80%`; }
      else if (a.ctr >= avgCtr * 0.8 && a.cvr < avgCvr * 0.8) { atag='转化弱'; aaction='检查落地页/人群'; apri=2; areason=`CVR ${pct(a.cvr)} 低于Campaign均值 ${pct(avgCvr)} 的80%`; }
      const aconf = decisionConfidence(a, p7);
      const ariskValue = a.spend * Math.max(1 - a.roas, 0);
      const ascalePotential = (a.conv || 0) * Math.max(a.roas - 1, 0);
      const aimpactRaw = decisionActionGroup(atag)==='pause' ? ariskValue : (decisionActionGroup(atag)==='scale' ? ascalePotential : a.spend*0.15);
      ads.push({ camp, ad, type, tag: atag, action: aaction, pri: apri, reason: areason, conf: aconf, wRoas: awRoas, cur: a, prev3:p3, prev7:p7, prev14:p14, riskValue: ariskValue, scalePotential: ascalePotential, impactRaw: aimpactRaw, impactValue: 0, actionGroup: decisionActionGroup(atag) });
    }
  }

  applyAdPriorityScores(ads);

  campaigns.sort((a,b)=>b.pri-a.pri || b.cur.spend-a.cur.spend);
  ads.sort((a,b)=>b.pri-a.pri || b.cur.spend-a.cur.spend);
  return {
    latestKey,
    campaigns,
    ads,
    selectedCamp: '',
    summary: {
      campScale: campaigns.filter(x=>x.actionGroup==='scale').length,
      campPause: campaigns.filter(x=>x.actionGroup==='pause').length,
      campOpt: campaigns.filter(x=>x.actionGroup==='opt').length,
      adLoss: ads.filter(x=>x.tag==='亏损素材').length,
      adGood: ads.filter(x=>x.tag==='优质素材').length,
      adClickWeak: ads.filter(x=>x.tag==='点击弱').length,
      adConvWeak: ads.filter(x=>x.tag==='转化弱').length,
    }
  };
}

function decisionTagChip(tag) {
  const cls = ['扩量','小幅扩量','强扩量'].includes(tag) ? 'tag-scale'
    : (['关闭','亏损素材'].includes(tag) ? 'tag-pause'
    : (['优化结构','点击弱','转化弱'].includes(tag) ? 'tag-opt' : 'tag-watch'));
  return `<span class="decision-chip ${cls}">${tag}</span>`;
}

function renderDecisionTodoBoard() {}

function renderDecisionKpis() {
  const s = decisionState.summary;
  const latestEl = document.getElementById('decisionLatestDate'); if (latestEl) latestEl.textContent = `最新决策日 ${decisionState.latestKey}`;
  const upEl = document.getElementById('decisionUpToDate'); if (upEl) upEl.textContent = decisionState.latestKey;
  const rulesSub = document.getElementById('decisionRulesSub');
  if (rulesSub) rulesSub.innerHTML = `数据截止：<span class="decision-date-strong">${decisionState.latestKey}</span>`;
  const watchCount = (decisionState.campaigns || []).filter(x=>x.actionGroup==='watch').length;
  const cards = [
    { key:'camp_pause', title:'暂停队列', value:s.campPause, hint:'长期偏弱且预算已跑开' },
    { key:'camp_scale', title:'扩量队列', value:s.campScale, hint:'综合ROAS达标，可优先放量' },
    { key:'camp_opt', title:'优化队列', value:s.campOpt, hint:'结构优化 / 降量处理' },
    { key:'camp_watch', title:'观察队列', value:watchCount, hint:'信号不足或需继续观察' },
  ];
  const wrap = document.getElementById('decisionKpis');
  wrap.innerHTML = cards.map(c => `
    <div class="decision-kpi clickable ${decisionKpiFocus===c.key?'active':''}" data-focus="${c.key}">
      <div class="k">${c.title}</div>
      <div class="v">${c.value}</div>
      <div class="hint">${c.hint}</div>
    </div>
  `).join('');
  wrap.querySelectorAll('.decision-kpi.clickable').forEach(card => {
    card.addEventListener('click', () => {
      const focus = card.getAttribute('data-focus') || 'none';
      decisionKpiFocus = (decisionKpiFocus === focus) ? 'none' : focus;
      applyDecisionKpiFocus();
    });
  });
}

function applyDecisionKpiFocus() {
  const campSel = document.getElementById('decisionCampFilter');
  if (!campSel) return;
  if (decisionKpiFocus === 'camp_pause') {
    campSel.value = 'pause';
  } else if (decisionKpiFocus === 'camp_scale') {
    campSel.value = 'scale';
  } else if (decisionKpiFocus === 'camp_opt') {
    campSel.value = 'opt';
  } else if (decisionKpiFocus === 'camp_watch') {
    campSel.value = 'watch';
  } else {
    campSel.value = 'all';
  }
  if (decisionState) decisionState.selectedCamp = '';
  decisionCampPage = 1;
  renderDecisionKpis();
  renderDecisionCampaignTable();
  renderDecisionAdTable();
}


function renderDecisionCampaignTable() {
  const latestKeyTip = decisionState?.latestKey || '-';
  const filter = document.getElementById('decisionCampFilter')?.value || 'all';
  const typeFilter = document.getElementById('decisionCampTypeFilter')?.value || 'all';
  let rowsC = decisionState.campaigns.filter(x =>
    (filter === 'all' ? true : x.actionGroup === filter) &&
    (typeFilter === 'all' ? true : x.type === typeFilter)
  );
  rowsC = rowsC.slice();
  rowsC.sort((a,b)=>{
    const { key, dir } = decisionCampSortState;
    let va=0, vb=0;
    if (key === 'spend') { va=a.cur.spend; vb=b.cur.spend; }
    else if (key === 'conv') { va=a.cur.conv; vb=b.cur.conv; }
    else if (key === 'roas') { va=a.cur.roas; vb=b.cur.roas; }
    else if (key === 'wroas') { va=a.wRoas; vb=b.wRoas; }
    else if (key === 'purchases') { va=a.cur.purchases; vb=b.cur.purchases; }
    else if (key === 'ctr') { va=a.cur.ctr; vb=b.cur.ctr; }
    else if (key === 'cvr') { va=a.cur.cvr; vb=b.cur.cvr; }
    else if (key === 'priority') { va=a.pri; vb=b.pri; }
    else if (key === 'impact') { va=a.impactValue; vb=b.impactValue; }
    const cmp = (vb||0) - (va||0);
    if (cmp !== 0) return dir === 'desc' ? cmp : -cmp;
    return b.cur.spend-a.cur.spend;
  });
  const total = rowsC.length;
  const totalPages = Math.max(1, Math.ceil(total / decisionCampPageSize));
  if (decisionCampPage > totalPages) decisionCampPage = totalPages;
  if (decisionCampPage < 1) decisionCampPage = 1;
  const startIdx = (decisionCampPage - 1) * decisionCampPageSize;
  const pageRows = rowsC.slice(startIdx, startIdx + decisionCampPageSize);
  const si = (k)=> decisionCampSortState.key===k ? (decisionCampSortState.dir==='desc'?'▼':'▲') : '';
  const compact = decisionCampColumnMode === 'compact';
  const head = compact ? `<tr>
    <th>Campaign</th><th>类型</th><th>标签</th><th>动作</th>
    <th class="help-tip" data-tip="结合当天花费/点击/订单与近7天稳定性评估；高=信号更稳定，低=波动或样本不足。">置信度</th>
    <th class="sortable help-tip" data-sort="priority" data-tip="最高/高/中/低；综合动作类型、风险程度与放量机会后的处理顺序建议。">优先级<span class="sort-ind">${si('priority')}</span></th><th class="sortable help-tip" data-sort="impact" data-tip="用于排序的内部处理分值（非金额）；基于风险/潜力原始值压缩，并叠加优先级与置信度。">优先级分值<span class="sort-ind">${si('impact')}</span></th><th>原因</th>
    <th class="sortable help-tip" data-sort="spend" data-tip="最新决策日（${latestKeyTip}）的花费">当天花费<span class="sort-ind">${si('spend')}</span></th>
    <th class="sortable help-tip" data-sort="roas" data-tip="最新决策日（${latestKeyTip}）的ROAS">当天ROAS<span class="sort-ind">${si('roas')}</span></th>
    <th class="sortable help-tip" data-sort="wroas" data-tip="综合ROAS：当天/前3天/前7天加权">综合ROAS<span class="sort-ind">${si('wroas')}</span></th>
    <th class="sortable help-tip" data-sort="purchases" data-tip="最新决策日（${latestKeyTip}）当天订单">当天订单<span class="sort-ind">${si('purchases')}</span></th>
  </tr>` : `<tr>
    <th>Campaign</th><th>类型</th><th>标签</th><th>动作</th>
    <th class="help-tip" data-tip="结合当天花费/点击/订单与近7天稳定性评估；高=信号更稳定，低=波动或样本不足。">置信度</th>
    <th class="sortable help-tip" data-sort="priority" data-tip="最高/高/中/低；综合动作类型、风险程度与放量机会后的处理顺序建议。">优先级<span class="sort-ind">${si('priority')}</span></th><th class="sortable help-tip" data-sort="impact" data-tip="用于排序的内部处理分值（非金额）；基于风险/潜力原始值压缩，并叠加优先级与置信度。">优先级分值<span class="sort-ind">${si('impact')}</span></th><th>原因</th>
    <th class="sortable help-tip" data-sort="spend" data-tip="最新决策日（${latestKeyTip}）的花费">当天花费<span class="sort-ind">${si('spend')}</span></th>
    <th class="sortable" data-sort="conv">转化金额<span class="sort-ind">${si('conv')}</span></th>
    <th class="sortable help-tip" data-sort="roas" data-tip="最新决策日（${latestKeyTip}）的ROAS">当天ROAS<span class="sort-ind">${si('roas')}</span></th>
    <th class="sortable help-tip" data-sort="wroas" data-tip="综合ROAS：当天/前3天/前7天加权">综合ROAS<span class="sort-ind">${si('wroas')}</span></th>
    <th class="sortable help-tip" data-sort="purchases" data-tip="最新决策日（${latestKeyTip}）当天订单">当天订单<span class="sort-ind">${si('purchases')}</span></th>
    <th>客单价</th><th>CPA</th>
    <th class="sortable" data-sort="ctr">CTR<span class="sort-ind">${si('ctr')}</span></th>
    <th>CPC</th><th>CPM</th><th class="sortable" data-sort="cvr">转化率<span class="sort-ind">${si('cvr')}</span></th>
    <th>加购成本</th><th>结帐成本</th><th>加购率</th><th>结账率</th><th>前3天ROAS</th><th>前7天ROAS</th><th>前14天ROAS</th>
  </tr>`;
  const body = pageRows.map(r => {
    const sel = decisionState.selectedCamp === r.camp ? ' style="background:#fbf4eb;"' : '';
    const rowCompact = `<tr data-camp="${String(r.camp).replace(/"/g,'&quot;')}" class="decision-camp-row"${sel}>
      <td>${r.camp}</td><td>${r.type}</td><td>${decisionTagChip(r.tag)}</td><td>${r.action}</td>
      <td class="${decisionConfClass(r.conf)}">${decisionConfChip(r.conf)}</td>
      <td class="${r.pri>=4?'priority-highest':(r.pri>=3?'priority-high':'')}">${decisionPriorityChip(r.pri)}</td>
      <td>${fmt(r.impactValue,0)}</td>
      <td>${decisionReasonCell(r.reason)}</td>
      <td>${money(r.cur.spend)}</td><td>${fmt(r.cur.roas,2)}</td><td>${fmt(r.wRoas,2)}</td><td>${fmt(r.cur.purchases,0)}</td>
    </tr>`;
    const rowFull = `<tr data-camp="${String(r.camp).replace(/"/g,'&quot;')}" class="decision-camp-row"${sel}>
      <td>${r.camp}</td><td>${r.type}</td><td>${decisionTagChip(r.tag)}</td><td>${r.action}</td>
      <td class="${decisionConfClass(r.conf)}">${decisionConfChip(r.conf)}</td>
      <td class="${r.pri>=4?'priority-highest':(r.pri>=3?'priority-high':'')}">${decisionPriorityChip(r.pri)}</td>
      <td>${fmt(r.impactValue,0)}</td><td>${decisionReasonCell(r.reason)}</td>
      <td>${money(r.cur.spend)}</td><td>${money(r.cur.conv)}</td><td>${fmt(r.cur.roas,2)}</td><td>${fmt(r.wRoas,2)}</td><td>${fmt(r.cur.purchases,0)}</td><td>${money(r.cur.aov)}</td><td>${money(r.cur.cpa)}</td>
      <td>${pct(r.cur.ctr)}</td><td>${money(r.cur.cpc)}</td><td>${money(r.cur.cpm)}</td><td>${pct(r.cur.cvr)}</td>
      <td>${money(r.cur.atcCost)}</td><td>${money(r.cur.checkoutCost)}</td><td>${pct(r.cur.atcRate)}</td><td>${pct(r.cur.checkoutRate)}</td>
      <td>${fmt(r.prev3.roas,2)}</td><td>${fmt(r.prev7.roas,2)}</td><td>${fmt(r.prev14.roas,2)}</td>
    </tr>`;
    return compact ? rowCompact : rowFull;
  }).join('');
  const tbl = document.getElementById('decisionCampTable');
  tbl.innerHTML = head + body;
  tbl.classList.toggle('compact-cols', compact);
  attachDecisionColResize('decisionCampTable', '--decision-camp-first-col', 280, 720);
  applyDecisionHeaderTitles(tbl);
  bindDecisionReasonDetails(tbl);
  tbl.querySelectorAll('.decision-camp-row').forEach(tr => tr.addEventListener('click', () => {
    const nextCamp = tr.getAttribute('data-camp') || '';
    const isSame = decisionState.selectedCamp === nextCamp;
    decisionState.selectedCamp = isSame ? '' : nextCamp;
    decisionAdPage = 1;
    decisionAdPanelOpen = isSame ? false : true;
    renderDecisionCampaignTable();
    renderDecisionAdTable();
    document.getElementById('decisionAdTitle')?.scrollIntoView({behavior:'smooth', block:'start'});
  }));
  tbl.querySelectorAll('details.reason, details.reason summary').forEach(el => el.addEventListener('click', (e) => e.stopPropagation()));
  tbl.querySelectorAll('th.sortable').forEach(th => th.addEventListener('click', () => {
    const key = th.getAttribute('data-sort');
    if (!key) return;
    if (decisionCampSortState.key === key) decisionCampSortState.dir = decisionCampSortState.dir === 'desc' ? 'asc' : 'desc';
    else { decisionCampSortState.key = key; decisionCampSortState.dir = 'desc'; }
    decisionCampPage = 1;
    renderDecisionCampaignTable();
  }));
  const info = document.getElementById('decisionCampPageInfo');
  if (info) info.textContent = `第${decisionCampPage}/${totalPages}页`;
  document.getElementById('decisionCampPrev')?.toggleAttribute('disabled', decisionCampPage <= 1);
  document.getElementById('decisionCampNext')?.toggleAttribute('disabled', decisionCampPage >= totalPages);
}

function renderDecisionAdTable() {
  const latestKeyTip = decisionState?.latestKey || '-';
  const filter = document.getElementById('decisionAdFilter')?.value || 'all';
  const camp = decisionState.selectedCamp;
  const adPanel = document.getElementById('decisionAdPanel');
  const adToggleBtn = document.getElementById('decisionAdPanelToggle');
  const adGlobalHint = document.getElementById('decisionAdGlobalHint');
  const adTitle = document.getElementById('decisionAdTitle');
  const adSub = document.getElementById('decisionAdSubline');
  if (adTitle) adTitle.textContent = 'Ad 决策';
  if (adSub) adSub.textContent = camp ? camp : '点击上方 Campaign 行后展示该 Campaign 下 Ad 明细';
  const shouldShow = decisionAdPanelOpen || !!camp;
  if (!shouldShow) {
    adPanel?.classList.add('hidden');
    if (adToggleBtn) adToggleBtn.textContent = '显示 Ad 决策';
    if (adGlobalHint) adGlobalHint.textContent = '默认展示全量 Ad 决策；点 Campaign 行可筛选到单个 Campaign。';
    const tbl0 = document.getElementById('decisionAdTable');
    if (tbl0) tbl0.innerHTML = '';
    return;
  }
  adPanel?.classList.remove('hidden');
  if (adToggleBtn) adToggleBtn.textContent = '收起 Ad 决策';
  if (adGlobalHint) adGlobalHint.textContent = camp ? '当前为单个 Campaign 的 Ad 明细（再次点击该 Campaign 行可取消筛选）。' : '当前为全量 Ad 决策视图（可点按钮收起）。';
  let rowsA = decisionState.ads.filter(x => !camp || x.camp === camp);
  rowsA = rowsA.filter(x => {
    if (filter==='all') return true;
    if (filter==='good') return x.tag==='优质素材';
    if (filter==='click') return x.tag==='点击弱';
    if (filter==='conv') return x.tag==='转化弱';
    if (filter==='loss') return x.tag==='亏损素材';
    return true;
  }).slice();
  rowsA.sort((a,b)=>{
    const { key, dir } = decisionAdSortState;
    let va=0, vb=0;
    if (key === 'spend') { va=a.cur.spend; vb=b.cur.spend; }
    else if (key === 'conv') { va=a.cur.conv; vb=b.cur.conv; }
    else if (key === 'roas') { va=a.cur.roas; vb=b.cur.roas; }
    else if (key === 'wroas') { va=a.wRoas; vb=b.wRoas; }
    else if (key === 'purchases') { va=a.cur.purchases; vb=b.cur.purchases; }
    else if (key === 'ctr') { va=a.cur.ctr; vb=b.cur.ctr; }
    else if (key === 'cvr') { va=a.cur.cvr; vb=b.cur.cvr; }
    else if (key === 'priority') { va=a.pri; vb=b.pri; }
    else if (key === 'impact') { va=a.impactValue; vb=b.impactValue; }
    const cmp = (vb||0) - (va||0);
    if (cmp !== 0) return dir === 'desc' ? cmp : -cmp;
    return b.cur.spend-a.cur.spend;
  });
  const total = rowsA.length;
  const totalPages = Math.max(1, Math.ceil(total / decisionAdPageSize));
  if (decisionAdPage > totalPages) decisionAdPage = totalPages;
  if (decisionAdPage < 1) decisionAdPage = 1;
  const startIdx = (decisionAdPage - 1) * decisionAdPageSize;
  const pageRows = rowsA.slice(startIdx, startIdx + decisionAdPageSize);
  const si = (k)=> decisionAdSortState.key===k ? (decisionAdSortState.dir==='desc'?'▼':'▲') : '';
  const compact = decisionAdColumnMode === 'compact';
  const head = compact ? `<tr>
    <th>Ad</th><th>类型</th><th>标签</th><th>动作</th>
    <th class="help-tip" data-tip="结合当天花费/点击/订单与近7天稳定性评估；高=信号更稳定，低=波动或样本不足。">置信度</th>
    <th class="sortable help-tip" data-sort="priority" data-tip="最高/高/中/低；综合动作类型、风险程度与放量机会后的处理顺序建议。">优先级<span class="sort-ind">${si('priority')}</span></th><th class="sortable help-tip" data-sort="impact" data-tip="用于排序的内部处理分值（非金额）；基于风险/潜力原始值压缩，并叠加优先级与置信度。">优先级分值<span class="sort-ind">${si('impact')}</span></th><th>原因</th>
    <th class="sortable help-tip" data-sort="spend" data-tip="最新决策日（${latestKeyTip}）的花费">当天花费<span class="sort-ind">${si('spend')}</span></th>
    <th class="sortable help-tip" data-sort="roas" data-tip="最新决策日（${latestKeyTip}）的ROAS">当天ROAS<span class="sort-ind">${si('roas')}</span></th>
    <th class="sortable help-tip" data-sort="wroas" data-tip="综合ROAS：当天/前3天/前7天加权">综合ROAS<span class="sort-ind">${si('wroas')}</span></th>
    <th class="sortable help-tip" data-sort="purchases" data-tip="最新决策日（${latestKeyTip}）当天订单">当天订单<span class="sort-ind">${si('purchases')}</span></th>
  </tr>` : `<tr>
    <th>Ad</th><th>类型</th><th>标签</th><th>动作</th>
    <th class="help-tip" data-tip="结合当天花费/点击/订单与近7天稳定性评估；高=信号更稳定，低=波动或样本不足。">置信度</th>
    <th class="sortable help-tip" data-sort="priority" data-tip="最高/高/中/低；综合动作类型、风险程度与放量机会后的处理顺序建议。">优先级<span class="sort-ind">${si('priority')}</span></th><th class="sortable help-tip" data-sort="impact" data-tip="用于排序的内部处理分值（非金额）；基于风险/潜力原始值压缩，并叠加优先级与置信度。">优先级分值<span class="sort-ind">${si('impact')}</span></th><th>原因</th>
    <th class="sortable help-tip" data-sort="spend" data-tip="最新决策日（${latestKeyTip}）的花费">当天花费<span class="sort-ind">${si('spend')}</span></th>
    <th class="sortable" data-sort="conv">转化金额<span class="sort-ind">${si('conv')}</span></th>
    <th class="sortable help-tip" data-sort="roas" data-tip="最新决策日（${latestKeyTip}）的ROAS">当天ROAS<span class="sort-ind">${si('roas')}</span></th>
    <th class="sortable help-tip" data-sort="wroas" data-tip="综合ROAS：当天/前3天/前7天加权">综合ROAS<span class="sort-ind">${si('wroas')}</span></th>
    <th class="sortable help-tip" data-sort="purchases" data-tip="最新决策日（${latestKeyTip}）当天订单">当天订单<span class="sort-ind">${si('purchases')}</span></th>
    <th>客单价</th><th>CPA</th>
    <th class="sortable" data-sort="ctr">CTR<span class="sort-ind">${si('ctr')}</span></th>
    <th>CPC</th><th>CPM</th><th class="sortable" data-sort="cvr">转化率<span class="sort-ind">${si('cvr')}</span></th>
    <th>加购成本</th><th>结帐成本</th><th>加购率</th><th>结账率</th><th>前3天ROAS</th><th>前7天ROAS</th><th>前14天ROAS</th>
  </tr>`;
  const body = pageRows.map(r => {
    const adCell = !camp
      ? `<div class="ad-cell-wrap"><div class="ad-main">${r.ad}</div><div class="ad-camp">${r.camp}</div></div>`
      : r.ad;
    return compact ? `<tr>
    <td>${adCell}</td><td>${r.type}</td><td>${decisionTagChip(r.tag)}</td><td>${r.action}</td>
    <td class="${decisionConfClass(r.conf)}">${decisionConfChip(r.conf)}</td>
    <td class="${r.pri>=4?'priority-highest':(r.pri>=3?'priority-high':'')}">${decisionPriorityChip(r.pri)}</td>
    <td>${fmt(r.impactValue,0)}</td>
    <td>${decisionReasonCell(r.reason)}</td>
    <td>${money(r.cur.spend)}</td><td>${fmt(r.cur.roas,2)}</td><td>${fmt(r.wRoas,2)}</td><td>${fmt(r.cur.purchases,0)}</td>
  </tr>` : `<tr>
    <td>${adCell}</td><td>${r.type}</td><td>${decisionTagChip(r.tag)}</td><td>${r.action}</td>
    <td class="${decisionConfClass(r.conf)}">${decisionConfChip(r.conf)}</td>
    <td class="${r.pri>=4?'priority-highest':(r.pri>=3?'priority-high':'')}">${decisionPriorityChip(r.pri)}</td><td>${fmt(r.impactValue,0)}</td><td>${decisionReasonCell(r.reason)}</td>
    <td>${money(r.cur.spend)}</td><td>${money(r.cur.conv)}</td><td>${fmt(r.cur.roas,2)}</td><td>${fmt(r.wRoas,2)}</td><td>${fmt(r.cur.purchases,0)}</td><td>${money(r.cur.aov)}</td><td>${money(r.cur.cpa)}</td>
    <td>${pct(r.cur.ctr)}</td><td>${money(r.cur.cpc)}</td><td>${money(r.cur.cpm)}</td><td>${pct(r.cur.cvr)}</td>
    <td>${money(r.cur.atcCost)}</td><td>${money(r.cur.checkoutCost)}</td><td>${pct(r.cur.atcRate)}</td><td>${pct(r.cur.checkoutRate)}</td>
    <td>${fmt(r.prev3.roas,2)}</td><td>${fmt(r.prev7.roas,2)}</td><td>${fmt(r.prev14.roas,2)}</td>
  </tr>`;
  }).join('');
  const tbl = document.getElementById('decisionAdTable');
  tbl.innerHTML = head + body;
  tbl.classList.toggle('compact-cols', compact);
  attachDecisionColResize('decisionAdTable', '--decision-ad-first-col', 320, 900);
  applyDecisionHeaderTitles(tbl);
  bindDecisionReasonDetails(tbl);
  tbl.querySelectorAll('details.reason, details.reason summary').forEach(el => el.addEventListener('click', (e) => e.stopPropagation()));
  tbl.querySelectorAll('th.sortable').forEach(th => th.addEventListener('click', () => {
    const key = th.getAttribute('data-sort');
    if (!key) return;
    if (decisionAdSortState.key === key) decisionAdSortState.dir = decisionAdSortState.dir === 'desc' ? 'asc' : 'desc';
    else { decisionAdSortState.key = key; decisionAdSortState.dir = 'desc'; }
    decisionAdPage = 1;
    renderDecisionAdTable();
  }));
  const info = document.getElementById('decisionAdPageInfo');
  if (info) info.textContent = `第${decisionAdPage}/${totalPages}页`;
  document.getElementById('decisionAdPrev')?.toggleAttribute('disabled', decisionAdPage <= 1);
  document.getElementById('decisionAdNext')?.toggleAttribute('disabled', decisionAdPage >= totalPages);
}

function initDecisionSection() {
  if (decisionRenderDone) return;
  decisionState = buildDecisionState();
  renderDecisionKpis();
  renderDecisionCampaignTable();
  renderDecisionAdTable();
  ['decisionCampFilter','decisionCampTypeFilter'].forEach(id => document.getElementById(id)?.addEventListener('change', () => { decisionKpiFocus = 'none'; decisionCampPage = 1; if (decisionState) decisionState.selectedCamp = ''; renderDecisionKpis(); renderDecisionCampaignTable(); renderDecisionAdTable(); }));
  ['decisionAdFilter'].forEach(id => document.getElementById(id)?.addEventListener('change', () => {
    decisionKpiFocus = 'none';
    renderDecisionKpis(); renderDecisionCampaignTable();
    renderDecisionAdTable();
  }));
  document.getElementById('decisionCampColumnMode')?.addEventListener('change', (e) => { decisionCampColumnMode = e.target.value || 'compact'; renderDecisionCampaignTable(); });
  document.getElementById('decisionAdColumnMode')?.addEventListener('change', (e) => { decisionAdColumnMode = e.target.value || 'compact'; renderDecisionAdTable(); });
  document.getElementById('decisionAdPageSize')?.addEventListener('change', (e) => {
    decisionAdPageSize = parseInt(e.target.value, 10) || 10;
    decisionAdPage = 1;
    renderDecisionAdTable();
  });
  document.getElementById('decisionAdPrev')?.addEventListener('click', () => {
    if (decisionAdPage > 1) { decisionAdPage--; renderDecisionAdTable(); }
  });
  document.getElementById('decisionAdNext')?.addEventListener('click', () => {
    decisionAdPage++; renderDecisionAdTable();
  });
  document.getElementById('decisionAdPanelToggle')?.addEventListener('click', () => {
    decisionAdPanelOpen = !decisionAdPanelOpen;
    if (!decisionAdPanelOpen && decisionState) decisionState.selectedCamp = '';
    decisionAdPage = 1;
    renderDecisionCampaignTable();
    renderDecisionAdTable();
  });
  document.getElementById('decisionCampPageSize')?.addEventListener('change', (e) => {
    decisionCampPageSize = parseInt(e.target.value, 10) || 10;
    decisionCampPage = 1;
    renderDecisionCampaignTable();
  });
  document.getElementById('decisionCampPrev')?.addEventListener('click', () => {
    if (decisionCampPage > 1) { decisionCampPage--; renderDecisionCampaignTable(); }
  });
  document.getElementById('decisionCampNext')?.addEventListener('click', () => {
    decisionCampPage++; renderDecisionCampaignTable();
  });
  decisionRenderDone = true;
}

const filterDefaults = new Map();
function initFilterDefaults() {
  document.querySelectorAll('select, input[type="date"]').forEach(el => {
    filterDefaults.set(el, el.value || '');
  });
  updateFilterHighlights();
}
function updateFilterHighlights() {
  document.querySelectorAll('select, input[type="date"]').forEach(el => {
    const def = filterDefaults.get(el) ?? '';
    const val = el.value || '';
    const normalizedDefault = (def || '').toString().trim().toLowerCase();
    const normalizedValue = (val || '').toString().trim().toLowerCase();
    const isAllDefaultPair = normalizedDefault === '' && (normalizedValue === 'all' || normalizedValue === '全部');
    let changed = isAllDefaultPair ? false : (val !== def);
    const timeFilterIds = new Set(['timeMode','monthSelect','weekSelect','startDate','endDate']);
    if (timeFilterIds.has(el.id)) changed = false;
    if (el.id === 'monthSelect' && timeMode.value === 'week') changed = true;
    if (timeFilterIds.has(el.id)) changed = false;
    el.classList.toggle('changed-input', changed);
  });
}

function updateTripleCompareLayout() {
  const anyOn =
    (compareAudience?.value || 'off') !== 'off' ||
    (compareMaterial?.value || 'off') !== 'off' ||
    (compareAdType?.value || 'off') !== 'off';
  tripleMetrics?.classList.toggle('compare-mode', anyOn);
}

function setDashboardView(mode) {
  dashboardView = (mode === 'ops' || mode === 'decision') ? mode : 'perf';
  const showPerf = dashboardView === 'perf';
  const showDecision = dashboardView === 'decision';
  const perfIds = ['kpiGrid','trendSection','categorySection','tripleMetrics','chartSection','dailySection'];
  const opsIds = ['productSection','urlSection','urlProductPageSection'];
  perfIds.forEach(id => document.getElementById(id)?.classList.toggle('hidden', !showPerf));
  opsIds.forEach(id => document.getElementById(id)?.classList.toggle('hidden', showPerf || showDecision));
  document.getElementById('weeklyNewAdsSection')?.classList.add('hidden');
  document.getElementById('decisionSection')?.classList.toggle('hidden', !showDecision);
  if (showDecision) initDecisionSection();
  document.querySelector('.header .filters')?.classList.toggle('hidden', showDecision);
  document.getElementById('rangeLabel')?.classList.toggle('hidden', showDecision);
  if (viewPerfBtn) viewPerfBtn.classList.toggle('active', showPerf);
  if (viewOpsBtn) viewOpsBtn.classList.toggle('active', dashboardView === 'ops');
  if (viewDecisionBtn) viewDecisionBtn.classList.toggle('active', showDecision);
  if (!showDecision) renderWeeklyNewAdsBoard();
}

function resetDashboard() {
  const currentView = dashboardView;
  if (currentView === 'decision') {
    decisionKpiFocus = 'none';
    decisionCampSortState = { key: 'spend', dir: 'desc' };
    decisionAdSortState = { key: 'spend', dir: 'desc' };
    decisionCampPage = 1;
    decisionCampPageSize = 10;
    decisionAdPage = 1;
    decisionAdPageSize = 10;
    if (decisionState) decisionState.selectedCamp = '';
    ['decisionCampFilter','decisionCampTypeFilter','decisionAdFilter'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.value = 'all';
    });
    const cMode = document.getElementById('decisionCampColumnMode');
    if (cMode) cMode.value = 'compact';
    const aMode = document.getElementById('decisionAdColumnMode');
    if (aMode) aMode.value = 'compact';
    decisionCampColumnMode = 'compact';
    decisionAdColumnMode = 'compact';
    const pageSizeSel = document.getElementById('decisionCampPageSize');
    if (pageSizeSel) pageSizeSel.value = '10';
    const adPageSizeSel = document.getElementById('decisionAdPageSize');
    if (adPageSizeSel) adPageSizeSel.value = '10';
    decisionAdPanelOpen = true;
    decisionNativeRoot?.style.setProperty('--decision-camp-first-col', '420px');
    decisionNativeRoot?.style.setProperty('--decision-ad-first-col', '520px');
    if (decisionRenderDone) {
      decisionState = buildDecisionState();
      renderDecisionKpis();
      renderDecisionCampaignTable();
      renderDecisionAdTable();
    }
    setDashboardView('decision');
    updateFilterHighlights();
    return;
  }

  const currentTimeMode = timeMode.value;
  applyDefaultTimeForMode(currentTimeMode === 'week' ? 'week' : (currentTimeMode === 'range' ? 'range' : 'month'));

  categorySelect.value = 'ALL';
  adTypeSelect.value = 'ALL';
  materialSelect.value = 'ALL';
  categoryMode.value = 'category';
  compareCategory.value = 'off';
  compareAudience.value = 'off';
  compareMaterial.value = 'off';
  compareAdType.value = 'off';

  chartMode.value = 'pie';
  pieMetric.value = 'spend';
  pieSpendBtn.classList.add('active');
  pieConvBtn.classList.remove('active');

  dailyPageSizeSelect.value = '15';
  dailyPageSize = 15;
  dailyPage = 1;
  weeklyNewAdsViewModeState = 'all';
  weeklyNewAdsGroupModeState = 'none';
  weeklyNewAdsExpandedGroups.clear();
  if (weeklyNewAdsViewModeSelect) weeklyNewAdsViewModeSelect.value = 'all';
  if (weeklyNewAdsGroupModeSelect) weeklyNewAdsGroupModeSelect.value = 'none';

  productCategory = 'ALL';
  if (productCategorySelect) productCategorySelect.value = 'ALL';
  productCompareMode = 'off';
  if (productCompareSelect) productCompareSelect.value = 'off';
  productSearch = '';
  if (productSearchInput) productSearchInput.value = '';
  productPageSize = 15;
  if (productPageSizeSelect) productPageSizeSelect.value = '15';
  productSortKey = 'spend';
  productSortDir = 'desc';
  productPage = 1;

  urlTag = 'all';
  if (urlTagFilter) urlTagFilter.value = 'all';
  urlCompareMode = 'off';
  if (urlCompareSelect) urlCompareSelect.value = 'off';
  urlSearch = '';
  if (urlSearchInput) urlSearchInput.value = '';
  urlPageSize = 15;
  if (urlPageSizeSelect) urlPageSizeSelect.value = '15';
  urlSortKey = 'spend';
  urlSortDir = 'desc';
  urlPage = 1;
  selectedUrl = '';
  urlDetailSortKey = 'spend';
  urlDetailSortDir = 'desc';
  urlDetailPage = 1;
  urlDetailPageSize = 10;
  urlProductDetailSortKey = 'spend';
  urlProductDetailSortDir = 'desc';
  urlProductDetailPage = 1;
  urlProductDetailPageSize = 10;
  urlDetailOpen = false;
  urlProductDetailOpen = false;
  selectedUrl = '';
  if (urlDetailPageSizeSelect) urlDetailPageSizeSelect.value = '10';
  if (urlProductDetailPageSizeSelect) urlProductDetailPageSizeSelect.value = '10';
  urlProdPage = 1;
  urlProdPageSize = 15;
  urlProdSortKey = 'url';
  urlProdSortDir = 'desc';
  urlProdPageMode = 'all';
  urlProdSearch = '';
  urlProdExpandedUrls.clear();
  if (urlProdPageFilter) urlProdPageFilter.value = 'all';
  if (urlProdSearchInput) urlProdSearchInput.value = '';
  if (urlProdPageSizeSelect) urlProdPageSizeSelect.value = '15';

  setDashboardView(currentView === 'ops' ? 'ops' : 'perf');
  updateFilterVisibility();
  updateFilterHighlights();
  updateAll();
}
const dailyPageSizeSelect = document.getElementById('dailyPageSize');
const weeklyNewAdsViewModeSelect = document.getElementById('weeklyNewAdsViewMode');
const weeklyNewAdsGroupModeSelect = document.getElementById('weeklyNewAdsGroupMode');
const monthGroup = document.getElementById('monthGroup');
const weekGroup = document.getElementById('weekGroup');
const timeRow = document.getElementById('timeRow');
const dimRow = document.getElementById('dimRow');
const dateRangeGroup = document.getElementById('dateRangeGroup');
const clearRangeGroup = document.getElementById('clearRangeGroup');
const filtersRoot = document.querySelector('.filters');
const productCategorySelect = document.getElementById('productCategory');
const productCompareSelect = document.getElementById('productCompare');
const productSearchInput = document.getElementById('productSearch');
const productSearchClearBtn = document.getElementById('productSearchClear');
const productPageSizeSelect = document.getElementById('productPageSize');
const urlTagFilter = document.getElementById('urlTagFilter');
const urlCompareSelect = document.getElementById('urlCompare');
const urlSearchInput = document.getElementById('urlSearch');
const urlSearchClearBtn = document.getElementById('urlSearchClear');
const urlPageSizeSelect = document.getElementById('urlPageSize');
const urlDetailBackBtn = document.getElementById('urlDetailBack');
const urlDetailPageSizeSelect = document.getElementById('urlDetailPageSize');
const urlProductDetailBackBtn = document.getElementById('urlProductDetailBack');
const urlProductDetailPageSizeSelect = document.getElementById('urlProductDetailPageSize');
const urlProdPageFilter = document.getElementById('urlProdPageFilter');
const urlProdExpandAllBtn = document.getElementById('urlProdExpandAllBtn');
const urlProdSearchInput = document.getElementById('urlProdSearch');
const urlProdSearchClearBtn = document.getElementById('urlProdSearchClear');
const urlProdPageSizeSelect = document.getElementById('urlProdPageSize');
const dimControls = Array.from(dimRow.querySelectorAll('.filter-group'));

function setDimInlineWeek(inline) {
  if (inline) {
    dimControls.forEach(g => {
      if (g.parentElement !== timeRow) timeRow.appendChild(g);
    });
    dimRow.classList.add('hidden');
  } else {
    dimControls.forEach(g => {
      if (g.parentElement !== dimRow) dimRow.appendChild(g);
    });
    dimRow.classList.remove('hidden');
  }
}

function updateTimeOrder() {
  if (timeMode.value === 'week') {
    if (timeRow.firstElementChild !== monthGroup) {
      timeRow.insertBefore(monthGroup, weekGroup);
    }
  } else {
    if (timeRow.firstElementChild !== weekGroup) {
      timeRow.insertBefore(weekGroup, monthGroup);
    }
  }
}

const months = Array.from(new Set(rows.map(r => getMonthKey(r._date)))).sort();
monthSelect.innerHTML = months.map(m => `<option value="${m}">${m}</option>`).join('');

startDateInput.min = formatDateLocal(minDate);
startDateInput.max = formatDateLocal(maxDate);
endDateInput.min = formatDateLocal(minDate);
endDateInput.max = formatDateLocal(maxDate);

const categoryOrder = ['IP','Matching','Bamboo','Children','Other'];
const adTypeOrder = ['COLD','ASC','RT'];
const materialOrder = ['feed','img','vid','ptn','post','other'];

categorySelect.innerHTML = ['ALL', ...categoryOrder].map(c => `<option value="${c}">${c==='ALL'?'全部':c}</option>`).join('');
adTypeSelect.innerHTML = ['ALL', ...adTypeOrder].map(a => `<option value="${a}">${a==='ALL'?'全部':a}</option>`).join('');
materialSelect.innerHTML = ['ALL', ...materialOrder].map(m => {
  if (m === 'ALL') return `<option value="ALL">全部</option>`;
  return `<option value="${m}">${m.toUpperCase()}</option>`;
}).join('');

function updateWeeks() {
  const m = monthSelect.value;
  const weeks = getWeeksInMonth(m);
  const list = timeMode.value === 'week' ? weeks : ['MONTH', ...weeks];
  weekSelect.innerHTML = list.map(w => {
    if (w === 'MONTH') return `<option value="MONTH">月度</option>`;
    const range = weekRangeFromKey(w);
    const s = formatDateLocal(range[0]).slice(5,10);
    const e = formatDateLocal(range[1]).slice(5,10);
    return `<option value="${w}">${s}~${e}</option>`;
  }).join('');
}

function isCustomRange() {
  return timeMode.value === 'range' && startDateInput.value && endDateInput.value;
}

function updateFilterVisibility() {
  const mode = timeMode.value;
  const isRange = mode === 'range';
  const isWeek = mode === 'week';
  const isMonth = mode === 'month';
  monthGroup.classList.toggle('hidden', isRange);
  weekGroup.classList.toggle('hidden', !isWeek);
  dayButtons.classList.toggle('hidden', !isWeek);
  dateRangeGroup.classList.toggle('hidden', !isRange);
  clearRangeGroup?.classList.toggle('hidden', !isRange);
  timeRow.classList.toggle('hidden', false);
  setDimInlineWeek(isWeek);
  filtersRoot?.classList.toggle('week-inline', isWeek);
  updateTimeOrder();
  if (weekBackBtn) weekBackBtn.classList.toggle('hidden', !isWeek);
  const weeklyNewAdsSection = document.getElementById('weeklyNewAdsSection');
  if (weeklyNewAdsSection && (!isWeek || isRange)) weeklyNewAdsSection.classList.add('hidden');
}

function applyDefaultTimeForMode(mode) {
  const latestMonth = getMonthKey(maxDate);
  const latestWeek = getWeekKey(maxDate);
  const latestDay = formatDateLocal(maxDate);
  if (mode === 'week') {
    timeMode.value = 'week';
    monthSelect.value = latestMonth;
    startDateInput.value = '';
    endDateInput.value = '';
    updateWeeks();
    weekSelect.value = latestWeek;
    renderDayButtons(latestWeek);
    const allBtn = dayButtons.querySelector('.pill-btn[data-day="ALL"]');
    if (allBtn) {
      dayButtons.querySelectorAll('.pill-btn').forEach(b=>b.classList.remove('active'));
      allBtn.classList.add('active');
    }
    return;
  }
  if (mode === 'range') {
    timeMode.value = 'range';
    monthSelect.value = latestMonth;
    startDateInput.value = latestDay;
    endDateInput.value = latestDay;
    updateWeeks();
    dayButtons.innerHTML = '';
    return;
  }
  timeMode.value = 'month';
  monthSelect.value = latestMonth;
  startDateInput.value = '';
  endDateInput.value = '';
  updateWeeks();
  weekSelect.value = 'MONTH';
  dayButtons.innerHTML = '';
}

function renderDayButtons(weekKey) {
  if (!weekKey || isCustomRange() || weekKey === 'MONTH' || timeMode.value !== 'week') {
    dayButtons.innerHTML = '';
    return;
  }
  const range = weekRangeFromKey(weekKey);
  const start = range[0];
  const end = range[1];
  const startLimit = startDateInput.value ? parseDate(startDateInput.value) : null;
  const labels = [];
  for (let d = new Date(start); d <= end; d.setDate(d.getDate()+1)) {
    if (!startLimit || d >= startLimit) labels.push(new Date(d));
  }
  const dayBtns = labels.map(d => {
    const key = formatDateLocal(d);
    return `<button class="pill-btn" data-day="${key}">${key.slice(5)} ${weekdayCN(d)}</button>`;
  }).join('');
  dayButtons.innerHTML = `<button class="pill-btn active" data-day="ALL">本周</button>` + dayBtns;
}

function filterRows() {
  const m = monthSelect.value;
  const w = weekSelect.value;
  const start = startDateInput.value ? parseDate(startDateInput.value) : null;
  const end = endDateInput.value ? parseDate(endDateInput.value) : null;
  const cat = categorySelect.value;
  const adt = adTypeSelect.value;
  const mat = materialSelect.value;
  const dayBtn = dayButtons.querySelector('.pill-btn.active');
  const dayKey = dayBtn ? dayBtn.getAttribute('data-day') : null;
  let filtered;
  if (isCustomRange()) {
    filtered = rows.filter(r => r._date >= start && r._date <= end);
  } else if (timeMode.value === 'month') {
    filtered = rows.filter(r => getMonthKey(r._date)===m);
  } else if (timeMode.value === 'week') {
    filtered = rowsInWeekRange(rows, w);
  } else {
    filtered = rows.filter(r => getMonthKey(r._date)===m);
  }
  if (timeMode.value === 'week' && dayKey && dayKey !== 'ALL') filtered = filtered.filter(r => r.date === dayKey);
  if (cat && cat !== 'ALL') filtered = filtered.filter(r => r.category === cat);
  if (adt && adt !== 'ALL') filtered = filtered.filter(r => r.adType === adt);
  if (mat && mat !== 'ALL') filtered = filtered.filter(r => r.material === mat);
  return filtered;
}

function getDateRangeForCurrentFilter() {
  if (isCustomRange()) {
    return [parseDate(startDateInput.value), parseDate(endDateInput.value)];
  }
  const dayBtn = dayButtons.querySelector('.pill-btn.active');
  if (timeMode.value === 'week' && dayBtn && dayBtn.getAttribute('data-day') !== 'ALL') {
    const d = parseDate(dayBtn.getAttribute('data-day'));
    return [d,d];
  }
  if (timeMode.value === 'week') {
    const w = weekSelect.value;
    if (w && w !== 'MONTH') return weekRangeFromKey(w);
  }
  const y = parseInt(monthSelect.value.split('-')[0],10);
  const m = parseInt(monthSelect.value.split('-')[1],10)-1;
  return [new Date(y,m,1), new Date(y,m+1,0)];
}

function getPrevRange(start, end) {
  const days = Math.round((end - start) / 86400000) + 1;
  const prevEnd = new Date(start);
  prevEnd.setDate(prevEnd.getDate() - 1);
  const prevStart = new Date(prevEnd);
  prevStart.setDate(prevStart.getDate() - (days - 1));
  return [prevStart, prevEnd];
}

function filterRowsByRange(start, end) {
  const cat = categorySelect.value;
  const adt = adTypeSelect.value;
  const mat = materialSelect.value;
  let filtered = rows.filter(r => r._date >= start && r._date <= end);
  if (cat && cat !== 'ALL') filtered = filtered.filter(r => r.category === cat);
  if (adt && adt !== 'ALL') filtered = filtered.filter(r => r.adType === adt);
  if (mat && mat !== 'ALL') filtered = filtered.filter(r => r.material === mat);
  return filtered;
}

function renderKPIs(rowsFiltered) {
  const a = aggregate(rowsFiltered);
  const range = getDateRangeForCurrentFilter();
  const start = range[0];
  const end = range[1];
  const days = Math.round((end - start)/86400000) + 1;
  const prevStart = new Date(start); prevStart.setDate(prevStart.getDate()-days);
  const prevEnd = new Date(start); prevEnd.setDate(prevEnd.getDate()-1);
  const prevRows = rows.filter(r => r._date>=prevStart && r._date<=prevEnd);
  const p = aggregate(prevRows);
  const delta = (curr, prev) => prev ? (curr-prev)/prev : 0;

  const kpis = [
    {label:'花费', value: money(a.spend), delta: delta(a.spend,p.spend)},
    {label:'转化金额', value: money(a.conv), delta: delta(a.conv,p.conv)},
    {label:'ROAS', value: fmt(a.roas,2), delta: delta(a.roas,p.roas)},
    {label:'CPA', value: money(a.cpa), delta: delta(a.cpa,p.cpa)},
    {label:'CTR', value: pct(a.ctr), delta: delta(a.ctr,p.ctr)},
    {label:'CPC', value: money(a.cpc), delta: delta(a.cpc,p.cpc)},
    {label:'CPM', value: money(a.cpm), delta: delta(a.cpm,p.cpm)},
    {label:'转化率', value: pct(a.cvr), delta: delta(a.cvr,p.cvr)}
  ];

  const grid = document.getElementById('kpiGrid');
  grid.innerHTML = kpis.map(k => {
    const cls = k.delta >= 0 ? 'good' : 'bad';
    const sign = k.delta >= 0 ? '+' : '';
    return `<div class="kpi"><div class="label">${k.label}</div><div class="value">${k.value}</div><div class="delta ${cls}">${sign}${(k.delta*100).toFixed(1)}%</div></div>`;
  }).join('');
}

let chart = null;
let adTypePie = null;
let audiencePie = null;
let materialPie = null;
let comboAudience = null;
let comboMaterial = null;
let comboAdType = null;

let dailyPage = 1;
let dailyPageSize = 15;
let productPage = 1;
let productPageSize = 15;
let productSortKey = 'spend';
let productSortDir = 'desc';
let productCategory = 'ALL';
let productCompareMode = 'off';
let productSearch = '';
let urlPage = 1;
let urlPageSize = 15;
let urlSortKey = 'spend';
let urlSortDir = 'desc';
let urlDetailSortKey = 'spend';
let urlDetailSortDir = 'desc';
let urlProductDetailSortKey = 'spend';
let urlProductDetailSortDir = 'desc';
let urlTag = 'all';
let urlSearch = '';
let urlCompareMode = 'off';
let selectedUrl = '';
let urlDetailPage = 1;
let urlDetailPageSize = 10;
let urlProductDetailPage = 1;
let urlProductDetailPageSize = 10;
let urlDetailOpen = false;
let urlProductDetailOpen = false;
let urlProdPage = 1;
let urlProdPageSize = 15;
let urlProdSortKey = 'url';
let urlProdSortDir = 'desc';
let urlProdPageMode = 'all';
let urlProdSearch = '';
const urlProdExpandedUrls = new Set();
let weeklyNewAdsViewModeState = 'all';
let weeklyNewAdsGroupModeState = 'none';
const weeklyNewAdsExpandedGroups = new Set();
if (productPageSizeSelect) {
  productPageSize = productPageSizeSelect.value === 'all' ? 'all' : (parseInt(productPageSizeSelect.value, 10) || 15);
}
if (urlPageSizeSelect) {
  urlPageSize = urlPageSizeSelect.value === 'all' ? 'all' : (parseInt(urlPageSizeSelect.value, 10) || 15);
}
if (urlDetailPageSizeSelect) {
  urlDetailPageSize = urlDetailPageSizeSelect.value === 'all' ? 'all' : (parseInt(urlDetailPageSizeSelect.value, 10) || 10);
}
if (urlProductDetailPageSizeSelect) {
  urlProductDetailPageSize = urlProductDetailPageSizeSelect.value === 'all' ? 'all' : (parseInt(urlProductDetailPageSizeSelect.value, 10) || 10);
}
if (urlProdPageSizeSelect) {
  urlProdPageSize = urlProdPageSizeSelect.value === 'all' ? 'all' : (parseInt(urlProdPageSizeSelect.value, 10) || 15);
}

const roasLabelPlugin = {
  id: 'roasLabel',
  afterDatasetsDraw(chartInstance) {
    const {ctx} = chartInstance;
    ctx.save();
    ctx.font = '12px Manrope';
    ctx.fillStyle = '#2b5d9a';
    chartInstance.data.datasets.forEach((dataset, i) => {
      if (!dataset.showLabels) return;
      const meta = chartInstance.getDatasetMeta(i);
      meta.data.forEach((pt, idx) => {
        const val = dataset.data[idx];
        if (!isFinite(val)) return;
        ctx.fillText(Number(val).toFixed(2), pt.x - 10, pt.y - 10);
      });
    });
    ctx.restore();
  }
};
function renderChart(rowsFiltered) {
  const custom = isCustomRange();
  const w = weekSelect.value;
  const startLimit = startDateInput.value ? parseDate(startDateInput.value) : null;
  const endLimit = endDateInput.value ? parseDate(endDateInput.value) : null;
  const dayBtn = dayButtons.querySelector('.pill-btn.active');
  const isDay = dayBtn && dayBtn.getAttribute('data-day') !== 'ALL';
  const isMonth = (!custom) && (timeMode.value === 'month');

  let start, end;
  const rangeWeek = weekRangeFromKey(w === 'MONTH' ? getWeekKey(new Date(monthSelect.value+'-01')) : w);
  if (isMonth) {
    const y = parseInt(monthSelect.value.split('-')[0],10);
    const m = parseInt(monthSelect.value.split('-')[1],10)-1;
    start = new Date(y, m, 1);
    end = new Date(y, m+1, 0);
  } else {
    if (timeMode.value === 'week') {
      start = rangeWeek[0];
      end = rangeWeek[1];
    } else {
      const y = parseInt(monthSelect.value.split('-')[0],10);
      const m = parseInt(monthSelect.value.split('-')[1],10)-1;
      start = new Date(y, m, 1);
      end = new Date(y, m+1, 0);
    }
  }
  if (startLimit && start < startLimit) start = new Date(startLimit);
  if (custom) {
    start = startLimit;
    end = endLimit;
  }

  let days = [];
  if (isDay && !custom && timeMode.value === 'week') {
    const d = parseDate(dayBtn.getAttribute('data-day'));
    days = [d];
  } else {
    for (let d=new Date(start); d<=end; d.setDate(d.getDate()+1)) days.push(new Date(d));
  }
  const labels = days.map(d => formatDateLocal(d).slice(5,10));

  const baseRows = rows
    .filter(r => custom ? true : (timeMode.value === 'month' ? getMonthKey(r._date)===monthSelect.value : true))
    .filter(r => custom ? true : (timeMode.value === 'week' ? (r._date >= rangeWeek[0] && r._date <= rangeWeek[1]) : true))
    .filter(r => startLimit ? r._date >= startLimit : true)
    .filter(r => custom ? (r._date >= start && r._date <= end) : true)
    .filter(r => categorySelect.value==='ALL' ? true : r.category===categorySelect.value)
    .filter(r => adTypeSelect.value==='ALL' ? true : r.adType===adTypeSelect.value)
    .filter(r => materialSelect.value==='ALL' ? true : r.material===materialSelect.value);

  const spend = days.map(d => aggregate(baseRows.filter(r => r._date.toDateString()===d.toDateString())).spend);
  const conv = days.map(d => aggregate(baseRows.filter(r => r._date.toDateString()===d.toDateString())).conv);
  const roas = days.map(d => aggregate(baseRows.filter(r => r._date.toDateString()===d.toDateString())).roas);

  const weekRows = rows
    .filter(r => custom ? true : (timeMode.value === 'month' ? getMonthKey(r._date)===monthSelect.value : true))
    .filter(r => custom ? true : (timeMode.value === 'week' ? (r._date >= rangeWeek[0] && r._date <= rangeWeek[1]) : true))
    .filter(r => startLimit ? r._date >= startLimit : true)
    .filter(r => custom ? (r._date >= start && r._date <= end) : true)
    .filter(r => categorySelect.value==='ALL' ? true : r.category===categorySelect.value)
    .filter(r => adTypeSelect.value==='ALL' ? true : r.adType===adTypeSelect.value)
    .filter(r => materialSelect.value==='ALL' ? true : r.material===materialSelect.value);
  const weekDays = w==='ALL' ? days : (() => { const ds=[]; for (let d=new Date(rangeWeek[0]); d<=rangeWeek[1]; d.setDate(d.getDate()+1)) ds.push(new Date(d)); return ds; })();
  const weekSpendArr = weekDays.map(d => aggregate(weekRows.filter(r => r._date.toDateString()===d.toDateString())).spend);
  const weekConvArr = weekDays.map(d => aggregate(weekRows.filter(r => r._date.toDateString()===d.toDateString())).conv);
  const avgSpend = weekSpendArr.reduce((a,b)=>a+b,0) / (weekDays.length||1);
  const avgConv = weekConvArr.reduce((a,b)=>a+b,0) / (weekDays.length||1);
  const spendAvg = days.map(() => avgSpend);
  const convAvg = days.map(() => avgConv);

  const ctx = document.getElementById('trendChart').getContext('2d');
  if (chart) chart.destroy();
  const datasets = isDay ? [
    { label: '花费-当日', data: spend, backgroundColor: 'rgba(199,106,31,0.65)', borderRadius: 6 },
    { label: '花费-周均', data: spendAvg, backgroundColor: 'rgba(199,106,31,0.25)', borderRadius: 6 },
    { label: '转化金额-当日', data: conv, backgroundColor: 'rgba(31,122,122,0.65)', borderRadius: 6 },
    { label: '转化金额-周均', data: convAvg, backgroundColor: 'rgba(31,122,122,0.25)', borderRadius: 6 }
  ] : [
    { label: '花费', data: spend, backgroundColor: 'rgba(199,106,31,0.65)', borderRadius: 6 },
    { label: '转化金额', data: conv, backgroundColor: 'rgba(31,122,122,0.65)', borderRadius: 6 },
    { label: 'ROAS', data: roas, type: 'line', borderColor: '#2b5d9a', backgroundColor: '#2b5d9a', yAxisID:'y1', tension:0.35, pointRadius:4, pointStyle:'circle', showLabels: true }
  ];
  chart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets
    },
    options: {
      responsive:true,
      maintainAspectRatio:false,
      scales: {
        y: { beginAtZero:true },
        y1: { beginAtZero:true, position:'right', grid:{drawOnChartArea:false} }
      },
      plugins: { legend: { position:'top' } }
    },
    plugins: [roasLabelPlugin]
  });
}

const SORTABLE_TABLE_IDS = new Set(['categoryTable','audienceTable','materialTable','adTypeTable','dailyTable','weeklyNewAdsTable','urlTable','urlDetailTable']);
const tableSortState = {};

function getSortedRows(elId, rows, columns) {
  const st = tableSortState[elId];
  if (!st || !st.key) return rows.slice();
  const col = columns.find(c => c.key === st.key);
  if (!col) return rows.slice();
  const dir = st.dir === 'asc' ? 1 : -1;
  return rows.slice().sort((a, b) => {
    const va = a[col.key];
    const vb = b[col.key];
    if (typeof va === 'string' || typeof vb === 'string') {
      return String(va || '').localeCompare(String(vb || '')) * dir;
    }
    return ((Number(va) || 0) - (Number(vb) || 0)) * dir;
  });
}

function renderTable(elId, rows, columns, top=12, opts={}) {
  const el = document.getElementById(elId);
  if (!el) return;
  const sortableTable = SORTABLE_TABLE_IDS.has(elId);
  const st = tableSortState[elId] || {key:null, dir:'desc'};
  const renderRows = (sortableTable && !opts.skipSort) ? getSortedRows(elId, rows, columns) : rows;
  const header = `<tr>${columns.map(c => {
    const isSortable = sortableTable && c.sortable !== false;
    const active = isSortable && st.key === c.key;
    const ind = active ? (st.dir === 'asc' ? '▲' : '▼') : '';
    return `<th class="${isSortable ? 'sortable' : ''}" ${isSortable ? `data-key="${c.key}"` : ''}>${c.label}${isSortable ? `<span class="sort-ind">${ind}</span>` : ''}</th>`;
  }).join('')}</tr>`;
  const body = renderRows.slice(0, top).map(r => {
    return `<tr>${columns.map(c => `<td>${c.format(r[c.key], r)}</td>`).join('')}</tr>`;
  }).join('');
  el.innerHTML = header + body;
}

function renderDailyTable(rows) {
  const columns = [
    {label:'日期', key:'name', format:v=>v},
    {label:'花费', key:'spend', format:money},
    {label:'转化金额', key:'conv', format:money},
    {label:'ROAS', key:'roas', format:v=>fmt(v,2)},
    {label:'订单', key:'purchases', format:v=>fmt(v,0)},
    {label:'客单价', key:'aov', format:money},
    {label:'CPA', key:'cpa', format:money},
    {label:'CTR', key:'ctr', format:v=>pct(v)},
    {label:'CPC', key:'cpc', format:money},
    {label:'CPM', key:'cpm', format:money},
    {label:'转化率', key:'cvr', format:v=>pct(v)},
    {label:'加购成本', key:'atcCost', format:money},
    {label:'结帐成本', key:'checkoutCost', format:money},
    {label:'加购率', key:'atcRate', format:v=>pct(v)},
    {label:'结帐率', key:'checkoutRate', format:v=>pct(v)},
    {label:'展示', key:'impr', format:v=>fmt(v,0)},
    {label:'点击', key:'clicks', format:v=>fmt(v,0)}
  ];
  const sortedRows = getSortedRows('dailyTable', rows, columns);
  const totalPages = Math.max(1, Math.ceil(rows.length / dailyPageSize));
  if (dailyPage > totalPages) dailyPage = totalPages;
  if (dailyPage < 1) dailyPage = 1;
  const start = (dailyPage - 1) * dailyPageSize;
  const pageRows = sortedRows.slice(start, start + dailyPageSize);
  renderTable('dailyTable', pageRows, columns, dailyPageSize, {skipSort:true});

  const pager = document.getElementById('dailyPager');
  if (!pager) return;
  const status = `<span class="small">第 ${dailyPage} / ${totalPages} 页</span>`;
  const buttons = `
    <button class="pill-btn" data-page="prev" ${dailyPage===1?'disabled':''}>上一页</button>
    <button class="pill-btn" data-page="next" ${dailyPage===totalPages?'disabled':''}>下一页</button>
  `;
  const sizeGroup = pager.querySelector('.filter-group');
  pager.innerHTML = '';
  if (sizeGroup) pager.appendChild(sizeGroup);
  pager.insertAdjacentHTML('beforeend', status + buttons);
}

function formatWeekCodeYYMMDD(d) {
  const yy = String(d.getFullYear()).slice(-2);
  const mm = String(d.getMonth() + 1).padStart(2, '0');
  const dd = String(d.getDate()).padStart(2, '0');
  return `${yy}${mm}${dd}`;
}

function renderWeeklyNewAdsBoard() {
  const section = document.getElementById('weeklyNewAdsSection');
  const tableEl = document.getElementById('weeklyNewAdsTable');
  const statsEl = document.getElementById('weeklyNewAdsStats');
  const summaryBar = document.getElementById('weeklyNewAdsSummaryBar');
  if (!section || !tableEl || !statsEl) return;

  const dayBtn = dayButtons?.querySelector('.pill-btn.active');
  const dayKey = dayBtn ? dayBtn.getAttribute('data-day') : 'ALL';
  const isWeekAll = !dayKey || dayKey === 'ALL';
  const isVisible = (
    dashboardView === 'perf' &&
    timeMode.value === 'week' &&
    !isCustomRange() &&
    !!weekSelect.value &&
    weekSelect.value !== 'MONTH' &&
    isWeekAll
  );
  if (!isVisible) {
    section.classList.add('hidden');
    tableEl.innerHTML = '';
    statsEl.innerHTML = '';
    if (summaryBar) summaryBar.innerHTML = '';
    return;
  }

  const [ws, we] = weekRangeFromKey(weekSelect.value);
  const weekRowsBase = filterRowsByRange(ws, we); // ignore day buttons; only top filters
  const codeSet = new Set();
  const n = (v) => (isFinite(v) ? Number(v) : 0);
  for (let d = new Date(ws); d <= we; d.setDate(d.getDate() + 1)) {
    codeSet.add(formatWeekCodeYYMMDD(d));
  }

  const isNewCampaign = (name) => {
    const codes = String(name || '').match(/\d{6}/g) || [];
    return codes.some(c => codeSet.has(c));
  };

  const newRows = weekRowsBase.filter(r => isNewCampaign(r.campaign));
  const byCampaign = groupBy(newRows, r => r.campaign);
  let campRows = Array.from(byCampaign.entries()).map(([camp, rs]) => {
    const a = aggregate(rs);
    return {
      name: camp,
      category: rs[0]?.category || 'Other',
      adType: rs[0]?.adType || 'Unknown',
      material: (rs[0]?.material || 'unknown').toUpperCase(),
      spend: a.spend,
      conv: a.conv,
      roas: a.roas,
      purchases: a.purchases,
      aov: a.aov,
      cpa: a.cpa,
      ctr: a.ctr,
      cpc: a.cpc,
      cpm: a.cpm,
      cvr: a.cvr,
      atcCost: a.atcCost,
      checkoutCost: a.checkoutCost,
      atcRate: a.atcRate,
      checkoutRate: a.checkoutRate
    };
  });

  const totalCampaigns = campRows.length;
  const soldCampaigns = campRows.filter(r => (r.purchases || 0) > 0).length;
  const soldRate = totalCampaigns ? (soldCampaigns / totalCampaigns) : 0;
  const highRoasCount = campRows.filter(r => (r.roas || 0) >= 2).length;
  const highSpendUnsoldCount = campRows.filter(r => (r.spend || 0) >= 50 && (r.purchases || 0) <= 0).length;
  const topGroupBy = (key) => {
    const m = new Map();
    for (const r of campRows) {
      const k = r[key] || 'Unknown';
      if (!m.has(k)) m.set(k, { spend:0, conv:0 });
      const v = m.get(k); v.spend += r.spend || 0; v.conv += r.conv || 0;
    }
    let best = null;
    for (const [k,v] of m.entries()) {
      const roas = v.spend ? v.conv / v.spend : 0;
      if (!best || roas > best.roas) best = { name:k, spend:v.spend, roas };
    }
    return best;
  };
  const topCat = topGroupBy('category');
  const topAdt = topGroupBy('adType');
  statsEl.innerHTML = ``;
  const soldRateCls = soldRate >= 0.4 ? 'metric-good' : (soldRate >= 0.2 ? 'metric-mid' : 'metric-low');
  const topCatCls = (topCat?.roas || 0) >= 2 ? 'metric-good' : ((topCat?.roas || 0) >= 1 ? 'metric-mid' : 'metric-low');
  const topAdtCls = (topAdt?.roas || 0) >= 2 ? 'metric-good' : ((topAdt?.roas || 0) >= 1 ? 'metric-mid' : 'metric-low');
  if (summaryBar) {
    summaryBar.innerHTML = [
      {k:'上新总数', v: fmt(totalCampaigns,0), s:''},
      {k:'出单数 / 出单率', v: `${fmt(soldCampaigns,0)} <span class="metric-accent ${soldRateCls}">${pct(soldRate)}</span>`, s:''},
      {k:'Top品类', v: topCat ? topCat.name : '-', s: topCat ? `ROAS <span class="${topCatCls}">${fmt(topCat.roas,2)}</span>` : ''},
      {k:'Top广告类型', v: topAdt ? topAdt.name : '-', s: topAdt ? `ROAS <span class="${topAdtCls}">${fmt(topAdt.roas,2)}</span>` : ''}
    ].map(x => `<div class="weekly-summary-card"><div class="k">${x.k}</div><div class="v">${x.v}</div><div class="s">${x.s||''}</div></div>`).join('');
  }

  const vm = weeklyNewAdsViewModeSelect?.value || weeklyNewAdsViewModeState || 'all';
  weeklyNewAdsViewModeState = vm;
  const applyViewFilter = (r) => {
    if (vm === 'sold') return (r.purchases || 0) > 0;
    if (vm === 'unsold') return (r.purchases || 0) <= 0;
    if (vm === 'high_roas') return (r.roas || 0) >= 2;
    return true;
  };
  campRows = campRows.filter(applyViewFilter);

  const columns = [
    {label:'Campaign', key:'name', format:v=>v},
    {label:'花费', key:'spend', format:money},
    {label:'转化金额', key:'conv', format:money},
    {label:'ROAS', key:'roas', format:v=>fmt(v,2)},
    {label:'订单', key:'purchases', format:v=>fmt(v,0)},
    {label:'客单价', key:'aov', format:money},
    {label:'CPA', key:'cpa', format:money},
    {label:'CTR', key:'ctr', format:v=>pct(v)},
    {label:'CPC', key:'cpc', format:money},
    {label:'CPM', key:'cpm', format:money},
    {label:'转化率', key:'cvr', format:v=>pct(v)},
    {label:'加购成本', key:'atcCost', format:money},
    {label:'结帐成本', key:'checkoutCost', format:money},
    {label:'加购率', key:'atcRate', format:v=>pct(v)},
    {label:'结帐率', key:'checkoutRate', format:v=>pct(v)}
  ];

  const sortedRows = getSortedRows('weeklyNewAdsTable', campRows, columns);
  const totalAgg = aggregate(newRows.filter(r => applyViewFilter({
    spend:n(r.spend), conv:n(r.conv), roas:n(r.spend)?(n(r.conv)/n(r.spend)):0, purchases:n(r.purchases)
  })));
  const totalRow = {
    name: 'Total',
    spend: totalAgg.spend, conv: totalAgg.conv, roas: totalAgg.roas, purchases: totalAgg.purchases,
    aov: totalAgg.aov, cpa: totalAgg.cpa, ctr: totalAgg.ctr, cpc: totalAgg.cpc, cpm: totalAgg.cpm, cvr: totalAgg.cvr,
    atcCost: totalAgg.atcCost, checkoutCost: totalAgg.checkoutCost, atcRate: totalAgg.atcRate, checkoutRate: totalAgg.checkoutRate,
    _total: true
  };

  const st = tableSortState['weeklyNewAdsTable'] || {key:null, dir:'desc'};
  const header = `<tr>${columns.map(c => {
    const isSortable = c.sortable !== false;
    const active = st.key === c.key;
    const ind = active ? (st.dir === 'asc' ? '▲' : '▼') : '';
    return `<th class="${isSortable ? 'sortable' : ''}" ${isSortable ? `data-key="${c.key}"` : ''}>${c.label}${isSortable ? `<span class="sort-ind">${ind}</span>` : ''}</th>`;
  }).join('')}</tr>`;
  const gm = weeklyNewAdsGroupModeSelect?.value || weeklyNewAdsGroupModeState || 'none';
  weeklyNewAdsGroupModeState = gm;
  const groupLabel = (k, v) => {
    if (k === 'category') return `品类：${v}`;
    if (k === 'adType') return `广告类型：${v}`;
    if (k === 'material') return `素材类型：${v}`;
    return v;
  };
  let bodyRows = '';
  if (gm === 'none') {
    bodyRows = sortedRows.map(r => `<tr>${columns.map(c => `<td>${c.format(r[c.key], r)}</td>`).join('')}</tr>`).join('');
  } else {
    const grouped = groupBy(sortedRows, r => r[gm] || 'Unknown');
    const groups = Array.from(grouped.entries()).map(([g, rs]) => {
      const a = aggregate(rs.map(x => ({
        spend:x.spend, conv:x.conv, purchases:x.purchases, impr:0, clicks:0,
        add_to_cart:0, checkouts:0
      })));
      // preserve extra metrics from campaign rows by manual weighted calc
      const summary = {
        name: groupLabel(gm, g),
        spend: rs.reduce((s,x)=>s+(x.spend||0),0),
        conv: rs.reduce((s,x)=>s+(x.conv||0),0),
        purchases: rs.reduce((s,x)=>s+(x.purchases||0),0),
        ctr: rs.reduce((s,x)=>s+(x.ctr||0)*(x.spend||0),0) / Math.max(rs.reduce((s,x)=>s+(x.spend||0),0), 1),
        cpc: rs.reduce((s,x)=>s+(x.cpc||0)*(x.spend||0),0) / Math.max(rs.reduce((s,x)=>s+(x.spend||0),0), 1),
        cpm: rs.reduce((s,x)=>s+(x.cpm||0)*(x.spend||0),0) / Math.max(rs.reduce((s,x)=>s+(x.spend||0),0), 1),
        cvr: rs.reduce((s,x)=>s+(x.cvr||0)*(x.purchases||0 || 1),0) / Math.max(rs.reduce((s,x)=>s+((x.purchases||0) || 1),0), 1),
        atcCost: rs.reduce((s,x)=>s+(x.atcCost||0)*(x.spend||0),0) / Math.max(rs.reduce((s,x)=>s+(x.spend||0),0), 1),
        checkoutCost: rs.reduce((s,x)=>s+(x.checkoutCost||0)*(x.spend||0),0) / Math.max(rs.reduce((s,x)=>s+(x.spend||0),0), 1),
        atcRate: rs.reduce((s,x)=>s+(x.atcRate||0)*(x.spend||0),0) / Math.max(rs.reduce((s,x)=>s+(x.spend||0),0), 1),
        checkoutRate: rs.reduce((s,x)=>s+(x.checkoutRate||0)*(x.spend||0),0) / Math.max(rs.reduce((s,x)=>s+(x.spend||0),0), 1),
      };
      summary.roas = summary.spend ? summary.conv / summary.spend : 0;
      summary.aov = summary.purchases ? summary.conv / summary.purchases : 0;
      summary.cpa = summary.purchases ? summary.spend / summary.purchases : 0;
      return { g, rows: rs, summary };
    }).sort((a,b)=> {
      const key = tableSortState['weeklyNewAdsTable']?.key || 'spend';
      const dir = (tableSortState['weeklyNewAdsTable']?.dir || 'desc') === 'asc' ? 1 : -1;
      const va = a.summary[key];
      const vb = b.summary[key];
      if (typeof va === 'string' || typeof vb === 'string') return String(va||'').localeCompare(String(vb||'')) * dir;
      return (((va||0) - (vb||0)) * dir);
    });
    bodyRows = groups.map(({g, rows:grs, summary}) => {
      const open = weeklyNewAdsExpandedGroups.has(g);
      const groupRow = `<tr class="group-row" data-weekly-group="${String(g).replace(/"/g,'&quot;')}">${columns.map((c, idx) => {
        if (idx === 0) return `<td><span class="toggle">${open ? '▾' : '▸'}</span>${summary.name}</td>`;
        return `<td>${c.format(summary[c.key], summary)}</td>`;
      }).join('')}</tr>`;
      const children = open ? grs.map(r => `<tr class="child-row">${columns.map(c => `<td>${c.format(r[c.key], r)}</td>`).join('')}</tr>`).join('') : '';
      return groupRow + children;
    }).join('');
  }
  const totalHtml = `<tr style="font-weight:700; background:#f8f2ea;">${columns.map(c => `<td>${c.format(totalRow[c.key], totalRow)}</td>`).join('')}</tr>`;
  tableEl.innerHTML = header + bodyRows + totalHtml;
  tableEl.querySelectorAll('tr.group-row').forEach(tr => tr.addEventListener('click', () => {
    const g = tr.getAttribute('data-weekly-group') || '';
    if (!g) return;
    if (weeklyNewAdsExpandedGroups.has(g)) weeklyNewAdsExpandedGroups.delete(g);
    else weeklyNewAdsExpandedGroups.add(g);
    renderWeeklyNewAdsBoard();
  }));
  attachDecisionColResize('weeklyNewAdsTable', '--weekly-newads-camp-col', 260, 760, document.documentElement);
  section.classList.remove('hidden');
}

function bindDailyPager() {
  const pager = document.getElementById('dailyPager');
  if (!pager) return;
  pager.onclick = (e) => {
    const btn = e.target.closest('button');
    if (!btn) return;
    const dir = btn.getAttribute('data-page');
    if (dir === 'prev') dailyPage -= 1;
    if (dir === 'next') dailyPage += 1;
    updateAll(false);
  };
}

function bindSortableTables() {
  for (const id of SORTABLE_TABLE_IDS) {
    const table = document.getElementById(id);
    if (!table) continue;
    table.addEventListener('click', (e) => {
      const th = e.target.closest('th.sortable');
      if (!th || !th.dataset.key) return;
      const cur = tableSortState[id] || {key:null, dir:'desc'};
      if (cur.key === th.dataset.key) {
        cur.dir = cur.dir === 'asc' ? 'desc' : 'asc';
      } else {
        cur.key = th.dataset.key;
        cur.dir = 'desc';
      }
      tableSortState[id] = cur;
      updateAll(false);
    });
  }
}

function bindProductTable() {
  const table = document.getElementById('productTable');
  if (table) {
    table.addEventListener('click', (e) => {
      const th = e.target.closest('th.sortable');
      if (th && th.dataset.key) {
        if (productSortKey === th.dataset.key) {
          productSortDir = productSortDir === 'asc' ? 'desc' : 'asc';
        } else {
          productSortKey = th.dataset.key;
          productSortDir = 'desc';
        }
        updateAll(false);
        return;
      }
      const img = e.target.closest('img.product-thumb');
      if (img && img.dataset.img) {
        const modal = document.getElementById('imgModal');
        const modalImg = document.getElementById('imgModalImg');
        if (modal && modalImg) {
          modalImg.src = img.dataset.img;
          modal.classList.add('active');
        }
      }
    });
  }
  const pager = document.getElementById('productPager');
  if (pager) {
    pager.onclick = (e) => {
      const btn = e.target.closest('button');
      if (!btn) return;
      const dir = btn.getAttribute('data-page');
      if (dir === 'prev') productPage -= 1;
      if (dir === 'next') productPage += 1;
      updateAll(false);
    };
  }
  if (productCategorySelect) {
    productCategorySelect.addEventListener('change', () => {
      productCategory = productCategorySelect.value || 'ALL';
      productPage = 1;
      updateFilterHighlights();
      updateAll(false);
    });
  }
  if (productPageSizeSelect) {
    productPageSizeSelect.addEventListener('change', () => {
      productPageSize = productPageSizeSelect.value === 'all' ? 'all' : (parseInt(productPageSizeSelect.value, 10) || 15);
      productPage = 1;
      updateFilterHighlights();
      updateAll(false);
    });
  }
  if (productCompareSelect) {
    productCompareSelect.addEventListener('change', () => {
      productCompareMode = productCompareSelect.value || 'off';
      updateFilterHighlights();
      updateAll(false);
    });
  }
  if (productSearchInput) {
    productSearchInput.addEventListener('input', () => {
      productSearch = productSearchInput.value || '';
      productPage = 1;
      updateAll(false);
    });
  }
  if (productSearchClearBtn) {
    productSearchClearBtn.addEventListener('click', () => {
      productSearch = '';
      if (productSearchInput) productSearchInput.value = '';
      productPage = 1;
      updateAll(false);
    });
  }
  const modal = document.getElementById('imgModal');
  if (modal) {
    modal.addEventListener('click', () => {
      modal.classList.remove('active');
    });
  }
}

function groupBy(rows, keyFn) {
  const map = new Map();
  for (const r of rows) {
    const k = keyFn(r);
    if (!map.has(k)) map.set(k, []);
    map.get(k).push(r);
  }
  return map;
}


function renderProductTable(rowsFiltered) {
  const [curStart, curEnd] = getDateRangeForCurrentFilter();
  const [prevStart, prevEnd] = getPrevRange(curStart, curEnd);
  const byProduct = new Map();
  for (const r of rowsFiltered) {
    if (!r.product_id) continue;
    if (!PRODUCT_MAP[r.product_id]) continue;
    if (!byProduct.has(r.product_id)) byProduct.set(r.product_id, []);
    byProduct.get(r.product_id).push(r);
  }
  let rows = Array.from(byProduct.entries()).map(([productKey, rs]) => {
    const a = aggregate(rs);
    const p = PRODUCT_MAP[productKey] || {};
    return {
      productKey,
      id: String(p.id || ''),
      img: p.image || '',
      cat: p.category || '',
      spend: a.spend,
      conv: a.conv,
      roas: a.roas,
      aov: a.purchases ? (a.conv / a.purchases) : 0,
      cpa: a.purchases ? (a.spend / a.purchases) : 0,
      ctr: a.ctr,
      cpc: a.cpc,
      cpm: a.cpm,
      cvr: a.cvr,
      atcCost: a.atcCost,
      checkoutCost: a.checkoutCost,
      atcRate: a.atcRate,
      checkoutRate: a.checkoutRate,
      purchases: a.purchases,
      skc: String(p.skc || ''),
      shopifyId: String(p.shopify_id || ''),
      shopifySales: 0,
      prev_spend: 0,
      prev_conv: 0,
      prev_roas: 0,
      prev_aov: 0,
      prev_cpa: 0,
      prev_ctr: 0,
      prev_cpc: 0,
      prev_cpm: 0,
      prev_cvr: 0,
      prev_atcCost: 0,
      prev_checkoutCost: 0,
      prev_atcRate: 0,
      prev_checkoutRate: 0,
      prev_purchases: 0,
      prev_shopifySales: 0,
    };
  });

  const prevRowsBase = filterRowsByRange(prevStart, prevEnd);
  const prevMap = new Map();
  for (const r of prevRowsBase) {
    if (!r.product_id) continue;
    if (!PRODUCT_MAP[r.product_id]) continue;
    if (!prevMap.has(r.product_id)) prevMap.set(r.product_id, []);
    prevMap.get(r.product_id).push(r);
  }
  for (const row of rows) {
    const prevAgg = aggregate(prevMap.get(row.productKey) || []);
    row.prev_spend = prevAgg.spend || 0;
    row.prev_conv = prevAgg.conv || 0;
    row.prev_roas = prevAgg.roas || 0;
    row.prev_aov = (prevAgg.purchases||0) ? ((prevAgg.conv||0)/(prevAgg.purchases||0)) : 0;
    row.prev_cpa = (prevAgg.purchases||0) ? ((prevAgg.spend||0)/(prevAgg.purchases||0)) : 0;
    row.prev_ctr = prevAgg.ctr || 0;
    row.prev_cpc = prevAgg.cpc || 0;
    row.prev_cpm = prevAgg.cpm || 0;
    row.prev_cvr = prevAgg.cvr || 0;
    row.prev_atcCost = prevAgg.atcCost || 0;
    row.prev_checkoutCost = prevAgg.checkoutCost || 0;
    row.prev_atcRate = prevAgg.atcRate || 0;
    row.prev_checkoutRate = prevAgg.checkoutRate || 0;
    row.prev_purchases = prevAgg.purchases || 0;
    row.shopifySales = getShopifySalesInRange(row.shopifyId, curStart, curEnd);
    row.prev_shopifySales = getShopifySalesInRange(row.shopifyId, prevStart, prevEnd);
  }

  // category filter options
  const cats = Array.from(new Set(rows.map(r => r.cat).filter(Boolean))).sort();
  const prev = productCategorySelect.value || productCategory;
  productCategorySelect.innerHTML = ['ALL', ...cats].map(c => `<option value="${c}">${c === 'ALL' ? '全部' : c}</option>`).join('');
  if (prev && productCategorySelect.querySelector(`option[value="${prev}"]`)) {
    productCategorySelect.value = prev;
  } else {
    productCategorySelect.value = 'ALL';
  }
  productCategory = productCategorySelect.value;
  if (productCategory !== 'ALL') {
    rows = rows.filter(r => r.cat === productCategory);
  }
  const q = (productSearch || '').trim().toLowerCase();
  if (q) {
    rows = rows.filter(r =>
      String(r.id).toLowerCase().includes(q) ||
      String(r.skc).toLowerCase().includes(q) ||
      String(r.shopifyId).toLowerCase().includes(q)
    );
  }

  const formatWithCompare = (curr, prevVal, formatter) => {
    const base = formatter(curr);
    if (productCompareMode === 'off') return base;
    const p = isFinite(prevVal) ? prevVal : 0;
    const prevText = p === 0 ? '—' : formatter(p);
    let deltaText = '—';
    let deltaCls = 'muted';
    if (p !== 0) {
      const delta = ((curr - p) / p) * 100;
      const arrow = delta >= 0 ? '▲' : '▼';
      deltaCls = delta >= 0 ? 'delta-up' : 'delta-down';
      deltaText = `${arrow} ${Math.abs(delta).toFixed(1)}%`;
    }
    if (productCompareMode === 'prev') {
      return `<div class="metric-stack"><div class="base">${base}</div><div class="sub muted">${prevText}</div></div>`;
    }
    if (productCompareMode === 'delta') {
      return `<div class="metric-stack"><div class="base">${base}</div><div class="sub ${deltaCls}">${deltaText}</div></div>`;
    }
    return `<div class="metric-stack"><div class="base">${base}</div><div class="sub"><span class="muted">${prevText}</span> <span class="muted">|</span> <span class="${deltaCls}">${deltaText}</span></div></div>`;
  };

  const columns = [
    {label:'图片', key:'img', sortable:false, format:v=> v ? `<img class="product-thumb" src="${v}" data-img="${v}" />` : '<span class="muted">—</span>'},
    {label:'商品id', key:'id', sortable:true, format:v=>v},
    {label:'SKC', key:'skc', sortable:true, format:v=>v || '-'},
    {label:'shopify id', key:'shopifyId', sortable:true, format:v=>v || '-'},
    {label:'类目', key:'cat', sortable:true, format:v=>v||'-'},
    {label:'花费', key:'spend', sortable:true, format:(v,row)=>formatWithCompare(v, row.prev_spend, money)},
    {label:'转化金额', key:'conv', sortable:true, format:(v,row)=>formatWithCompare(v, row.prev_conv, money)},
    {label:'ROAS', key:'roas', sortable:true, format:(v,row)=>formatWithCompare(v, row.prev_roas, x=>fmt(x,2))},
    {label:'广告销量', key:'purchases', sortable:true, format:(v,row)=>formatWithCompare(v, row.prev_purchases, x=>fmt(x,0))},
    {label:'shopify 销量', key:'shopifySales', sortable:true, format:(v,row)=>formatWithCompare(v, row.prev_shopifySales, x=>fmt(x,0))},
    {label:'客单价', key:'aov', sortable:true, format:(v,row)=>formatWithCompare(v, row.prev_aov, money)},
    {label:'CPA', key:'cpa', sortable:true, format:(v,row)=>formatWithCompare(v, row.prev_cpa, money)},
    {label:'CTR', key:'ctr', sortable:true, format:(v,row)=>formatWithCompare(v, row.prev_ctr, pct)},
    {label:'CPC', key:'cpc', sortable:true, format:(v,row)=>formatWithCompare(v, row.prev_cpc, money)},
    {label:'CPM', key:'cpm', sortable:true, format:(v,row)=>formatWithCompare(v, row.prev_cpm, money)},
    {label:'转化率', key:'cvr', sortable:true, format:(v,row)=>formatWithCompare(v, row.prev_cvr, pct)},
    {label:'加购成本', key:'atcCost', sortable:true, format:(v,row)=>formatWithCompare(v, row.prev_atcCost, money)},
    {label:'结帐成本', key:'checkoutCost', sortable:true, format:(v,row)=>formatWithCompare(v, row.prev_checkoutCost, money)},
    {label:'加购率', key:'atcRate', sortable:true, format:(v,row)=>formatWithCompare(v, row.prev_atcRate, pct)},
    {label:'结帐率', key:'checkoutRate', sortable:true, format:(v,row)=>formatWithCompare(v, row.prev_checkoutRate, pct)}
  ];

  const col = columns.find(c => c.key === productSortKey) || columns[4];
  const dir = productSortDir === 'asc' ? 1 : -1;
  rows.sort((a,b) => {
    const va = a[col.key];
    const vb = b[col.key];
    if (typeof va === 'string') return va.localeCompare(vb) * dir;
    return ((va||0) - (vb||0)) * dir;
  });

  const pageSize = productPageSize === 'all' ? rows.length : productPageSize;
  const totalPages = Math.max(1, Math.ceil(rows.length / (pageSize || 1)));
  if (productPage > totalPages) productPage = totalPages;
  if (productPage < 1) productPage = 1;
  const start = (productPage - 1) * (pageSize || rows.length);
  const pageRows = rows.slice(start, start + (pageSize || rows.length));

  const el = document.getElementById('productTable');
  if (!el) return;
  const header = `<tr>${columns.map(c => {
    const active = c.key === productSortKey;
    const ind = active ? (productSortDir === 'asc' ? '▲' : '▼') : '';
    const cls = c.sortable ? 'sortable' : '';
    const dataKey = c.sortable ? `data-key="${c.key}"` : '';
    return `<th class="${cls}" ${dataKey}>${c.label}${c.sortable ? `<span class="sort-ind">${ind}</span>` : ''}</th>`;
  }).join('')}</tr>`;
  const body = pageRows.map(r => `<tr>${columns.map(c => `<td>${c.format(r[c.key], r)}</td>`).join('')}</tr>`).join('');
  el.innerHTML = header + body;

  const pager = document.getElementById('productPager');
  if (pager) {
    const status = `<span class="small">第 ${productPage} / ${totalPages} 页</span>`;
    const buttons = `
      <button class="pill-btn" data-page="prev" ${productPage===1?'disabled':''}>上一页</button>
      <button class="pill-btn" data-page="next" ${productPage===totalPages?'disabled':''}>下一页</button>
    `;
    const right = `<div class="filter-group">${status}${buttons}</div>`;
    const sizeGroup = pager.querySelector('#productPageSizeGroup');
    pager.innerHTML = '';
    if (sizeGroup) pager.appendChild(sizeGroup);
    pager.insertAdjacentHTML('beforeend', right);
  }
}
function renderTables(rowsFiltered) {
  const showCompareCategory = compareCategory.value;
  const showCompareAudience = compareAudience.value;
  const showCompareMaterial = compareMaterial.value;
  const showCompareAdType = compareAdType.value;
  const [curStart, curEnd] = getDateRangeForCurrentFilter();
  const [prevStart, prevEnd] = getPrevRange(curStart, curEnd);
  const prevRowsBase = filterRowsByRange(prevStart, prevEnd);

  const compareSuffix = (curr, prev, formatter, mode) => {
    if (mode === 'off') return '';
    const p = isFinite(prev) ? prev : 0;
    if (mode === 'prev') {
      return `<div class="compare-line">${p === 0 ? '—' : formatter(p)}</div>`;
    }
    if (p === 0) return `<div class="compare-line muted">—</div>`;
    const delta = ((curr - p) / p) * 100;
    const arrow = delta >= 0 ? '▲' : '▼';
    const cls = delta >= 0 ? 'delta-up' : 'delta-down';
    if (mode === 'delta') return `<div class="compare-line ${cls}">${arrow} ${Math.abs(delta).toFixed(1)}%</div>`;
    return `<div class="compare-line"><span class="muted">${formatter(p)}</span> <span class="muted">|</span> <span class="${cls}">${arrow} ${Math.abs(delta).toFixed(1)}%</span></div>`;
  };

  const formatWithCompare = (curr, prev, formatter, mode) => {
    const cur = formatter(curr);
    return `${cur}${compareSuffix(curr, prev, formatter, mode)}`;
  };

  const compareSuffixStack = (curr, prev, formatter, mode) => {
    if (mode === 'off') return '';
    const p = isFinite(prev) ? prev : 0;
    if (mode === 'prev') return `<div class="compare-line">${p === 0 ? '—' : formatter(p)}</div>`;
    if (p === 0) return `<div class="compare-line muted">—</div>`;
    const delta = ((curr - p) / p) * 100;
    const arrow = delta >= 0 ? '▲' : '▼';
    const cls = delta >= 0 ? 'delta-up' : 'delta-down';
    const deltaLine = `<div class="compare-line ${cls}">${arrow} ${Math.abs(delta).toFixed(1)}%</div>`;
    if (mode === 'delta') return deltaLine;
    return `<div class="compare-line muted">${formatter(p)}</div>${deltaLine}`;
  };

  const formatWithCompareStack = (curr, prev, formatter, mode) => {
    const cur = formatter(curr);
    return `${cur}${compareSuffixStack(curr, prev, formatter, mode)}`;
  };

  const buildPrevMap = (keyFn) => {
    const map = new Map();
    for (const r of prevRowsBase) {
      const k = keyFn(r);
      if (!map.has(k)) map.set(k, []);
      map.get(k).push(r);
    }
    const out = new Map();
    for (const [k, rs] of map.entries()) out.set(k, aggregate(rs));
    return out;
  };

  const markTop = (rows, disable) => {
    if (disable) {
      return rows.map(r => ({...r, _isTop: false}));
    }
    const max = Math.max(...rows.map(r => r.roas || 0));
    return rows.map(r => ({
      ...r,
      _isTop: r.roas === max && max > 0
    }));
  };

  // Category or IP view
  const catFilter = categorySelect.value;
  if (categoryMode.value === 'ip') {
    const ipMap = groupBy(rowsFiltered.filter(r=>r.category==='IP'), r => r.ipGroup);
    const ipPrev = buildPrevMap(r => r.ipGroup);
    const ipRows = Array.from(ipMap.entries()).map(([k, rs]) => {
      const a=aggregate(rs);
      const p=ipPrev.get(k) || {};
      const name = (k === 'IP' || k === 'IP-IP') ? 'IP-All' : k;
      return {name, spend:a.spend, conv:a.conv, roas:a.roas, aov:a.aov, cpa:a.cpa, ctr:a.ctr, cpc:a.cpc, cpm:a.cpm, cvr:a.cvr, purchases:a.purchases,
        atcCost:a.atcCost, checkoutCost:a.checkoutCost, atcRate:a.atcRate, checkoutRate:a.checkoutRate,
        prev_spend:p.spend||0, prev_conv:p.conv||0, prev_roas:p.roas||0, prev_aov:p.aov||0, prev_cpa:p.cpa||0, prev_ctr:p.ctr||0, prev_cpc:p.cpc||0, prev_cpm:p.cpm||0, prev_cvr:p.cvr||0, prev_purchases:p.purchases||0,
        prev_atcCost:p.atcCost||0, prev_checkoutCost:p.checkoutCost||0, prev_atcRate:p.atcRate||0, prev_checkoutRate:p.checkoutRate||0};
    }).sort((a,b)=>b.spend-a.spend);
    const ipRowsMarked = markTop(ipRows, showCompareCategory !== 'off');
    renderTable('categoryTable', ipRowsMarked, [
      {label:'IP', key:'name', format:(v,row)=>row._isTop ? `${v}<span class="crown">👑</span>` : v},
      {label:'花费', key:'spend', format:(v,row)=>formatWithCompare(v,row.prev_spend,money,showCompareCategory)},
      {label:'转化金额', key:'conv', format:(v,row)=>formatWithCompare(v,row.prev_conv,money,showCompareCategory)},
      {label:'ROAS', key:'roas', format:(v,row)=> {
        const base = row._isTop ? `<span class="roas-top">${fmt(v,2)}</span>` : fmt(v,2);
        return `${base}${compareSuffix(v,row.prev_roas,v=>fmt(v,2),showCompareCategory)}`;
      }},
      {label:'订单', key:'purchases', format:(v,row)=>formatWithCompare(v,row.prev_purchases,x=>fmt(x,0),showCompareCategory)},
      {label:'客单价', key:'aov', format:(v,row)=>formatWithCompare(v,row.prev_aov,money,showCompareCategory)},
      {label:'CPA', key:'cpa', format:(v,row)=>formatWithCompare(v,row.prev_cpa,money,showCompareCategory)},
      {label:'CTR', key:'ctr', format:(v,row)=>formatWithCompare(v,row.prev_ctr,pct,showCompareCategory)},
      {label:'CPC', key:'cpc', format:(v,row)=>formatWithCompare(v,row.prev_cpc,money,showCompareCategory)},
      {label:'CPM', key:'cpm', format:(v,row)=>formatWithCompare(v,row.prev_cpm,money,showCompareCategory)},
      {label:'转化率', key:'cvr', format:(v,row)=>formatWithCompare(v,row.prev_cvr,pct,showCompareCategory)},
      {label:'加购成本', key:'atcCost', format:(v,row)=>formatWithCompare(v,row.prev_atcCost,money,showCompareCategory)},
      {label:'结帐成本', key:'checkoutCost', format:(v,row)=>formatWithCompare(v,row.prev_checkoutCost,money,showCompareCategory)},
      {label:'加购率', key:'atcRate', format:(v,row)=>formatWithCompare(v,row.prev_atcRate,pct,showCompareCategory)},
      {label:'结帐率', key:'checkoutRate', format:(v,row)=>formatWithCompare(v,row.prev_checkoutRate,pct,showCompareCategory)}
    ], 20);
  } else {
    const catMap = catFilter === 'ALL'
      ? groupBy(rowsFiltered, r => r.category)
      : groupBy(rowsFiltered.filter(r => r.category === catFilter), r => r.category);
    const catPrev = buildPrevMap(r => r.category);
    const catRows = Array.from(catMap.entries()).map(([k, rs]) => {
      const a = aggregate(rs);
      const p = catPrev.get(k) || {};
      return {name:k, spend:a.spend, conv:a.conv, roas:a.roas, aov:a.aov, cpa:a.cpa, ctr:a.ctr, cpc:a.cpc, cpm:a.cpm, cvr:a.cvr, purchases:a.purchases,
        atcCost:a.atcCost, checkoutCost:a.checkoutCost, atcRate:a.atcRate, checkoutRate:a.checkoutRate,
        prev_spend:p.spend||0, prev_conv:p.conv||0, prev_roas:p.roas||0, prev_aov:p.aov||0, prev_cpa:p.cpa||0, prev_ctr:p.ctr||0, prev_cpc:p.cpc||0, prev_cpm:p.cpm||0, prev_cvr:p.cvr||0, prev_purchases:p.purchases||0,
        prev_atcCost:p.atcCost||0, prev_checkoutCost:p.checkoutCost||0, prev_atcRate:p.atcRate||0, prev_checkoutRate:p.checkoutRate||0};
    }).sort((a,b)=>b.spend-a.spend);
    const catRowsMarked = markTop(catRows, showCompareCategory !== 'off');
    renderTable('categoryTable', catRowsMarked, [
      {label: '品类', key:'name', format:(v,row)=>row._isTop ? `${v}<span class="crown">👑</span>` : v},
      {label:'花费', key:'spend', format:(v,row)=>formatWithCompare(v,row.prev_spend,money,showCompareCategory)},
      {label:'转化金额', key:'conv', format:(v,row)=>formatWithCompare(v,row.prev_conv,money,showCompareCategory)},
      {label:'ROAS', key:'roas', format:(v,row)=> {
        const base = row._isTop ? `<span class="roas-top">${fmt(v,2)}</span>` : fmt(v,2);
        return `${base}${compareSuffix(v,row.prev_roas,v=>fmt(v,2),showCompareCategory)}`;
      }},
      {label:'订单', key:'purchases', format:(v,row)=>formatWithCompare(v,row.prev_purchases,x=>fmt(x,0),showCompareCategory)},
      {label:'客单价', key:'aov', format:(v,row)=>formatWithCompare(v,row.prev_aov,money,showCompareCategory)},
      {label:'CPA', key:'cpa', format:(v,row)=>formatWithCompare(v,row.prev_cpa,money,showCompareCategory)},
      {label:'CTR', key:'ctr', format:(v,row)=>formatWithCompare(v,row.prev_ctr,pct,showCompareCategory)},
      {label:'CPC', key:'cpc', format:(v,row)=>formatWithCompare(v,row.prev_cpc,money,showCompareCategory)},
      {label:'CPM', key:'cpm', format:(v,row)=>formatWithCompare(v,row.prev_cpm,money,showCompareCategory)},
      {label:'转化率', key:'cvr', format:(v,row)=>formatWithCompare(v,row.prev_cvr,pct,showCompareCategory)},
      {label:'加购成本', key:'atcCost', format:(v,row)=>formatWithCompare(v,row.prev_atcCost,money,showCompareCategory)},
      {label:'结帐成本', key:'checkoutCost', format:(v,row)=>formatWithCompare(v,row.prev_checkoutCost,money,showCompareCategory)},
      {label:'加购率', key:'atcRate', format:(v,row)=>formatWithCompare(v,row.prev_atcRate,pct,showCompareCategory)},
      {label:'结帐率', key:'checkoutRate', format:(v,row)=>formatWithCompare(v,row.prev_checkoutRate,pct,showCompareCategory)}
    ], 20);
  }

  // Material drilldown by Ad Type
  const matFilter = materialSelect.value;
  const matMap = matFilter === 'ALL'
    ? groupBy(rowsFiltered, r => r.material)
    : groupBy(rowsFiltered.filter(r => r.material === matFilter), r => r.material);
  const matPrev = buildPrevMap(r => r.material);
  const matRows = Array.from(matMap.entries()).map(([k, rs]) => {
    const a=aggregate(rs);
    const p=matPrev.get(k) || {};
    return {name:k, spend:a.spend, conv:a.conv, roas:a.roas, aov:a.aov, cpa:a.cpa, ctr:a.ctr, cpc:a.cpc, cpm:a.cpm, atcCost:a.atcCost, checkoutCost:a.checkoutCost, atcRate:a.atcRate, checkoutRate:a.checkoutRate,
      prev_spend:p.spend||0, prev_conv:p.conv||0, prev_roas:p.roas||0, prev_aov:p.aov||0, prev_cpa:p.cpa||0, prev_ctr:p.ctr||0, prev_cpc:p.cpc||0, prev_cpm:p.cpm||0, prev_atcCost:p.atcCost||0, prev_checkoutCost:p.checkoutCost||0, prev_atcRate:p.atcRate||0, prev_checkoutRate:p.checkoutRate||0};
  }).sort((a,b)=>b.spend-a.spend);
  const matRowsMarked = markTop(matRows, showCompareMaterial !== 'off').map(r => ({
    ...r,
    name: r.name ? r.name.toUpperCase() : r.name
  }));
  renderTable('materialTable', matRowsMarked, [
    {label: '素材', key:'name', format:(v,row)=>row._isTop ? `${v}<span class="crown">👑</span>` : v},
    {label:'花费', key:'spend', format:(v,row)=>formatWithCompareStack(v,row.prev_spend,money,showCompareMaterial)},
    {label:'转化金额', key:'conv', format:(v,row)=>formatWithCompareStack(v,row.prev_conv,money,showCompareMaterial)},
    {label:'ROAS', key:'roas', format:(v,row)=> {
      const base = row._isTop ? `<span class="roas-top">${fmt(v,2)}</span>` : fmt(v,2);
      return `${base}${compareSuffixStack(v,row.prev_roas,v=>fmt(v,2),showCompareMaterial)}`;
    }},
    {label:'客单价', key:'aov', format:(v,row)=>formatWithCompareStack(v,row.prev_aov,money,showCompareMaterial)},
    {label:'CPA', key:'cpa', format:(v,row)=>formatWithCompareStack(v,row.prev_cpa,money,showCompareMaterial)},
    {label:'CTR', key:'ctr', format:(v,row)=>formatWithCompareStack(v,row.prev_ctr,pct,showCompareMaterial)},
    {label:'CPC', key:'cpc', format:(v,row)=>formatWithCompareStack(v,row.prev_cpc,money,showCompareMaterial)},
    {label:'CPM', key:'cpm', format:(v,row)=>formatWithCompareStack(v,row.prev_cpm,money,showCompareMaterial)},
    {label:'加购成本', key:'atcCost', format:(v,row)=>formatWithCompareStack(v,row.prev_atcCost,money,showCompareMaterial)},
    {label:'结帐成本', key:'checkoutCost', format:(v,row)=>formatWithCompareStack(v,row.prev_checkoutCost,money,showCompareMaterial)},
    {label:'加购率', key:'atcRate', format:(v,row)=>formatWithCompareStack(v,row.prev_atcRate,pct,showCompareMaterial)},
    {label:'结帐率', key:'checkoutRate', format:(v,row)=>formatWithCompareStack(v,row.prev_checkoutRate,pct,showCompareMaterial)}
  ], 10);

  // Ad Type summary (no drilldown when filtered)
  const adFilter = adTypeSelect.value;
  const adMap = adFilter === 'ALL'
    ? groupBy(rowsFiltered, r => r.adType)
    : groupBy(rowsFiltered.filter(r => r.adType === adFilter), r => r.adType);
  const adPrev = buildPrevMap(r => r.adType);
  const adRows = Array.from(adMap.entries()).map(([k, rs]) => {
    const a=aggregate(rs);
    const p=adPrev.get(k) || {};
    return {name:k, spend:a.spend, conv:a.conv, roas:a.roas, aov:a.aov, cpa:a.cpa, ctr:a.ctr, cpc:a.cpc, cpm:a.cpm, atcCost:a.atcCost, checkoutCost:a.checkoutCost, atcRate:a.atcRate, checkoutRate:a.checkoutRate,
      prev_spend:p.spend||0, prev_conv:p.conv||0, prev_roas:p.roas||0, prev_aov:p.aov||0, prev_cpa:p.cpa||0, prev_ctr:p.ctr||0, prev_cpc:p.cpc||0, prev_cpm:p.cpm||0, prev_atcCost:p.atcCost||0, prev_checkoutCost:p.checkoutCost||0, prev_atcRate:p.atcRate||0, prev_checkoutRate:p.checkoutRate||0};
  }).sort((a,b)=>b.spend-a.spend);
  const adRowsMarked = markTop(adRows, showCompareAdType !== 'off');
  renderTable('adTypeTable', adRowsMarked, [
    {label: '广告', key:'name', format:(v,row)=>row._isTop ? `${v}<span class="crown">👑</span>` : v},
    {label:'花费', key:'spend', format:(v,row)=>formatWithCompareStack(v,row.prev_spend,money,showCompareAdType)},
    {label:'转化金额', key:'conv', format:(v,row)=>formatWithCompareStack(v,row.prev_conv,money,showCompareAdType)},
    {label:'ROAS', key:'roas', format:(v,row)=> {
      const base = row._isTop ? `<span class="roas-top">${fmt(v,2)}</span>` : fmt(v,2);
      return `${base}${compareSuffixStack(v,row.prev_roas,v=>fmt(v,2),showCompareAdType)}`;
    }},
    {label:'客单价', key:'aov', format:(v,row)=>formatWithCompareStack(v,row.prev_aov,money,showCompareAdType)},
    {label:'CPA', key:'cpa', format:(v,row)=>formatWithCompareStack(v,row.prev_cpa,money,showCompareAdType)},
    {label:'CTR', key:'ctr', format:(v,row)=>formatWithCompareStack(v,row.prev_ctr,pct,showCompareAdType)},
    {label:'CPC', key:'cpc', format:(v,row)=>formatWithCompareStack(v,row.prev_cpc,money,showCompareAdType)},
    {label:'CPM', key:'cpm', format:(v,row)=>formatWithCompareStack(v,row.prev_cpm,money,showCompareAdType)},
    {label:'加购成本', key:'atcCost', format:(v,row)=>formatWithCompareStack(v,row.prev_atcCost,money,showCompareAdType)},
    {label:'结帐成本', key:'checkoutCost', format:(v,row)=>formatWithCompareStack(v,row.prev_checkoutCost,money,showCompareAdType)},
    {label:'加购率', key:'atcRate', format:(v,row)=>formatWithCompareStack(v,row.prev_atcRate,pct,showCompareAdType)},
    {label:'结帐率', key:'checkoutRate', format:(v,row)=>formatWithCompareStack(v,row.prev_checkoutRate,pct,showCompareAdType)}
  ], 16);

  const audMap = groupBy(rowsFiltered, r => r.audience);
  const audPrev = buildPrevMap(r => r.audience);
  const audRows = Array.from(audMap.entries()).filter(([k]) => k !== 'Uncategorized').map(([k, rs]) => {
    const a=aggregate(rs);
    const p=audPrev.get(k) || {};
    return {name:k, spend:a.spend, conv:a.conv, roas:a.roas, aov:a.aov, cpa:a.cpa, ctr:a.ctr, cpc:a.cpc, cpm:a.cpm, atcCost:a.atcCost, checkoutCost:a.checkoutCost, atcRate:a.atcRate, checkoutRate:a.checkoutRate,
      prev_spend:p.spend||0, prev_conv:p.conv||0, prev_roas:p.roas||0, prev_aov:p.aov||0, prev_cpa:p.cpa||0, prev_ctr:p.ctr||0, prev_cpc:p.cpc||0, prev_cpm:p.cpm||0, prev_atcCost:p.atcCost||0, prev_checkoutCost:p.checkoutCost||0, prev_atcRate:p.atcRate||0, prev_checkoutRate:p.checkoutRate||0};
  }).sort((a,b)=>b.spend-a.spend);
  const audRowsMarked = markTop(audRows, showCompareAudience !== 'off');
  renderTable('audienceTable', audRowsMarked, [
    {label:'人群', key:'name', format:(v,row)=>row._isTop ? `${v}<span class="crown">👑</span>` : v},
    {label:'花费', key:'spend', format:(v,row)=>formatWithCompareStack(v,row.prev_spend,money,showCompareAudience)},
    {label:'转化金额', key:'conv', format:(v,row)=>formatWithCompareStack(v,row.prev_conv,money,showCompareAudience)},
    {label:'ROAS', key:'roas', format:(v,row)=> {
      const base = row._isTop ? `<span class="roas-top">${fmt(v,2)}</span>` : fmt(v,2);
      return `${base}${compareSuffixStack(v,row.prev_roas,v=>fmt(v,2),showCompareAudience)}`;
    }},
    {label:'客单价', key:'aov', format:(v,row)=>formatWithCompareStack(v,row.prev_aov,money,showCompareAudience)},
    {label:'CPA', key:'cpa', format:(v,row)=>formatWithCompareStack(v,row.prev_cpa,money,showCompareAudience)},
    {label:'CTR', key:'ctr', format:(v,row)=>formatWithCompareStack(v,row.prev_ctr,pct,showCompareAudience)},
    {label:'CPC', key:'cpc', format:(v,row)=>formatWithCompareStack(v,row.prev_cpc,money,showCompareAudience)},
    {label:'CPM', key:'cpm', format:(v,row)=>formatWithCompareStack(v,row.prev_cpm,money,showCompareAudience)},
    {label:'加购成本', key:'atcCost', format:(v,row)=>formatWithCompareStack(v,row.prev_atcCost,money,showCompareAudience)},
    {label:'结帐成本', key:'checkoutCost', format:(v,row)=>formatWithCompareStack(v,row.prev_checkoutCost,money,showCompareAudience)},
    {label:'加购率', key:'atcRate', format:(v,row)=>formatWithCompareStack(v,row.prev_atcRate,pct,showCompareAudience)},
    {label:'结帐率', key:'checkoutRate', format:(v,row)=>formatWithCompareStack(v,row.prev_checkoutRate,pct,showCompareAudience)}
  ], 8);

  // Pies for Ad Type, Audience, Material
  const colors = ['#c76a1f','#1f7a7a','#2b5d9a','#8a5a44','#c9a227','#4b8b3b'];
  const adLabels = adRows.map(r=>r.name);
  const adSpend = adRows.map(r=>r.spend);
  const adConv = adRows.map(r=>r.conv);
  const percentTooltip = (values) => ({
    callbacks: {
      label: (ctx) => {
        const total = values.reduce((a,b)=>a+b,0) || 1;
        const v = ctx.parsed || 0;
        const p = (v/total*100).toFixed(1);
        return `${ctx.label}: ${p}%`;
      }
    }
  });
  const adCtx = document.getElementById('adTypePie')?.getContext('2d');

  const audLabels = audRows.map(r=>r.name);
  const audSpend = audRows.map(r=>r.spend);
  const audConv = audRows.map(r=>r.conv);
  const audCtx = document.getElementById('audiencePie')?.getContext('2d');

  const matMapPie = groupBy(rowsFiltered, r => r.material);
  const matRowsPie = Array.from(matMapPie.entries()).map(([k, rs]) => {
    const a=aggregate(rs); return {name:k, spend:a.spend, conv:a.conv};
  }).sort((a,b)=>b.spend-a.spend);
  const matLabels = matRowsPie.map(r=> (r.name ? r.name.toUpperCase() : r.name));
  const matSpend = matRowsPie.map(r=>r.spend);
  const matConv = matRowsPie.map(r=>r.conv);
  const matCtx = document.getElementById('materialPie')?.getContext('2d');

  const metric = pieMetric.value;
  const useAd = metric === 'spend' ? adSpend : adConv;
  const useAud = metric === 'spend' ? audSpend : audConv;
  const useMat = metric === 'spend' ? matSpend : matConv;

  if (adCtx) {
    if (adTypePie) adTypePie.destroy();
    adTypePie = new Chart(adCtx, {
      type:'pie',
      data:{labels:adLabels, datasets:[{data:useAd, backgroundColor:colors}]},
      options:{plugins:{
        legend:{position:'right', labels:{font:{size:9}, boxWidth:10, boxHeight:10, padding:6}},
        title:{display:true,text:`广告 ${metric==='spend'?'花费':'转化金额'}`},
        tooltip: percentTooltip(useAd)
      }, maintainAspectRatio:false}
    });
  }
  if (audCtx) {
    if (audiencePie) audiencePie.destroy();
    audiencePie = new Chart(audCtx, {
      type:'pie',
      data:{labels:audLabels, datasets:[{data:useAud, backgroundColor:colors}]},
      options:{plugins:{
        legend:{position:'right', labels:{font:{size:9}, boxWidth:10, boxHeight:10, padding:6}},
        title:{display:true,text:`人群 ${metric==='spend'?'花费':'转化金额'}`},
        tooltip: percentTooltip(useAud)
      }, maintainAspectRatio:false}
    });
  }
  if (matCtx) {
    if (materialPie) materialPie.destroy();
    materialPie = new Chart(matCtx, {
      type:'pie',
      data:{labels:matLabels, datasets:[{data:useMat, backgroundColor:colors}]},
      options:{plugins:{
        legend:{position:'right', labels:{font:{size:9}, boxWidth:10, boxHeight:10, padding:6}},
        title:{display:true,text:`素材 ${metric==='spend'?'花费':'转化金额'}`},
        tooltip: percentTooltip(useMat)
      }, maintainAspectRatio:false}
    });
  }


  const dayMap = groupBy(rowsFiltered, r => r.date);
  const dayRows = Array.from(dayMap.entries()).map(([k, rs]) => {
    const a=aggregate(rs); return {
      name:k, spend:a.spend, conv:a.conv, roas:a.roas, ctr:a.ctr, cpc:a.cpc, cpm:a.cpm,
      cvr:a.cvr, aov:a.aov, cpa:a.cpa, atcCost:a.atcCost, checkoutCost:a.checkoutCost, atcRate:a.atcRate, checkoutRate:a.checkoutRate,
      purchases:a.purchases, impr:a.impr, clicks:a.clicks
    };
  }).sort((a,b)=>a.name.localeCompare(b.name));
  renderDailyTable(dayRows);

}

function renderCombo(rowsFiltered) {
  const makeCombo = (ctx, labels, spend, conv, roas) => {
    return new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [
          { label: '花费', data: spend, backgroundColor: 'rgba(199,106,31,0.65)', borderRadius: 6 },
          { label: '转化金额', data: conv, backgroundColor: 'rgba(31,122,122,0.65)', borderRadius: 6 },
          { label: 'ROAS', data: roas, type: 'line', borderColor: '#2b5d9a', backgroundColor: '#2b5d9a', yAxisID:'y1', tension:0.35, pointRadius:4, pointStyle:'circle', showLabels: true }
        ]
      },
      options: {
        responsive:true,
        maintainAspectRatio:false,
        scales: {
          y: { beginAtZero:true },
          y1: { beginAtZero:true, position:'right', grid:{drawOnChartArea:false} }
        },
        plugins: { legend: { position:'top', labels:{font:{size:10}, boxWidth:10, boxHeight:10, padding:6} } }
      },
      plugins: [roasLabelPlugin]
    });
  };

  const byAudience = groupBy(rowsFiltered, r => r.audience);
  const audOrder = ['Prospecting','Existing','Engaged'];
  const audLabels = audOrder.filter(k => byAudience.has(k));
  const audSpend = audLabels.map(k => aggregate(byAudience.get(k)).spend);
  const audConv = audLabels.map(k => aggregate(byAudience.get(k)).conv);
  const audRoas = audLabels.map(k => aggregate(byAudience.get(k)).roas);
  const audCtx = document.getElementById('comboAudience')?.getContext('2d');
  if (audCtx) {
    if (comboAudience) comboAudience.destroy();
    comboAudience = makeCombo(audCtx, audLabels, audSpend, audConv, audRoas);
  }

  const byMaterial = groupBy(rowsFiltered, r => r.material.toUpperCase());
  const matLabels = Array.from(byMaterial.keys()).sort();
  const matSpend = matLabels.map(k => aggregate(byMaterial.get(k)).spend);
  const matConv = matLabels.map(k => aggregate(byMaterial.get(k)).conv);
  const matRoas = matLabels.map(k => aggregate(byMaterial.get(k)).roas);
  const matCtx = document.getElementById('comboMaterial')?.getContext('2d');
  if (matCtx) {
    if (comboMaterial) comboMaterial.destroy();
    comboMaterial = makeCombo(matCtx, matLabels, matSpend, matConv, matRoas);
  }

  const byAd = groupBy(rowsFiltered, r => r.adType);
  const adLabels = Array.from(byAd.keys()).sort();
  const adSpend = adLabels.map(k => aggregate(byAd.get(k)).spend);
  const adConv = adLabels.map(k => aggregate(byAd.get(k)).conv);
  const adRoas = adLabels.map(k => aggregate(byAd.get(k)).roas);
  const adCtx = document.getElementById('comboAdType')?.getContext('2d');
  if (adCtx) {
    if (comboAdType) comboAdType.destroy();
    comboAdType = makeCombo(adCtx, adLabels, adSpend, adConv, adRoas);
  }
}



function roasLevelClass(v) {
  const n = Number(v) || 0;
  if (n >= 3) return 'roas-lv-5';
  if (n >= 2) return 'roas-lv-4';
  if (n >= 1) return 'roas-lv-3';
  if (n >= 0.7) return 'roas-lv-2';
  return 'roas-lv-1';
}

function formatWithCompareSimple(curr, prevVal, formatter, mode) {
  const base = formatter(curr);
  if (mode === 'off') return base;
  const p = isFinite(prevVal) ? prevVal : 0;
  const prevText = p === 0 ? '—' : formatter(p);
  let deltaText = '—';
  let deltaCls = 'muted';
  if (p !== 0) {
    const delta = ((curr - p) / p) * 100;
    const arrow = delta >= 0 ? '▲' : '▼';
    deltaCls = delta >= 0 ? 'delta-up' : 'delta-down';
    deltaText = `${arrow} ${Math.abs(delta).toFixed(1)}%`;
  }
  if (mode === 'prev') return `<div class="metric-stack"><div class="base">${base}</div><div class="sub muted">${prevText}</div></div>`;
  if (mode === 'delta') return `<div class="metric-stack"><div class="base">${base}</div><div class="sub ${deltaCls}">${deltaText}</div></div>`;
  return `<div class="metric-stack"><div class="base">${base}</div><div class="sub"><span class="muted">${prevText}</span> <span class="muted">|</span> <span class="${deltaCls}">${deltaText}</span></div></div>`;
}

function renderURLBoard(rowsFiltered) {
  const [curStart, curEnd] = getDateRangeForCurrentFilter();
  const baseRows = urlRows.filter(r => r._date >= curStart && r._date <= curEnd);
  const [prevStart, prevEnd] = getPrevRange(curStart, curEnd);
  const prevRows = urlRows.filter(r => r._date >= prevStart && r._date <= prevEnd);

  const byUrl = groupBy(baseRows, r => r.url);
  let urlAgg = Array.from(byUrl.entries()).map(([url, rs]) => {
    const a = aggregate(rs);
    return {url, ...a};
  });

  const spendMedian = (() => {
    const arr = urlAgg.map(r => r.spend).sort((a,b)=>a-b);
    if (!arr.length) return 0;
    const mid = Math.floor(arr.length/2);
    return arr.length % 2 ? arr[mid] : (arr[mid-1]+arr[mid])/2;
  })();
  const purchasesAvg = urlAgg.length ? urlAgg.reduce((s,r)=>s+(r.purchases||0),0)/urlAgg.length : 0;

  for (const r of urlAgg) {
    r.isWinner = (r.spend >= spendMedian && r.roas >= 2 && r.purchases >= purchasesAvg);
    r.isLoser = (r.spend >= 50 && r.roas < 1);
  }

  const prevByUrl = groupBy(prevRows, r => r.url);
  for (const r of urlAgg) {
    const p = aggregate(prevByUrl.get(r.url) || []);
    r.prev_spend = p.spend || 0;
    r.prev_conv = p.conv || 0;
    r.prev_roas = p.roas || 0;
    r.prev_ctr = p.ctr || 0;
    r.prev_cpc = p.cpc || 0;
    r.prev_cpm = p.cpm || 0;
    r.prev_cvr = p.cvr || 0;
    r.prev_atcCost = p.atcCost || 0;
    r.prev_checkoutCost = p.checkoutCost || 0;
    r.prev_atcRate = p.atcRate || 0;
    r.prev_checkoutRate = p.checkoutRate || 0;
    r.prev_purchases = p.purchases || 0;
  }

  if (urlTag === 'winner') urlAgg = urlAgg.filter(r => r.isWinner);
  if (urlTag === 'loser') urlAgg = urlAgg.filter(r => r.isLoser);
  const q = (urlSearch || '').trim().toLowerCase();
  if (q) urlAgg = urlAgg.filter(r => r.url.toLowerCase().includes(q));

  const columns = [
    {label:'Website URL', key:'url', sortable:true, format:(v,row)=>`<span class="url-link" data-url="${v}">${v}</span>`},
    {label:'标签', key:'tag', sortable:false, format:(v,row)=> row.isWinner ? '<span class="url-tag winner">爆款</span>' : (row.isLoser ? '<span class="url-tag loser">亏损</span>' : '-')},
    {label:'花费', key:'spend', sortable:true, format:(v,row)=>formatWithCompareSimple(v,row.prev_spend,money,urlCompareMode)},
    {label:'转化金额', key:'conv', sortable:true, format:(v,row)=>formatWithCompareSimple(v,row.prev_conv,money,urlCompareMode)},
    {label:'ROAS', key:'roas', sortable:true, format:(v,row)=>`<span class="${roasLevelClass(v)}">${formatWithCompareSimple(v,row.prev_roas,x=>fmt(x,2),urlCompareMode)}</span>`},
    {label:'广告销量', key:'purchases', sortable:true, format:(v,row)=>formatWithCompareSimple(v,row.prev_purchases,x=>fmt(x,0),urlCompareMode)},
    {label:'客单价', key:'aov', sortable:true, format:(v,row)=>formatWithCompareSimple(v,row.prev_aov,money,urlCompareMode)},
    {label:'CPA', key:'cpa', sortable:true, format:(v,row)=>formatWithCompareSimple(v,row.prev_cpa,money,urlCompareMode)},
    {label:'CTR', key:'ctr', sortable:true, format:(v,row)=>formatWithCompareSimple(v,row.prev_ctr,pct,urlCompareMode)},
    {label:'CPC', key:'cpc', sortable:true, format:(v,row)=>formatWithCompareSimple(v,row.prev_cpc,money,urlCompareMode)},
    {label:'CPM', key:'cpm', sortable:true, format:(v,row)=>formatWithCompareSimple(v,row.prev_cpm,money,urlCompareMode)},
    {label:'转化率', key:'cvr', sortable:true, format:(v,row)=>formatWithCompareSimple(v,row.prev_cvr,pct,urlCompareMode)},
    {label:'加购成本', key:'atcCost', sortable:true, format:(v,row)=>formatWithCompareSimple(v,row.prev_atcCost,money,urlCompareMode)},
    {label:'结帐成本', key:'checkoutCost', sortable:true, format:(v,row)=>formatWithCompareSimple(v,row.prev_checkoutCost,money,urlCompareMode)},
    {label:'加购率', key:'atcRate', sortable:true, format:(v,row)=>formatWithCompareSimple(v,row.prev_atcRate,pct,urlCompareMode)},
    {label:'结帐率', key:'checkoutRate', sortable:true, format:(v,row)=>formatWithCompareSimple(v,row.prev_checkoutRate,pct,urlCompareMode)}
  ];

  const dir = urlSortDir === 'asc' ? 1 : -1;
  urlAgg.sort((a,b)=> {
    const va=a[urlSortKey], vb=b[urlSortKey];
    if (typeof va === 'string' || typeof vb === 'string') return String(va||'').localeCompare(String(vb||''))*dir;
    return ((Number(va)||0)-(Number(vb)||0))*dir;
  });

  const pageSize = urlPageSize === 'all' ? urlAgg.length : urlPageSize;
  const totalPages = Math.max(1, Math.ceil(urlAgg.length / (pageSize || 1)));
  if (urlPage > totalPages) urlPage = totalPages;
  if (urlPage < 1) urlPage = 1;
  const start = (urlPage - 1) * (pageSize || urlAgg.length);
  const pageRows = urlAgg.slice(start, start + (pageSize || urlAgg.length));

  const table = document.getElementById('urlTable');
  if (table) {
    const header = `<tr>${columns.map(c => {
      const ind = c.sortable ? ((urlSortKey===c.key)?(urlSortDir==='asc'?'▲':'▼'):'') : '';
      return `<th class="${c.sortable?'sortable':''}" ${c.sortable?`data-key="${c.key}"`:''}>${c.label}${c.sortable?`<span class="sort-ind">${ind}</span>`:''}</th>`;
    }).join('')}</tr>`;
    const body = pageRows.map(r => `<tr>${columns.map(c=>`<td>${c.format(r[c.key],r)}</td>`).join('')}</tr>`).join('');
    table.innerHTML = header + body;
  }

  const pager = document.getElementById('urlPager');
  if (pager) {
    const sizeGroup = pager.querySelector('#urlPageSizeGroup');
    const status = `<span class="small">第 ${urlPage} / ${totalPages} 页</span>`;
    const buttons = `<button class="pill-btn" data-page="prev" ${urlPage===1?'disabled':''}>上一页</button><button class="pill-btn" data-page="next" ${urlPage===totalPages?'disabled':''}>下一页</button>`;
    pager.innerHTML = '';
    if (sizeGroup) pager.appendChild(sizeGroup);
    pager.insertAdjacentHTML('beforeend', `<div class="filter-group">${status}${buttons}</div>`);
  }

  if (selectedUrl && !urlAgg.find(r => r.url === selectedUrl)) {
    selectedUrl = '';
    urlDetailOpen = false;
    urlProductDetailOpen = false;
  }
  renderURLDetail(baseRows);
  renderURLProductDetail(baseRows);
}

function renderUrlProductPageBoard() {
  const table = document.getElementById('urlProdTable');
  const pager = document.getElementById('urlProdPager');
  const section = document.getElementById('urlProductPageSection');
  const meta = document.getElementById('urlProdMeta');
  if (!table || !pager || !section) return;

  // This board is operational mapping only: ignore top time filters and keep Active ads only.
  let base = urlRows.filter(r => String(r.ad_delivery || '').trim().toLowerCase().startsWith('active'));
  base = base.filter(r => String(r.shopify_id || '').trim());
  const allPages = Array.from(new Set(base.map(r => Number(r.page) || 1))).filter(n => n > 0).sort((a,b)=>a-b);
  if (urlProdPageFilter) {
    const prevVal = urlProdPageFilter.value || urlProdPageMode || 'all';
    urlProdPageFilter.innerHTML = [`<option value="all">全部</option>`, ...allPages.map(p => `<option value="${p}">第 ${p} 页</option>`)].join('');
    urlProdPageFilter.value = allPages.map(String).includes(String(prevVal)) || prevVal === 'all' ? String(prevVal) : 'all';
    urlProdPageMode = urlProdPageFilter.value || 'all';
  }
  const latest = base.length ? new Date(Math.max(...base.map(r => r._date?.getTime?.() || 0))) : null;
  if (meta) {
    meta.innerHTML = latest
      ? `说明：仅展示 <span class="active-mark">Active</span> 广告的 URL 商品页码映射；不受顶部时间筛选影响。数据截止：<b>${formatDateLocal(latest)}</b>`
      : `说明：仅展示 <span class="active-mark">Active</span> 广告的 URL 商品页码映射；不受顶部时间筛选影响。`;
  }
  if (!base.length) {
    table.innerHTML = '<tr><td class="muted" style="text-align:left;">暂无 Active 广告的商品页码数据（请检查 Report_URL 中 Ad Delivery 列值）。</td></tr>';
    const sizeGroup = pager.querySelector('#urlProdPageSizeGroup');
    pager.innerHTML = '';
    if (sizeGroup) pager.appendChild(sizeGroup);
    return;
  }

  const map = new Map();
  for (const r of base) {
    const key = [r.campaign||'', r.ad||'', r.shopify_id||'', r.url||'', String(r.page||1)].join('||');
    if (!map.has(key)) map.set(key, []);
    map.get(key).push(r);
  }
  let rowsAgg = Array.from(map.entries()).map(([k, rs]) => {
    const a = aggregate(rs);
    const s = rs[0] || {};
    return {
      campaign: s.campaign || '-',
      ad: s.ad || '-',
      shopifyId: s.shopify_id || '-',
      url: s.url || '-',
      page: Number(s.page) || 1,
      category: s.category || '-',
      adType: s.adType || '-',
      material: (s.material || '').toUpperCase() || '-',
      spend: a.spend,
      conv: a.conv,
      roas: a.roas,
      purchases: a.purchases,
      aov: a.aov,
      cpa: a.cpa
    };
  });

  if (urlProdPageMode !== 'all') {
    const pageNum = parseInt(urlProdPageMode, 10);
    if (isFinite(pageNum)) rowsAgg = rowsAgg.filter(r => (Number(r.page)||1) === pageNum);
  }

  const q = (urlProdSearch || '').trim().toLowerCase();
  if (q) {
    const productByShopifyForSearch = (() => {
      const m = new Map();
      Object.values(PRODUCT_MAP || {}).forEach(p => {
        const sid = String(p?.shopify_id || '').trim();
        if (!sid) return;
        if (!m.has(sid)) m.set(sid, p);
      });
      return m;
    })();
    rowsAgg = rowsAgg.filter(r => {
      const prod = productByShopifyForSearch.get(String(r.shopifyId || '').trim());
      const skc = String(prod?.skc || '').toLowerCase();
      return (
        String(r.ad).toLowerCase().includes(q) ||
        String(r.shopifyId).toLowerCase().includes(q) ||
        String(r.url).toLowerCase().includes(q) ||
        skc.includes(q)
      );
    });
  }

  const productByShopify = (() => {
    const m = new Map();
    Object.values(PRODUCT_MAP || {}).forEach(p => {
      const sid = String(p?.shopify_id || '').trim();
      if (!sid) return;
      if (!m.has(sid)) m.set(sid, p);
    });
    return m;
  })();
  let rowsFinal = [];
  const cols = [
    {label:'URL', key:'url', sortable:true, format:v=>v}
  ];
  const urlMap = groupBy(rowsAgg, r => r.url);
  rowsFinal = Array.from(urlMap.entries()).map(([url, rs]) => {
    const perSid = new Map();
    for (const r of rs) {
      const sid = String(r.shopifyId || '').trim();
      if (!sid) continue;
      if (!perSid.has(sid)) perSid.set(sid, {pages:new Set(), ads:new Set()});
      const v = perSid.get(sid);
      v.pages.add(Number(r.page) || 1);
      v.ads.add(String(r.ad || ''));
    }
    const pageCountMap = new Map();
    for (const v of perSid.values()) {
      for (const p of v.pages) pageCountMap.set(p, (pageCountMap.get(p) || 0) + 1);
    }
    const pageSummary = Array.from(pageCountMap.entries()).sort((a,b)=>a[0]-b[0]).map(([p,c])=>`P${p}×${c}`).join(' | ') || '—';
    const pageGroups = Array.from(pageCountMap.keys()).sort((a,b)=>a-b).map(p => {
      const cards = Array.from(perSid.entries())
        .filter(([,v]) => v.pages.has(p))
        .sort((a,b)=>a[0].localeCompare(b[0]))
        .map(([sid,v]) => {
          const prod = productByShopify.get(sid);
          const img = prod?.image ? `<img class="product-thumb" src="${prod.image}" data-img="${prod.image}" />` : `<div style="width:46px;height:46px;border:1px solid var(--line);border-radius:8px;background:#faf7f2;"></div>`;
          const skc = prod?.skc ? String(prod.skc) : '';
          const adList = Array.from(v.ads).filter(Boolean).sort().map((a,idx)=>`<div><span class="ad-no">${idx+1}.</span>${a}</div>`).join('');
          return `<div class="url-prod-card" data-card="1">${img}<div class="meta"><div class="sid">${sid}</div><div class="sub">${skc || '-'}</div><div class="ads">${adList || '<div class="muted">无广告</div>'}</div></div></div>`;
        }).join('');
      return `<div class="url-prod-page-group"><div class="url-prod-page-title">P${p}</div><div class="url-prod-cards">${cards || '<span class="muted">—</span>'}</div></div>`;
    }).join('');
    return { url, pageSummary, productCount: perSid.size, _detailHtml: pageGroups };
  });
  if (urlProdExpandAllBtn) {
    const allOpen = rowsFinal.length > 0 && rowsFinal.every(r => urlProdExpandedUrls.has(r.url));
    urlProdExpandAllBtn.textContent = allOpen ? '全部收起' : '全部展开';
  }
  const col = cols.find(c => c.key === urlProdSortKey && c.sortable !== false) || cols[0];
  const dir = urlProdSortDir === 'asc' ? 1 : -1;
  rowsFinal.sort((a,b) => {
    const va = a[col.key], vb = b[col.key];
    if (typeof va === 'string' || typeof vb === 'string') return String(va||'').localeCompare(String(vb||'')) * dir;
    return (((va||0) - (vb||0)) * dir);
  });

  const pageSize = urlProdPageSize === 'all' ? rowsFinal.length : urlProdPageSize;
  const totalPages = Math.max(1, Math.ceil(rowsFinal.length / (pageSize || 1)));
  if (urlProdPage > totalPages) urlProdPage = totalPages;
  if (urlProdPage < 1) urlProdPage = 1;
  const start = (urlProdPage - 1) * (pageSize || rowsFinal.length);
  const pageRows = rowsFinal.slice(start, start + (pageSize || rowsFinal.length));

  const header = `<tr>${cols.map(c => {
    const active = c.key === urlProdSortKey;
    const ind = active ? (urlProdSortDir === 'asc' ? '▲' : '▼') : '';
    return `<th class="${c.sortable ? 'sortable' : ''}" ${c.sortable ? `data-key="${c.key}"` : ''}>${c.label}${c.sortable ? `<span class="sort-ind">${ind}</span>` : ''}</th>`;
  }).join('')}</tr>`;
  const body = pageRows.map(r => {
    const open = urlProdExpandedUrls.has(r.url);
    const main = `<tr class="url-prod-main-row" data-url="${String(r.url).replace(/"/g,'&quot;')}">${cols.map((c, idx) => {
      if (idx === 0) return `<td><span class="toggle">${open ? '▾' : '▸'}</span> ${c.format(r[c.key], r)}</td>`;
      return `<td>${c.format(r[c.key], r)}</td>`;
    }).join('')}</tr>`;
    const detail = open ? `<tr class="url-prod-detail"><td colspan="${cols.length}"><div class="url-prod-detail-wrap">${r._detailHtml || '<span class="muted">无商品信息</span>'}</div></td></tr>` : '';
    return main + detail;
  }).join('');
  table.innerHTML = header + body;
  table.querySelectorAll('.url-prod-main-row').forEach(tr => tr.addEventListener('click', (e) => {
    if (e.target.closest('.url-prod-card') || e.target.closest('img.product-thumb') || e.target.closest('th.sortable')) return;
    const u = tr.getAttribute('data-url') || '';
    if (!u) return;
    if (urlProdExpandedUrls.has(u)) urlProdExpandedUrls.delete(u);
    else urlProdExpandedUrls.add(u);
    renderUrlProductPageBoard();
  }));

  const sizeGroup = pager.querySelector('#urlProdPageSizeGroup');
  const status = `<span class="small">第 ${urlProdPage} / ${totalPages} 页</span>`;
  const buttons = `<button class="pill-btn" data-page="prev" ${urlProdPage===1?'disabled':''}>上一页</button><button class="pill-btn" data-page="next" ${urlProdPage===totalPages?'disabled':''}>下一页</button>`;
  pager.innerHTML = '';
  if (sizeGroup) pager.appendChild(sizeGroup);
  pager.insertAdjacentHTML('beforeend', status + buttons);
}

function renderURLDetail(baseRows) {
  const panel = document.getElementById('urlDetailPanel');
  const table = document.getElementById('urlDetailTable');
  const title = document.getElementById('urlDetailTitle');
  const pager = document.getElementById('urlDetailPager');
  if (!panel || !table || !title) return;
  if (!selectedUrl || !urlDetailOpen) {
    panel.classList.add('hidden');
    table.innerHTML = '';
    if (pager) pager.classList.add('hidden');
    return;
  }
  const detailRowsRaw = baseRows.filter(r => r.url === selectedUrl);
  const byAd = groupBy(detailRowsRaw, r => r.ad || '-');
  let rowsD = Array.from(byAd.entries()).map(([ad, rs]) => {
    const a = aggregate(rs);
    return {ad, ...a};
  });
  const dir = urlDetailSortDir === 'asc' ? 1 : -1;
  rowsD.sort((a,b)=> {
    const va=a[urlDetailSortKey], vb=b[urlDetailSortKey];
    if (typeof va === 'string' || typeof vb === 'string') return String(va||'').localeCompare(String(vb||''))*dir;
    return ((Number(va)||0)-(Number(vb)||0))*dir;
  });
  const cols = [
    {label:'广告', key:'ad'},
    {label:'花费', key:'spend'},
    {label:'转化金额', key:'conv'},
    {label:'ROAS', key:'roas'},
    {label:'广告销量', key:'purchases'},
    {label:'客单价', key:'aov'},
    {label:'CPA', key:'cpa'},
    {label:'CTR', key:'ctr'},
    {label:'CPC', key:'cpc'},
    {label:'CPM', key:'cpm'},
    {label:'转化率', key:'cvr'},
    {label:'加购成本', key:'atcCost'},
    {label:'结帐成本', key:'checkoutCost'},
    {label:'加购率', key:'atcRate'},
    {label:'结帐率', key:'checkoutRate'}
  ];
  const pageSize = urlDetailPageSize === 'all' ? rowsD.length : urlDetailPageSize;
  const totalPages = Math.max(1, Math.ceil(rowsD.length / (pageSize || 1)));
  if (urlDetailPage > totalPages) urlDetailPage = totalPages;
  if (urlDetailPage < 1) urlDetailPage = 1;
  const start = (urlDetailPage - 1) * (pageSize || rowsD.length);
  const pageRows = rowsD.slice(start, start + (pageSize || rowsD.length));
  const header = `<tr>${cols.map(c=>`<th class="sortable" data-key="${c.key}">${c.label}${urlDetailSortKey===c.key?`<span class="sort-ind">${urlDetailSortDir==='asc'?'▲':'▼'}</span>`:''}</th>`).join('')}</tr>`;
  const body = pageRows.map(r=>`<tr><td>${r.ad}</td><td>${money(r.spend)}</td><td>${money(r.conv)}</td><td><span class="${roasLevelClass(r.roas)}">${fmt(r.roas,2)}</span></td><td>${fmt(r.purchases,0)}</td><td>${money(r.aov)}</td><td>${money(r.cpa)}</td><td>${pct(r.ctr)}</td><td>${money(r.cpc)}</td><td>${money(r.cpm)}</td><td>${pct(r.cvr)}</td><td>${money(r.atcCost)}</td><td>${money(r.checkoutCost)}</td><td>${pct(r.atcRate)}</td><td>${pct(r.checkoutRate)}</td></tr>`).join('');
  table.innerHTML = header + body;
  attachTableFirstColResize('urlDetailTable', '--url-detail-first-col', 260, 760, 'url-detail-first-resize');
  title.textContent = `广告明细 ${selectedUrl}`;
  panel.classList.remove('hidden');
  if (pager) {
    const sizeGroup = pager.querySelector('#urlDetailPageSizeGroup');
    const status = `<span class="small">第 ${urlDetailPage} / ${totalPages} 页</span>`;
    const buttons = `<button class="pill-btn" data-page="prev" ${urlDetailPage===1?'disabled':''}>上一页</button><button class="pill-btn" data-page="next" ${urlDetailPage===totalPages?'disabled':''}>下一页</button>`;
    pager.innerHTML = '';
    if (sizeGroup) pager.appendChild(sizeGroup);
    pager.insertAdjacentHTML('beforeend', `<div class="filter-group">${status}${buttons}</div>`);
    pager.classList.remove('hidden');
  }
}

function renderURLProductDetail(baseRows) {
  const panel = document.getElementById('urlProductDetailPanel');
  const table = document.getElementById('urlProductDetailTable');
  const title = document.getElementById('urlProductDetailTitle');
  const pager = document.getElementById('urlProductDetailPager');
  if (!panel || !table || !title) return;
  if (!selectedUrl || !urlProductDetailOpen) {
    panel.classList.add('hidden');
    table.innerHTML = '';
    if (pager) pager.classList.add('hidden');
    return;
  }
  const detailRowsRaw = baseRows.filter(r => r.url === selectedUrl);
  const withSid = detailRowsRaw.filter(r => String(r.shopify_id || '').trim());
  const bySid = groupBy(withSid, r => String(r.shopify_id || '').trim());
  const productByShopify = (() => {
    const m = new Map();
    Object.values(PRODUCT_MAP || {}).forEach(p => {
      const sid = String(p?.shopify_id || '').trim();
      if (sid && !m.has(sid)) m.set(sid, p);
    });
    return m;
  })();
  let rowsP = Array.from(bySid.entries()).map(([sid, rs]) => {
    const a = aggregate(rs);
    const prod = productByShopify.get(sid) || {};
    const adSet = new Set(rs.map(x => String(x.ad || '').trim()).filter(Boolean));
    return {
      shopifyId: sid,
      skc: String(prod.skc || '-'),
      image: String(prod.image || ''),
      adCount: adSet.size,
      spend: a.spend,
      conv: a.conv,
      roas: a.roas,
      purchases: a.purchases,
      aov: a.aov,
      cpa: a.cpa,
      ctr: a.ctr,
      cpc: a.cpc
    };
  });
  const dir = urlProductDetailSortDir === 'asc' ? 1 : -1;
  rowsP.sort((a,b)=> {
    const va=a[urlProductDetailSortKey], vb=b[urlProductDetailSortKey];
    if (typeof va === 'string' || typeof vb === 'string') return String(va||'').localeCompare(String(vb||''))*dir;
    return ((Number(va)||0)-(Number(vb)||0))*dir;
  });
  const cols = [
    {label:'图片', key:'image'},
    {label:'shopify id', key:'shopifyId'},
    {label:'SKC', key:'skc'},
    {label:'广告数', key:'adCount'},
    {label:'花费', key:'spend'},
    {label:'转化金额', key:'conv'},
    {label:'ROAS', key:'roas'},
    {label:'广告销量', key:'purchases'},
    {label:'客单价', key:'aov'},
    {label:'CPA', key:'cpa'},
    {label:'CTR', key:'ctr'},
    {label:'CPC', key:'cpc'}
  ];
  const pageSize = urlProductDetailPageSize === 'all' ? rowsP.length : urlProductDetailPageSize;
  const totalPages = Math.max(1, Math.ceil(rowsP.length / (pageSize || 1)));
  if (urlProductDetailPage > totalPages) urlProductDetailPage = totalPages;
  if (urlProductDetailPage < 1) urlProductDetailPage = 1;
  const start = (urlProductDetailPage - 1) * (pageSize || rowsP.length);
  const pageRows = rowsP.slice(start, start + (pageSize || rowsP.length));
  const header = `<tr>${cols.map(c=>`<th class="${c.key!=='image'?'sortable':''}" ${c.key!=='image'?`data-key="${c.key}"`:''}>${c.label}${(c.key!=='image' && urlProductDetailSortKey===c.key)?`<span class="sort-ind">${urlProductDetailSortDir==='asc'?'▲':'▼'}</span>`:''}</th>`).join('')}</tr>`;
  const body = pageRows.map(r => {
    const img = r.image ? `<img class="product-thumb" src="${r.image}" data-img="${r.image}" />` : '<div class="product-thumb" style="background:#faf7f2;"></div>';
    return `<tr>
      <td>${img}</td>
      <td>${r.shopifyId}</td>
      <td>${r.skc}</td>
      <td>${fmt(r.adCount,0)}</td>
      <td>${money(r.spend)}</td>
      <td>${money(r.conv)}</td>
      <td><span class="${roasLevelClass(r.roas)}">${fmt(r.roas,2)}</span></td>
      <td>${fmt(r.purchases,0)}</td>
      <td>${money(r.aov)}</td>
      <td>${money(r.cpa)}</td>
      <td>${pct(r.ctr)}</td>
      <td>${money(r.cpc)}</td>
    </tr>`;
  }).join('');
  table.innerHTML = header + body;
  title.textContent = `商品明细 ${selectedUrl}`;
  panel.classList.remove('hidden');
  if (pager) {
    const sizeGroup = pager.querySelector('#urlProductDetailPageSizeGroup');
    const status = `<span class="small">第 ${urlProductDetailPage} / ${totalPages} 页</span>`;
    const buttons = `<button class="pill-btn" data-page="prev" ${urlProductDetailPage===1?'disabled':''}>上一页</button><button class="pill-btn" data-page="next" ${urlProductDetailPage===totalPages?'disabled':''}>下一页</button>`;
    pager.innerHTML = '';
    if (sizeGroup) pager.appendChild(sizeGroup);
    pager.insertAdjacentHTML('beforeend', `<div class="filter-group">${status}${buttons}</div>`);
    pager.classList.remove('hidden');
  }
}

function bindURLBoard() {
  const table = document.getElementById('urlTable');
  if (table) {
    table.addEventListener('click', (e) => {
      const th = e.target.closest('th.sortable');
      if (th && th.dataset.key) {
        if (urlSortKey === th.dataset.key) urlSortDir = urlSortDir === 'asc' ? 'desc' : 'asc';
        else { urlSortKey = th.dataset.key; urlSortDir = 'desc'; }
        updateAll(false);
        return;
      }
      const link = e.target.closest('.url-link');
      if (link && link.dataset.url) {
        const nextUrl = link.dataset.url;
        if (selectedUrl === nextUrl && (urlDetailOpen || urlProductDetailOpen)) {
          urlDetailOpen = false;
          urlProductDetailOpen = false;
        } else {
          selectedUrl = nextUrl;
          urlDetailOpen = true;
          urlProductDetailOpen = true;
          urlDetailPage = 1;
          urlDetailSortKey = 'spend';
          urlDetailSortDir = 'desc';
          urlProductDetailPage = 1;
          urlProductDetailSortKey = 'spend';
          urlProductDetailSortDir = 'desc';
        }
        updateAll(false);
      }
    });
  }
  const detail = document.getElementById('urlDetailTable');
  if (detail) {
    detail.addEventListener('click', (e) => {
      const th = e.target.closest('th.sortable');
      if (!th || !th.dataset.key) return;
      if (urlDetailSortKey === th.dataset.key) urlDetailSortDir = urlDetailSortDir === 'asc' ? 'desc' : 'asc';
      else { urlDetailSortKey = th.dataset.key; urlDetailSortDir = 'desc'; }
      urlDetailPage = 1;
      updateAll(false);
    });
  }
  const pager = document.getElementById('urlPager');
  if (pager) {
    pager.addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-page]');
      if (!btn) return;
      const dir = btn.getAttribute('data-page');
      if (dir === 'prev') urlPage -= 1;
      if (dir === 'next') urlPage += 1;
      updateAll(false);
    });
  }
  if (urlPageSizeSelect) {
    urlPageSizeSelect.addEventListener('change', ()=>{
      urlPageSize = urlPageSizeSelect.value === 'all' ? 'all' : (parseInt(urlPageSizeSelect.value, 10) || 15);
      urlPage = 1;
      updateFilterHighlights();
      updateAll(false);
    });
  }
  const detailPager = document.getElementById('urlDetailPager');
  if (detailPager) {
    detailPager.addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-page]');
      if (!btn) return;
      const dir = btn.getAttribute('data-page');
      if (dir === 'prev') urlDetailPage -= 1;
      if (dir === 'next') urlDetailPage += 1;
      updateAll(false);
    });
  }
  if (urlDetailPageSizeSelect) {
    urlDetailPageSizeSelect.addEventListener('change', () => {
      urlDetailPageSize = urlDetailPageSizeSelect.value === 'all' ? 'all' : (parseInt(urlDetailPageSizeSelect.value, 10) || 10);
      urlDetailPage = 1;
      updateAll(false);
    });
  }
  if (urlDetailBackBtn) {
    urlDetailBackBtn.addEventListener('click', () => {
      urlDetailOpen = false;
      urlDetailPage = 1;
      if (!urlProductDetailOpen) selectedUrl = '';
      updateAll(false);
      const topTable = document.getElementById('urlTable');
      if (topTable) topTable.scrollIntoView({ behavior: 'smooth', block: 'start' });
    });
  }
  const productDetailTable = document.getElementById('urlProductDetailTable');
  if (productDetailTable) {
    productDetailTable.addEventListener('click', (e) => {
      const th = e.target.closest('th.sortable');
      if (!th || !th.dataset.key) return;
      if (urlProductDetailSortKey === th.dataset.key) urlProductDetailSortDir = urlProductDetailSortDir === 'asc' ? 'desc' : 'asc';
      else { urlProductDetailSortKey = th.dataset.key; urlProductDetailSortDir = 'desc'; }
      urlProductDetailPage = 1;
      updateAll(false);
    });
  }
  const productDetailPager = document.getElementById('urlProductDetailPager');
  if (productDetailPager) {
    productDetailPager.addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-page]');
      if (!btn) return;
      const dir = btn.getAttribute('data-page');
      if (dir === 'prev') urlProductDetailPage -= 1;
      if (dir === 'next') urlProductDetailPage += 1;
      updateAll(false);
    });
  }
  if (urlProductDetailPageSizeSelect) {
    urlProductDetailPageSizeSelect.addEventListener('change', () => {
      urlProductDetailPageSize = urlProductDetailPageSizeSelect.value === 'all' ? 'all' : (parseInt(urlProductDetailPageSizeSelect.value, 10) || 10);
      urlProductDetailPage = 1;
      updateAll(false);
    });
  }
  if (urlProductDetailBackBtn) {
    urlProductDetailBackBtn.addEventListener('click', () => {
      urlProductDetailOpen = false;
      urlProductDetailPage = 1;
      if (!urlDetailOpen) selectedUrl = '';
      updateAll(false);
      const topTable = document.getElementById('urlTable');
      if (topTable) topTable.scrollIntoView({ behavior: 'smooth', block: 'start' });
    });
  }
  if (urlTagFilter) {
    urlTagFilter.addEventListener('change', ()=>{
      urlTag = urlTagFilter.value || 'all';
      urlPage = 1;
      updateFilterHighlights();
      updateAll(false);
    });
  }
  if (urlCompareSelect) {
    urlCompareSelect.addEventListener('change', ()=>{
      urlCompareMode = urlCompareSelect.value || 'off';
      updateFilterHighlights();
      updateAll(false);
    });
  }
  if (urlSearchInput) {
    urlSearchInput.addEventListener('input', ()=>{
      urlSearch = urlSearchInput.value || '';
      urlPage = 1;
      updateAll(false);
    });
  }
  if (urlSearchClearBtn) {
    urlSearchClearBtn.addEventListener('click', ()=>{
      urlSearch = '';
      if (urlSearchInput) urlSearchInput.value = '';
      urlPage = 1;
      updateAll(false);
    });
  }
  attachTableFirstColResize('urlTable', '--url-main-first-col', 360, 900, 'url-main-first-resize');
  attachTableFirstColResize('urlDetailTable', '--url-detail-first-col', 260, 760, 'url-detail-first-resize');
}

function bindUrlProductPageBoard() {
  const table = document.getElementById('urlProdTable');
  if (table) {
    table.addEventListener('click', (e) => {
      const img = e.target.closest('img.product-thumb');
      if (img && img.dataset.img) {
        e.stopPropagation();
        const modal = document.getElementById('imgModal');
        const modalImg = document.getElementById('imgModalImg');
        if (modal && modalImg) {
          modalImg.src = img.dataset.img;
          modal.classList.add('active');
        }
        return;
      }
      const card = e.target.closest('.url-prod-card');
      if (card) {
        e.stopPropagation();
        card.classList.toggle('is-open');
        return;
      }
      const th = e.target.closest('th.sortable');
      if (!th || !th.dataset.key) return;
      if (urlProdSortKey === th.dataset.key) urlProdSortDir = urlProdSortDir === 'asc' ? 'desc' : 'asc';
      else { urlProdSortKey = th.dataset.key; urlProdSortDir = 'desc'; }
      urlProdPage = 1;
      updateAll(false);
    });
  }
  const pager = document.getElementById('urlProdPager');
  if (pager) {
    pager.addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-page]');
      if (!btn) return;
      const dir = btn.getAttribute('data-page');
      if (dir === 'prev') urlProdPage -= 1;
      if (dir === 'next') urlProdPage += 1;
      updateAll(false);
    });
  }
  if (urlProdPageFilter) {
    urlProdPageFilter.addEventListener('change', () => {
      urlProdPageMode = urlProdPageFilter.value || 'all';
      urlProdPage = 1;
      updateFilterHighlights();
      updateAll(false);
    });
  }
  if (urlProdPageSizeSelect) {
    urlProdPageSizeSelect.addEventListener('change', () => {
      urlProdPageSize = urlProdPageSizeSelect.value === 'all' ? 'all' : (parseInt(urlProdPageSizeSelect.value, 10) || 15);
      urlProdPage = 1;
      updateFilterHighlights();
      updateAll(false);
    });
  }
  if (urlProdSearchInput) {
    urlProdSearchInput.addEventListener('input', () => {
      urlProdSearch = urlProdSearchInput.value || '';
      urlProdPage = 1;
      updateAll(false);
    });
  }
  if (urlProdSearchClearBtn) {
    urlProdSearchClearBtn.addEventListener('click', () => {
      urlProdSearch = '';
      if (urlProdSearchInput) urlProdSearchInput.value = '';
      urlProdPage = 1;
      updateAll(false);
    });
  }
  if (urlProdExpandAllBtn) {
    urlProdExpandAllBtn.addEventListener('click', () => {
      const table = document.getElementById('urlProdTable');
      if (!table) return;
      const urls = Array.from(table.querySelectorAll('.url-prod-main-row')).map(tr => tr.getAttribute('data-url')).filter(Boolean);
      if (!urls.length) return;
      const allOpen = urls.every(u => urlProdExpandedUrls.has(u));
      if (allOpen) {
        urls.forEach(u => urlProdExpandedUrls.delete(u));
      } else {
        urls.forEach(u => urlProdExpandedUrls.add(u));
      }
      renderUrlProductPageBoard();
    });
  }
}

function renderSummary(rowsFiltered) {
  const a = aggregate(rowsFiltered);
  const num = (v) => (isFinite(v) ? v : 0);
  const byDay = {};
  for (const r of rowsFiltered) {
    byDay[r.date] = byDay[r.date] || {spend:0, conv:0};
    byDay[r.date].spend += num(r.spend); byDay[r.date].conv += num(r.conv);
  }
  const dayCount = Object.keys(byDay).length;
  const bestDay = (() => {
    if (dayCount <= 1) return null;
    let best = null;
    for (const day in byDay) {
      const v = byDay[day];
      const roas = v.spend ? v.conv/v.spend : 0;
      if (!best || roas > best.roas) best = {day, roas};
    }
    return best;
  })();

  const summary = document.getElementById('summaryBox');
  const dayBtn = dayButtons.querySelector('.pill-btn.active');
  const highlightRows = (dayBtn && dayBtn.getAttribute('data-day') !== 'ALL')
    ? rowsFiltered
    : rowsFiltered;

  function bestBy(keyFn, label) {
    const m = new Map();
    for (const r of highlightRows) {
      const k = keyFn(r);
      if (!m.has(k)) m.set(k, {spend:0, conv:0});
      const v=m.get(k); v.spend += num(r.spend); v.conv += num(r.conv);
    }
    let best=null;
    for (const [k,v] of m.entries()) {
      const roas = v.spend ? v.conv/v.spend : 0;
      if (!best || roas > best.roas) best = {k, roas};
    }
    return best ? `${label} ${best.k} (ROAS ${fmt(best.roas,2)})` : null;
  }

  const bestCategory = (() => {
    const m = new Map();
    for (const r of rowsFiltered) {
      const k = r.category;
      if (!m.has(k)) m.set(k, {spend:0, conv:0});
      const v=m.get(k); v.spend += num(r.spend); v.conv += num(r.conv);
    }
    let best=null;
    for (const [k,v] of m.entries()) {
      const roas = v.spend ? v.conv/v.spend : 0;
      if (!best || roas > best.roas) best = {k, roas};
    }
    return best;
  })();

  const warnDims = (() => {
    const m = new Map();
    for (const r of rowsFiltered) {
      const k = r.category;
      if (!m.has(k)) m.set(k, {spend:0, conv:0});
      const v=m.get(k); v.spend += num(r.spend); v.conv += num(r.conv);
    }
    const bad = [];
    for (const [k,v] of m.entries()) {
      const roas = v.spend ? v.conv/v.spend : 0;
      if (v.spend > 200 && roas < 1) bad.push(`${k} (ROAS ${fmt(roas,2)})`);
    }
    return bad;
  })();

  const topBy = (keyFn, label) => {
    const m = new Map();
    for (const r of rowsFiltered) {
      const k = keyFn(r);
      if (!m.has(k)) m.set(k, {spend:0, conv:0});
      const v=m.get(k); v.spend += num(r.spend); v.conv += num(r.conv);
    }
    let best=null;
    for (const [k,v] of m.entries()) {
      const roas = v.spend ? v.conv/v.spend : 0;
      if (!best || roas > best.roas) best = {k, roas, spend:v.spend};
    }
    return best ? `${label} ${best.k}（ROAS ${fmt(best.roas,2)}，花费 ${money(best.spend)}）` : null;
  };

  const insights = [
    topBy(r=>r.category, '品类亮点'),
    topBy(r=>r.audience, '人群亮点'),
    topBy(r=>r.material, '素材亮点'),
    topBy(r=>r.adType, '广告亮点')
  ].filter(Boolean).slice(0,3);

  const insightLines = insights.map(t => {
    const m = t.match(/^(.*)（ROAS ([0-9.]+).*$/);
    if (m) return `<div>${m[1]}：ROAS ${m[2]}</div>`;
    return `<div>${t}</div>`;
  });

  summary.innerHTML = `
  ${bestDay ? `<div>最佳单日 ROAS：${bestDay.day} (${fmt(bestDay.roas,2)})。</div>` : '' }
  ${insightLines.join('')}
  <div class="${warnDims.length ? 'warn' : 'ok'}">${warnDims.length ? '警示：' + warnDims.join('，') : '暂无明显警示'}</div>`;
}

function updateAll(resetPage=true) {
  const rowsFiltered = filterRows();
  if (resetPage) {
    dailyPage = 1;
    productPage = 1;
  }
  const range = getDateRangeForCurrentFilter();
  const start = range[0];
  const end = range[1];
  rangeLabel.textContent = `数据范围：${formatDateLocal(start)} 至 ${formatDateLocal(end)}`;
  updateTripleCompareLayout();
  renderKPIs(rowsFiltered);
  renderChart(rowsFiltered);
  renderTables(rowsFiltered);
  renderWeeklyNewAdsBoard();
  renderSummary(rowsFiltered);
  renderProductTable(rowsFiltered);
  renderURLBoard(rowsFiltered);
  renderUrlProductPageBoard();
  if (chartMode.value === 'combo') {
    piePanel.style.display = 'none';
    pieMetricGroup.style.display = 'none';
    comboPanel.style.display = 'block';
    renderCombo(rowsFiltered);
  } else {
    piePanel.style.display = '';
    pieMetricGroup.style.display = '';
    comboPanel.style.display = 'none';
  }
}

timeMode.addEventListener('change', () => {
  if (timeMode.value === 'week') {
    applyDefaultTimeForMode('week');
  } else if (timeMode.value === 'range') {
    applyDefaultTimeForMode('range');
  } else {
    applyDefaultTimeForMode('month');
  }
  updateFilterVisibility();
  updateFilterHighlights();
  updateAll();
});

monthSelect.addEventListener('change', () => {
  updateWeeks();
  if (timeMode.value === 'week') {
    weekSelect.value = weekSelect.options[0]?.value || '';
    if (weekSelect.value) renderDayButtons(weekSelect.value);
  } else {
    weekSelect.value = 'MONTH';
    dayButtons.innerHTML = '';
  }
  updateAll();
});
weekSelect.addEventListener('change', () => {
  if (weekSelect.value) {
    renderDayButtons(weekSelect.value);
  } else {
    dayButtons.innerHTML = '';
  }
  updateFilterHighlights();
  updateAll();
});
if (weekBackBtn) {
  weekBackBtn.addEventListener('click', () => {
    timeMode.value = 'month';
    weekSelect.value = 'MONTH';
    dayButtons.innerHTML = '';
    updateFilterVisibility();
    updateFilterHighlights();
    updateAll();
  });
}

categorySelect.addEventListener('change', () => {
  updateFilterHighlights();
  updateAll();
});
adTypeSelect.addEventListener('change', () => {
  updateFilterHighlights();
  updateAll();
});
materialSelect.addEventListener('change', () => {
  updateFilterHighlights();
  updateAll();
});
if (weeklyNewAdsViewModeSelect) {
  weeklyNewAdsViewModeSelect.addEventListener('change', () => {
    weeklyNewAdsViewModeState = weeklyNewAdsViewModeSelect.value || 'all';
    weeklyNewAdsExpandedGroups.clear();
    renderWeeklyNewAdsBoard();
  });
}
if (weeklyNewAdsGroupModeSelect) {
  weeklyNewAdsGroupModeSelect.addEventListener('change', () => {
    weeklyNewAdsGroupModeState = weeklyNewAdsGroupModeSelect.value || 'none';
    weeklyNewAdsExpandedGroups.clear();
    renderWeeklyNewAdsBoard();
  });
}
categoryMode.addEventListener('change', () => {
  updateFilterHighlights();
  updateAll();
});
pieMetric.addEventListener('change', () => {
  updateFilterHighlights();
  updateAll();
});
chartMode.addEventListener('change', () => {
  updateFilterHighlights();
  updateAll(false);
});
pieSpendBtn.addEventListener('click', () => {
  pieMetric.value = 'spend';
  pieSpendBtn.classList.add('active');
  pieConvBtn.classList.remove('active');
  updateFilterHighlights();
  updateAll(false);
});
pieConvBtn.addEventListener('click', () => {
  pieMetric.value = 'conv';
  pieConvBtn.classList.add('active');
  pieSpendBtn.classList.remove('active');
  updateFilterHighlights();
  updateAll(false);
});
compareCategory.addEventListener('change', () => updateAll(false));
compareAudience.addEventListener('change', () => updateAll(false));
compareMaterial.addEventListener('change', () => updateAll(false));
compareAdType.addEventListener('change', () => updateAll(false));
dailyPageSizeSelect.addEventListener('change', () => {
  dailyPageSize = parseInt(dailyPageSizeSelect.value, 10) || 15;
  dailyPage = 1;
  updateAll(false);
});
startDateInput.addEventListener('change', () => {
  if (startDateInput.value && endDateInput.value) {
    timeMode.value = 'range';
  }
  updateWeeks();
  if (timeMode.value === 'week' && weekSelect.value) renderDayButtons(weekSelect.value);
  updateFilterVisibility();
  updateFilterHighlights();
  updateAll();
});
endDateInput.addEventListener('change', () => {
  if (startDateInput.value && endDateInput.value) {
    timeMode.value = 'range';
  }
  updateWeeks();
  if (timeMode.value === 'week' && weekSelect.value) renderDayButtons(weekSelect.value);
  updateFilterVisibility();
  updateFilterHighlights();
  updateAll();
});
if (clearRangeBtn) {
  clearRangeBtn.addEventListener('click', () => {
    applyDefaultTimeForMode('range');
    updateFilterVisibility();
    updateFilterHighlights();
    updateAll();
  });
}

 dayButtons.addEventListener('click', (e) => {
  if (!e.target.classList.contains('pill-btn')) return;
  dayButtons.querySelectorAll('.pill-btn').forEach(b=>b.classList.remove('active'));
  e.target.classList.add('active');
  updateAll();
});

applyDefaultTimeForMode('month');
updateFilterVisibility();
initFilterDefaults();
bindDailyPager();
bindSortableTables();
bindProductTable();
bindURLBoard();
bindUrlProductPageBoard();
if (viewPerfBtn) viewPerfBtn.addEventListener('click', () => setDashboardView('perf'));
if (viewOpsBtn) viewOpsBtn.addEventListener('click', () => setDashboardView('ops'));
if (viewDecisionBtn) viewDecisionBtn.addEventListener('click', () => setDashboardView('decision'));
if (resetDashboardBtn) resetDashboardBtn.addEventListener('click', resetDashboard);
setDashboardView('perf');
updateAll();

// Global listener to catch any filter change
document.addEventListener('change', (e) => {
  if (e.target && (e.target.matches('select') || e.target.matches('input[type="date"]'))) {
    updateFilterHighlights();
  }
});
</script>
</body>
</html>
